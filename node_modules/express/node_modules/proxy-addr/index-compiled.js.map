{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["/*!\n * proxy-addr\n * Copyright(c) 2014 Douglas Christopher Wilson\n * MIT Licensed\n */\n\n'use strict'\n\n/**\n * Module exports.\n */\n\nmodule.exports = proxyaddr;\nmodule.exports.all = alladdrs;\nmodule.exports.compile = compile;\n\n/**\n * Module dependencies.\n */\n\nvar forwarded = require('forwarded');\nvar ipaddr = require('ipaddr.js');\n\n/**\n * Variables.\n */\n\nvar digitre = /^[0-9]+$/;\nvar isip = ipaddr.isValid;\nvar parseip = ipaddr.parse;\n\n/**\n * Pre-defined IP ranges.\n */\n\nvar ipranges = {\n  linklocal: ['169.254.0.0/16', 'fe80::/10'],\n  loopback: ['127.0.0.1/8', '::1/128'],\n  uniquelocal: ['10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', 'fc00::/7']\n};\n\n/**\n * Get all addresses in the request, optionally stopping\n * at the first untrusted.\n *\n * @param {Object} request\n * @param {Function|Array|String} [trust]\n * @api public\n */\n\nfunction alladdrs(req, trust) {\n  // get addresses\n  var addrs = forwarded(req);\n\n  if (!trust) {\n    // Return all addresses\n    return addrs;\n  }\n\n  if (typeof trust !== 'function') {\n    trust = compile(trust);\n  }\n\n  for (var i = 0; i < addrs.length - 1; i++) {\n    if (trust(addrs[i], i)) continue;\n\n    addrs.length = i + 1;\n  }\n\n  return addrs;\n}\n\n/**\n * Compile argument into trust function.\n *\n * @param {Array|String} val\n * @api private\n */\n\nfunction compile(val) {\n  if (!val) {\n    throw new TypeError('argument is required');\n  }\n\n  var trust = typeof val === 'string'\n    ? [val]\n    : val;\n\n  if (!Array.isArray(trust)) {\n    throw new TypeError('unsupported trust argument');\n  }\n\n  for (var i = 0; i < trust.length; i++) {\n    val = trust[i];\n\n    if (!ipranges.hasOwnProperty(val)) {\n      continue;\n    }\n\n    // Splice in pre-defined range\n    val = ipranges[val];\n    trust.splice.apply(trust, [i, 1].concat(val));\n    i += val.length - 1;\n  }\n\n  return compileTrust(compileRangeSubnets(trust));\n}\n\n/**\n * Compile `arr` elements into range subnets.\n *\n * @param {Array} arr\n * @api private\n */\n\nfunction compileRangeSubnets(arr) {\n  var rangeSubnets = new Array(arr.length);\n\n  for (var i = 0; i < arr.length; i++) {\n    rangeSubnets[i] = parseipNotation(arr[i]);\n  }\n\n  return rangeSubnets;\n}\n\n/**\n * Compile range subnet array into trust function.\n *\n * @param {Array} rangeSubnets\n * @api private\n */\n\nfunction compileTrust(rangeSubnets) {\n  // Return optimized function based on length\n  var len = rangeSubnets.length;\n  return len === 0\n    ? trustNone\n    : len === 1\n    ? trustSingle(rangeSubnets[0])\n    : trustMulti(rangeSubnets);\n}\n\n/**\n * Parse IP notation string into range subnet.\n *\n * @param {String} note\n * @api private\n */\n\nfunction parseipNotation(note) {\n  var ip;\n  var kind;\n  var max;\n  var pos = note.lastIndexOf('/');\n  var range;\n\n  ip = pos !== -1\n    ? note.substring(0, pos)\n    : note;\n\n  if (!isip(ip)) {\n    throw new TypeError('invalid IP address: ' + ip);\n  }\n\n  ip = parseip(ip);\n\n  kind = ip.kind();\n  max = kind === 'ipv6'\n    ? 128\n    : 32;\n\n  range = pos !== -1\n    ? note.substring(pos + 1, note.length)\n    : max;\n\n  if (typeof range !== 'number') {\n    range = digitre.test(range)\n      ? parseInt(range, 10)\n      : isip(range)\n      ? parseNetmask(range)\n      : 0;\n  }\n\n  if (ip.kind() === 'ipv6' && ip.isIPv4MappedAddress()) {\n    // Store as IPv4\n    ip = ip.toIPv4Address();\n    range = range <= max\n      ? range - 96\n      : range;\n  }\n\n  if (range <= 0 || range > max) {\n    throw new TypeError('invalid range on address: ' + note);\n  }\n\n  return [ip, range];\n}\n\n/**\n * Parse netmask string into CIDR range.\n *\n * @param {String} note\n * @api private\n */\n\nfunction parseNetmask(netmask) {\n  var ip = parseip(netmask);\n  var parts;\n  var size;\n\n  switch (ip.kind()) {\n    case 'ipv4':\n      parts = ip.octets;\n      size = 8;\n      break;\n    case 'ipv6':\n      parts = ip.parts;\n      size = 16;\n      break;\n  }\n\n  var max = Math.pow(2, size) - 1;\n  var part;\n  var range = 0;\n\n  for (var i = 0; i < parts.length; i++) {\n    part = parts[i] & max;\n\n    if (part === max) {\n      range += size;\n      continue;\n    }\n\n    while (part) {\n      part = (part << 1) & max;\n      range += 1;\n    }\n\n    break;\n  }\n\n  return range;\n}\n\n/**\n * Determine address of proxied request.\n *\n * @param {Object} request\n * @param {Function|Array|String} trust\n * @api public\n */\n\nfunction proxyaddr(req, trust) {\n  if (!req) {\n    throw new TypeError('req argument is required');\n  }\n\n  if (!trust) {\n    throw new TypeError('trust argument is required');\n  }\n\n  var addrs = alladdrs(req, trust);\n  var addr = addrs[addrs.length - 1];\n\n  return addr;\n}\n\n/**\n * Static trust function to trust nothing.\n *\n * @api private\n */\n\nfunction trustNone() {\n  return false;\n}\n\n/**\n * Compile trust function for multiple subnets.\n *\n * @param {Array} subnets\n * @api private\n */\n\nfunction trustMulti(subnets) {\n  return function trust(addr) {\n    if (!isip(addr)) return false;\n\n    var ip = parseip(addr);\n    var ipv4;\n    var kind = ip.kind();\n    var subnet;\n    var subnetip;\n    var subnetkind;\n    var subnetrange;\n    var trusted;\n\n    for (var i = 0; i < subnets.length; i++) {\n      subnet = subnets[i];\n      subnetip = subnet[0];\n      subnetkind = subnetip.kind();\n      subnetrange = subnet[1];\n      trusted = ip;\n\n      if (kind !== subnetkind) {\n        if (kind !== 'ipv6' || subnetkind !== 'ipv4' || !ip.isIPv4MappedAddress()) {\n          continue;\n        }\n\n        // Store addr as IPv4\n        ipv4 = ipv4 || ip.toIPv4Address();\n        trusted = ipv4;\n      }\n\n      if (trusted.match(subnetip, subnetrange)) return true;\n    }\n\n    return false;\n  };\n}\n\n/**\n * Compile trust function for single subnet.\n *\n * @param {Object} subnet\n * @api private\n */\n\nfunction trustSingle(subnet) {\n  var subnetip = subnet[0];\n  var subnetkind = subnetip.kind();\n  var subnetisipv4 = subnetkind === 'ipv4';\n  var subnetrange = subnet[1];\n\n  return function trust(addr) {\n    if (!isip(addr)) return false;\n\n    var ip = parseip(addr);\n    var kind = ip.kind();\n\n    return kind === subnetkind\n      ? ip.match(subnetip, subnetrange)\n      : subnetisipv4 && kind === 'ipv6' && ip.isIPv4MappedAddress()\n      ? ip.toIPv4Address().match(subnetip, subnetrange)\n      : false;\n  };\n}\n"]}