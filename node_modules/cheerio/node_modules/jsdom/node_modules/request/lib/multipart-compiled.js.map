{"version":3,"sources":["multipart.js"],"names":[],"mappings":"AAAA;;AAEA,IAAI,OAAO,QAAQ,WAAR,CAAP;IACA,iBAAiB,QAAQ,iBAAR,CAAjB;IACA,WAAW,QAAQ,UAAR,CAAX;;AAGJ,SAAS,SAAT,CAAoB,OAApB,EAA6B;AAC3B,OAAK,OAAL,GAAe,OAAf,CAD2B;AAE3B,OAAK,QAAL,GAAgB,MAAhB,CAF2B;AAG3B,OAAK,OAAL,GAAe,KAAf,CAH2B;AAI3B,OAAK,IAAL,GAAY,IAAZ,CAJ2B;CAA7B;;AAOA,UAAU,SAAV,CAAoB,SAApB,GAAgC,UAAU,OAAV,EAAmB;AACjD,MAAI,OAAO,IAAP;MACA,UAAU,KAAV;MACA,QAAQ,QAAQ,IAAR,IAAgB,OAAhB,CAHqC;;AAKjD,MAAI,CAAC,MAAM,OAAN,EAAe;AAClB,SAAK,OAAL,CAAa,IAAb,CAAkB,OAAlB,EAA2B,IAAI,KAAJ,CAAU,oCAAV,CAA3B,EADkB;GAApB;;AAIA,MAAI,QAAQ,OAAR,KAAoB,SAApB,EAA+B;AACjC,cAAU,QAAQ,OAAR,CADuB;GAAnC;;AAIA,MAAI,KAAK,OAAL,CAAa,SAAb,CAAuB,mBAAvB,MAAgD,SAAhD,EAA2D;AAC7D,cAAU,IAAV,CAD6D;GAA/D;;AAIA,MAAI,CAAC,OAAD,EAAU;AACZ,UAAM,OAAN,CAAc,UAAU,IAAV,EAAgB;AAC5B,UAAI,OAAO,KAAK,IAAL,KAAc,WAArB,EAAkC;AACpC,aAAK,OAAL,CAAa,IAAb,CAAkB,OAAlB,EAA2B,IAAI,KAAJ,CAAU,sCAAV,CAA3B,EADoC;OAAtC;AAGA,UAAI,SAAS,KAAK,IAAL,CAAb,EAAyB;AACvB,kBAAU,IAAV,CADuB;OAAzB;KAJY,CAAd,CADY;GAAd;;AAWA,SAAO,OAAP,CA5BiD;CAAnB;;AA+BhC,UAAU,SAAV,CAAoB,UAApB,GAAiC,UAAU,OAAV,EAAmB;AAClD,MAAI,OAAO,IAAP,CAD8C;;AAGlD,MAAI,WAAW,CAAC,KAAK,OAAL,CAAa,SAAb,CAAuB,mBAAvB,CAAD,EAA8C;AAC3D,SAAK,OAAL,CAAa,SAAb,CAAuB,mBAAvB,EAA4C,SAA5C,EAD2D;GAA7D;;AAIA,MAAI,SAAS,KAAK,OAAL,CAAa,SAAb,CAAuB,cAAvB,CAAT,CAP8C;;AASlD,MAAI,CAAC,MAAD,IAAW,OAAO,OAAP,CAAe,WAAf,MAAgC,CAAC,CAAD,EAAI;AACjD,SAAK,OAAL,CAAa,SAAb,CAAuB,cAAvB,EAAuC,iCAAiC,KAAK,QAAL,CAAxE,CADiD;GAAnD,MAEO;AACL,QAAI,OAAO,OAAP,CAAe,UAAf,MAA+B,CAAC,CAAD,EAAI;AACrC,WAAK,QAAL,GAAgB,OAAO,OAAP,CAAe,wBAAf,EAAyC,IAAzC,CAAhB,CADqC;KAAvC,MAEO;AACL,WAAK,OAAL,CAAa,SAAb,CAAuB,cAAvB,EAAuC,SAAS,aAAT,GAAyB,KAAK,QAAL,CAAhE,CADK;KAFP;GAHF;CAT+B;;AAoBjC,UAAU,SAAV,CAAoB,KAApB,GAA4B,UAAU,KAAV,EAAiB,OAAjB,EAA0B;AACpD,MAAI,OAAO,IAAP,CADgD;AAEpD,MAAI,OAAO,UAAU,IAAI,cAAJ,EAAV,GAAiC,EAAjC,CAFyC;;AAIpD,WAAS,GAAT,CAAc,IAAd,EAAoB;AAClB,QAAI,OAAO,IAAP,KAAgB,QAAhB,EAA0B;AAC5B,aAAO,KAAK,QAAL,EAAP,CAD4B;KAA9B;AAGA,WAAO,UAAU,KAAK,MAAL,CAAY,IAAZ,CAAV,GAA8B,KAAK,IAAL,CAAU,IAAI,MAAJ,CAAW,IAAX,CAAV,CAA9B,CAJW;GAApB;;AAOA,MAAI,KAAK,OAAL,CAAa,YAAb,EAA2B;AAC7B,QAAI,MAAJ,EAD6B;GAA/B;;AAIA,QAAM,OAAN,CAAc,UAAU,IAAV,EAAgB;AAC5B,QAAI,WAAW,OAAO,KAAK,QAAL,GAAgB,MAAvB,CADa;AAE5B,WAAO,IAAP,CAAY,IAAZ,EAAkB,OAAlB,CAA0B,UAAU,GAAV,EAAe;AACvC,UAAI,QAAQ,MAAR,EAAgB;AAAE,eAAF;OAApB;AACA,kBAAY,MAAM,IAAN,GAAa,KAAK,GAAL,CAAb,GAAyB,MAAzB,CAF2B;KAAf,CAA1B,CAF4B;AAM5B,gBAAY,MAAZ,CAN4B;AAO5B,QAAI,QAAJ,EAP4B;AAQ5B,QAAI,KAAK,IAAL,CAAJ,CAR4B;AAS5B,QAAI,MAAJ,EAT4B;GAAhB,CAAd,CAfoD;AA0BpD,MAAI,OAAO,KAAK,QAAL,GAAgB,IAAvB,CAAJ,CA1BoD;;AA4BpD,MAAI,KAAK,OAAL,CAAa,aAAb,EAA4B;AAC9B,QAAI,MAAJ,EAD8B;GAAhC;;AAIA,SAAO,IAAP,CAhCoD;CAA1B;;AAmC5B,UAAU,SAAV,CAAoB,SAApB,GAAgC,UAAU,OAAV,EAAmB;AACjD,MAAI,OAAO,IAAP,CAD6C;;AAGjD,MAAI,UAAU,KAAK,SAAL,CAAe,OAAf,CAAV;MACA,QAAQ,QAAQ,IAAR,IAAgB,OAAhB,CAJqC;;AAMjD,OAAK,UAAL,CAAgB,OAAhB,EANiD;AAOjD,OAAK,OAAL,GAAe,OAAf,CAPiD;AAQjD,OAAK,IAAL,GAAY,KAAK,KAAL,CAAW,KAAX,EAAkB,OAAlB,CAAZ,CARiD;CAAnB;;AAWhC,QAAQ,SAAR,GAAoB,SAApB","file":"multipart-compiled.js","sourcesContent":["'use strict'\n\nvar uuid = require('node-uuid')\n  , CombinedStream = require('combined-stream')\n  , isstream = require('isstream')\n\n\nfunction Multipart (request) {\n  this.request = request\n  this.boundary = uuid()\n  this.chunked = false\n  this.body = null\n}\n\nMultipart.prototype.isChunked = function (options) {\n  var self = this\n    , chunked = false\n    , parts = options.data || options\n\n  if (!parts.forEach) {\n    self.request.emit('error', new Error('Argument error, options.multipart.'))\n  }\n\n  if (options.chunked !== undefined) {\n    chunked = options.chunked\n  }\n\n  if (self.request.getHeader('transfer-encoding') === 'chunked') {\n    chunked = true\n  }\n\n  if (!chunked) {\n    parts.forEach(function (part) {\n      if (typeof part.body === 'undefined') {\n        self.request.emit('error', new Error('Body attribute missing in multipart.'))\n      }\n      if (isstream(part.body)) {\n        chunked = true\n      }\n    })\n  }\n\n  return chunked\n}\n\nMultipart.prototype.setHeaders = function (chunked) {\n  var self = this\n\n  if (chunked && !self.request.hasHeader('transfer-encoding')) {\n    self.request.setHeader('transfer-encoding', 'chunked')\n  }\n\n  var header = self.request.getHeader('content-type')\n\n  if (!header || header.indexOf('multipart') === -1) {\n    self.request.setHeader('content-type', 'multipart/related; boundary=' + self.boundary)\n  } else {\n    if (header.indexOf('boundary') !== -1) {\n      self.boundary = header.replace(/.*boundary=([^\\s;]+).*/, '$1')\n    } else {\n      self.request.setHeader('content-type', header + '; boundary=' + self.boundary)\n    }\n  }\n}\n\nMultipart.prototype.build = function (parts, chunked) {\n  var self = this\n  var body = chunked ? new CombinedStream() : []\n\n  function add (part) {\n    if (typeof part === 'number') {\n      part = part.toString()\n    }\n    return chunked ? body.append(part) : body.push(new Buffer(part))\n  }\n\n  if (self.request.preambleCRLF) {\n    add('\\r\\n')\n  }\n\n  parts.forEach(function (part) {\n    var preamble = '--' + self.boundary + '\\r\\n'\n    Object.keys(part).forEach(function (key) {\n      if (key === 'body') { return }\n      preamble += key + ': ' + part[key] + '\\r\\n'\n    })\n    preamble += '\\r\\n'\n    add(preamble)\n    add(part.body)\n    add('\\r\\n')\n  })\n  add('--' + self.boundary + '--')\n\n  if (self.request.postambleCRLF) {\n    add('\\r\\n')\n  }\n\n  return body\n}\n\nMultipart.prototype.onRequest = function (options) {\n  var self = this\n\n  var chunked = self.isChunked(options)\n    , parts = options.data || options\n\n  self.setHeaders(chunked)\n  self.chunked = chunked\n  self.body = self.build(parts, chunked)\n}\n\nexports.Multipart = Multipart\n"]}