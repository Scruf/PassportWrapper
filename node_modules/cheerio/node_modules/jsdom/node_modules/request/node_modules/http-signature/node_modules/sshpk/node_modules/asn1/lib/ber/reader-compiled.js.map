{"version":3,"sources":["reader.js"],"names":[],"mappings":"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","file":"reader-compiled.js","sourcesContent":["// Copyright 2011 Mark Cavage <mcavage@gmail.com> All rights reserved.\n\nvar assert = require('assert');\n\nvar ASN1 = require('./types');\nvar errors = require('./errors');\n\n\n///--- Globals\n\nvar newInvalidAsn1Error = errors.newInvalidAsn1Error;\n\n\n\n///--- API\n\nfunction Reader(data) {\n  if (!data || !Buffer.isBuffer(data))\n    throw new TypeError('data must be a node Buffer');\n\n  this._buf = data;\n  this._size = data.length;\n\n  // These hold the \"current\" state\n  this._len = 0;\n  this._offset = 0;\n}\n\nObject.defineProperty(Reader.prototype, 'length', {\n  enumerable: true,\n  get: function () { return (this._len); }\n});\n\nObject.defineProperty(Reader.prototype, 'offset', {\n  enumerable: true,\n  get: function () { return (this._offset); }\n});\n\nObject.defineProperty(Reader.prototype, 'remain', {\n  get: function () { return (this._size - this._offset); }\n});\n\nObject.defineProperty(Reader.prototype, 'buffer', {\n  get: function () { return (this._buf.slice(this._offset)); }\n});\n\n\n/**\n * Reads a single byte and advances offset; you can pass in `true` to make this\n * a \"peek\" operation (i.e., get the byte, but don't advance the offset).\n *\n * @param {Boolean} peek true means don't move offset.\n * @return {Number} the next byte, null if not enough data.\n */\nReader.prototype.readByte = function(peek) {\n  if (this._size - this._offset < 1)\n    return null;\n\n  var b = this._buf[this._offset] & 0xff;\n\n  if (!peek)\n    this._offset += 1;\n\n  return b;\n};\n\n\nReader.prototype.peek = function() {\n  return this.readByte(true);\n};\n\n\n/**\n * Reads a (potentially) variable length off the BER buffer.  This call is\n * not really meant to be called directly, as callers have to manipulate\n * the internal buffer afterwards.\n *\n * As a result of this call, you can call `Reader.length`, until the\n * next thing called that does a readLength.\n *\n * @return {Number} the amount of offset to advance the buffer.\n * @throws {InvalidAsn1Error} on bad ASN.1\n */\nReader.prototype.readLength = function(offset) {\n  if (offset === undefined)\n    offset = this._offset;\n\n  if (offset >= this._size)\n    return null;\n\n  var lenB = this._buf[offset++] & 0xff;\n  if (lenB === null)\n    return null;\n\n  if ((lenB & 0x80) == 0x80) {\n    lenB &= 0x7f;\n\n    if (lenB == 0)\n      throw newInvalidAsn1Error('Indefinite length not supported');\n\n    if (lenB > 4)\n      throw newInvalidAsn1Error('encoding too long');\n\n    if (this._size - offset < lenB)\n      return null;\n\n    this._len = 0;\n    for (var i = 0; i < lenB; i++)\n      this._len = (this._len << 8) + (this._buf[offset++] & 0xff);\n\n  } else {\n    // Wasn't a variable length\n    this._len = lenB;\n  }\n\n  return offset;\n};\n\n\n/**\n * Parses the next sequence in this BER buffer.\n *\n * To get the length of the sequence, call `Reader.length`.\n *\n * @return {Number} the sequence's tag.\n */\nReader.prototype.readSequence = function(tag) {\n  var seq = this.peek();\n  if (seq === null)\n    return null;\n  if (tag !== undefined && tag !== seq)\n    throw newInvalidAsn1Error('Expected 0x' + tag.toString(16) +\n                              ': got 0x' + seq.toString(16));\n\n  var o = this.readLength(this._offset + 1); // stored in `length`\n  if (o === null)\n    return null;\n\n  this._offset = o;\n  return seq;\n};\n\n\nReader.prototype.readInt = function() {\n  return this._readTag(ASN1.Integer);\n};\n\n\nReader.prototype.readBoolean = function() {\n  return (this._readTag(ASN1.Boolean) === 0 ? false : true);\n};\n\n\nReader.prototype.readEnumeration = function() {\n  return this._readTag(ASN1.Enumeration);\n};\n\n\nReader.prototype.readString = function(tag, retbuf) {\n  if (!tag)\n    tag = ASN1.OctetString;\n\n  var b = this.peek();\n  if (b === null)\n    return null;\n\n  if (b !== tag)\n    throw newInvalidAsn1Error('Expected 0x' + tag.toString(16) +\n                              ': got 0x' + b.toString(16));\n\n  var o = this.readLength(this._offset + 1); // stored in `length`\n\n  if (o === null)\n    return null;\n\n  if (this.length > this._size - o)\n    return null;\n\n  this._offset = o;\n\n  if (this.length === 0)\n    return retbuf ? new Buffer(0) : '';\n\n  var str = this._buf.slice(this._offset, this._offset + this.length);\n  this._offset += this.length;\n\n  return retbuf ? str : str.toString('utf8');\n};\n\nReader.prototype.readOID = function(tag) {\n  if (!tag)\n    tag = ASN1.OID;\n\n  var b = this.readString(tag, true);\n  if (b === null)\n    return null;\n\n  var values = [];\n  var value = 0;\n\n  for (var i = 0; i < b.length; i++) {\n    var byte = b[i] & 0xff;\n\n    value <<= 7;\n    value += byte & 0x7f;\n    if ((byte & 0x80) == 0) {\n      values.push(value);\n      value = 0;\n    }\n  }\n\n  value = values.shift();\n  values.unshift(value % 40);\n  values.unshift((value / 40) >> 0);\n\n  return values.join('.');\n};\n\n\nReader.prototype._readTag = function(tag) {\n  assert.ok(tag !== undefined);\n\n  var b = this.peek();\n\n  if (b === null)\n    return null;\n\n  if (b !== tag)\n    throw newInvalidAsn1Error('Expected 0x' + tag.toString(16) +\n                              ': got 0x' + b.toString(16));\n\n  var o = this.readLength(this._offset + 1); // stored in `length`\n  if (o === null)\n    return null;\n\n  if (this.length > 4)\n    throw newInvalidAsn1Error('Integer too long: ' + this.length);\n\n  if (this.length > this._size - o)\n    return null;\n  this._offset = o;\n\n  var fb = this._buf[this._offset];\n  var value = 0;\n\n  for (var i = 0; i < this.length; i++) {\n    value <<= 8;\n    value |= (this._buf[this._offset++] & 0xff);\n  }\n\n  if ((fb & 0x80) == 0x80 && i !== 4)\n    value -= (1 << (i * 8));\n\n  return value >> 0;\n};\n\n\n\n///--- Exported API\n\nmodule.exports = Reader;\n"]}