{"version":3,"sources":["utils.js"],"names":[],"mappings":";;AAEA,OAAO,OAAP,GAAiB;AAChB,cAAa,WAAb;AACA,gBAAe,aAAf;AACA,qBAAoB,kBAApB;AACA,cAAa,WAAb;AACA,cAAa,WAAb;AACA,aAAY,UAAZ;AACA,mBAAkB,gBAAlB;AACA,eAAc,YAAd;CARD;;AAWA,IAAI,SAAS,QAAQ,aAAR,CAAT;AACJ,IAAI,aAAa,QAAQ,eAAR,CAAb;;AAEJ,IAAI,kBAAkB,CAAlB;;AAEJ,SAAS,YAAT,CAAsB,GAAtB,EAA2B,KAA3B,EAAkC,OAAlC,EAA2C;AAC1C,KAAI,QAAQ,IAAR,IAAgB,OAAQ,GAAR,KAAiB,QAAjB,EACnB,OAAQ,KAAR,CADD;AAEA,KAAI,YAAY,SAAZ,EACH,UAAU,MAAM,SAAN,CAAgB,gBAAhB,CADX;AAEA,KAAI,eAAe,KAAf,IACA,MAAM,SAAN,CAAgB,gBAAhB,CAAiC,CAAjC,KAAuC,QAAQ,CAAR,CAAvC,EACH,OAAQ,IAAR,CAFD;AAGA,KAAI,QAAQ,OAAO,cAAP,CAAsB,GAAtB,CAAR,CARsC;AAS1C,KAAI,QAAQ,CAAR,CATsC;AAU1C,QAAO,MAAM,WAAN,CAAkB,IAAlB,KAA2B,MAAM,IAAN,EAAY;AAC7C,UAAQ,OAAO,cAAP,CAAsB,KAAtB,CAAR,CAD6C;AAE7C,MAAI,CAAC,KAAD,IAAU,EAAE,KAAF,GAAU,eAAV,EACb,OAAQ,KAAR,CADD;EAFD;AAKA,KAAI,MAAM,WAAN,CAAkB,IAAlB,KAA2B,MAAM,IAAN,EAC9B,OAAQ,KAAR,CADD;AAEA,KAAI,MAAM,MAAM,gBAAN,CAjBgC;AAkB1C,KAAI,QAAQ,SAAR,EACH,MAAM,MAAM,iBAAN,CAAwB,GAAxB,CAAN,CADD;AAEA,KAAI,IAAI,CAAJ,KAAU,QAAQ,CAAR,CAAV,IAAwB,IAAI,CAAJ,IAAS,QAAQ,CAAR,CAAT,EAC3B,OAAQ,KAAR,CADD;AAEA,QAAQ,IAAR,CAtB0C;CAA3C;;AAyBA,SAAS,gBAAT,CAA0B,GAA1B,EAA+B,KAA/B,EAAsC,OAAtC,EAA+C,IAA/C,EAAqD;AACpD,KAAI,SAAS,SAAT,EACH,OAAO,QAAP,CADD;AAEA,QAAO,EAAP,CAAU,GAAV,EAAe,OAAO,mBAAP,CAAf,CAHoD;AAIpD,QAAO,MAAP,CAAc,GAAd,EAAmB,OAAO,oBAAP,CAAnB,CAJoD;AAKpD,KAAI,YAAY,SAAZ,EACH,UAAU,MAAM,SAAN,CAAgB,gBAAhB,CADX;AAEA,KAAI,eAAe,KAAf,IACA,MAAM,SAAN,CAAgB,gBAAhB,CAAiC,CAAjC,KAAuC,QAAQ,CAAR,CAAvC,EACH,OAFD;AAGA,KAAI,QAAQ,OAAO,cAAP,CAAsB,GAAtB,CAAR,CAVgD;AAWpD,KAAI,QAAQ,CAAR,CAXgD;AAYpD,QAAO,MAAM,WAAN,CAAkB,IAAlB,KAA2B,MAAM,IAAN,EAAY;AAC7C,UAAQ,OAAO,cAAP,CAAsB,KAAtB,CAAR,CAD6C;AAE7C,SAAO,EAAP,CAAU,SAAS,EAAE,KAAF,IAAW,eAAX,EACf,OAAO,aAAP,GAAuB,MAAM,IAAN,GAAa,WAApC,CADJ,CAF6C;EAA9C;AAKA,QAAO,WAAP,CAAmB,MAAM,WAAN,CAAkB,IAAlB,EAAwB,MAAM,IAAN,EACvC,OAAO,aAAP,GAAuB,MAAM,IAAN,GAAa,WAApC,CADJ,CAjBoD;AAmBpD,KAAI,MAAM,MAAM,gBAAN,CAnB0C;AAoBpD,KAAI,QAAQ,SAAR,EACH,MAAM,MAAM,iBAAN,CAAwB,GAAxB,CAAN,CADD;AAEA,QAAO,EAAP,CAAU,IAAI,CAAJ,KAAU,QAAQ,CAAR,CAAV,IAAwB,IAAI,CAAJ,KAAU,QAAQ,CAAR,CAAV,EAC9B,OAAO,2BAAP,GAAqC,MAAM,IAAN,GAAa,SAAlD,GACA,UADA,GACa,QAAQ,CAAR,CADb,GAC0B,GAD1B,GACgC,QAAQ,CAAR,CADhC,CADJ,CAtBoD;CAArD;;;AA4BA,SAAS,UAAT,CAAoB,GAApB,EAAyB;AACxB,KAAI,IAAI,CAAJ;KAAO,OAAO,CAAP,CADa;AAExB,QAAO,IAAI,IAAI,MAAJ,EAAY;AACtB,MAAI,OAAQ,KAAK,IAAL,CADU;AAEtB,MAAI,CAAC,IAAI,CAAJ,IAAS,IAAT,CAAD,KAAoB,IAApB,EACH,MADD;AAEA,SAJsB;AAKtB,MAAI,OAAO,CAAP,EAAU;AACb,OADa;AAEb,UAAO,CAAP,CAFa;GAAd;EALD;AAUA,QAAQ,IAAE,CAAF,IAAO,IAAI,IAAJ,CAAP,GAAmB,CAAnB,CAZgB;CAAzB;;AAeA,SAAS,WAAT,CAAqB,GAArB,EAA0B,GAA1B,EAA+B;AAC9B,QAAO,MAAP,CAAc,GAAd,EAD8B;AAE9B,QAAO,MAAP,CAAc,GAAd,EAF8B;;AAI9B,KAAI,QAAQ,EAAR,CAJ0B;AAK9B,KAAI,WAAW,CAAX,CAL0B;AAM9B,KAAI,UAAU,CAAV,CAN0B;AAO9B,MAAK,IAAI,IAAI,CAAJ,EAAO,IAAI,IAAI,MAAJ,EAAY,EAAE,CAAF,EAAK;AACpC,MAAI,IAAI,CAAJ,MAAW,IAAI,UAAJ,CAAe,OAAf,CAAX,EACH,EAAE,OAAF,CADD,KAEK,IAAI,IAAI,CAAJ,MAAW,IAAI,UAAJ,CAAe,CAAf,CAAX,EACR,UAAU,CAAV,CADI,KAGJ,UAAU,CAAV,CAHI;;AAKL,MAAI,WAAW,IAAI,MAAJ,EAAY;AAC1B,OAAI,UAAU,IAAI,CAAJ,CADY;AAE1B,SAAM,IAAN,CAAW,IAAI,KAAJ,CAAU,QAAV,EAAoB,UAAU,OAAV,CAA/B,EAF0B;AAG1B,cAAW,OAAX,CAH0B;AAI1B,aAAU,CAAV,CAJ0B;GAA3B;EARD;AAeA,KAAI,YAAY,IAAI,MAAJ,EACf,MAAM,IAAN,CAAW,IAAI,KAAJ,CAAU,QAAV,EAAoB,IAAI,MAAJ,CAA/B,EADD;;AAGA,QAAQ,KAAR,CAzB8B;CAA/B;;AA4BA,SAAS,WAAT,CAAqB,GAArB,EAA0B,OAA1B,EAAmC;AAClC,QAAO,MAAP,CAAc,GAAd,EADkC;AAElC,KAAI,IAAI,CAAJ,MAAW,IAAX,IAAmB,IAAI,CAAJ,MAAW,IAAX,EAAiB;AACvC,MAAI,OAAJ,EACC,OAAQ,GAAR,CADD;AAEA,SAAQ,IAAI,KAAJ,CAAU,CAAV,CAAR,CAHuC;EAAxC,MAIO,IAAI,IAAI,CAAJ,MAAW,IAAX,EAAiB;AAC3B,MAAI,CAAC,OAAD,EACH,OAAQ,GAAR,CADD;EADM,MAGA;AACN,SAAO,IAAI,CAAJ,MAAW,IAAX,EACN,MAAM,IAAI,KAAJ,CAAU,CAAV,CAAN,CADD;AAEA,MAAI,IAAI,CAAJ,MAAW,IAAX,IAAmB,IAAI,CAAJ,MAAW,IAAX,EACtB,MAAO,IAAI,KAAJ,CAAU,sCACb,mBADa,CAAjB,CADD;AAGA,MAAI,IAAI,CAAJ,MAAW,IAAX,EACH,MAAO,IAAI,KAAJ,CAAU,kCAAV,CAAP,CADD;AAEA,MAAI,CAAC,OAAD,EACH,OAAQ,GAAR,CADD;EAXM;AAcP,KAAI,IAAI,IAAI,MAAJ,CAAW,IAAI,MAAJ,GAAa,CAAb,CAAf,CApB8B;AAqBlC,GAAE,CAAF,IAAO,GAAP,CArBkC;AAsBlC,KAAI,IAAJ,CAAS,CAAT,EAAY,CAAZ,EAtBkC;AAuBlC,QAAQ,CAAR,CAvBkC;CAAnC;;AA0BA,SAAS,WAAT,CAAqB,GAArB,EAA0B;AACzB,QAAO,MAAP,CAAc,GAAd,EADyB;AAEzB,QAAO,IAAI,MAAJ,GAAa,CAAb,IAAkB,IAAI,CAAJ,MAAW,IAAX,IAAmB,CAAC,IAAI,CAAJ,IAAS,IAAT,CAAD,KAAoB,IAApB,EAC3C,MAAM,IAAI,KAAJ,CAAU,CAAV,CAAN,CADD;AAEA,KAAI,CAAC,IAAI,CAAJ,IAAS,IAAT,CAAD,KAAoB,IAApB,EAA0B;AAC7B,MAAI,IAAI,IAAI,MAAJ,CAAW,IAAI,MAAJ,GAAa,CAAb,CAAf,CADyB;AAE7B,IAAE,CAAF,IAAO,IAAP,CAF6B;AAG7B,MAAI,IAAJ,CAAS,CAAT,EAAY,CAAZ,EAH6B;AAI7B,QAAM,CAAN,CAJ6B;EAA9B;AAMA,QAAQ,GAAR,CAVyB;CAA1B;;AAaA,SAAS,aAAT,CAAuB,MAAvB,EAA+B;AAC9B,KAAI,MAAM,IAAI,MAAJ,CAAW,OAAO,WAAP,EAAX,CAAN,CAD0B;AAE9B,OAAM,YAAY,GAAZ,CAAN,CAF8B;AAG9B,QAAQ,GAAR,CAH8B;CAA/B;;AAMA,SAAS,kBAAT,CAA4B,CAA5B,EAA+B,CAA/B,EAAkC,CAAlC,EAAqC;AACpC,QAAO,MAAP,CAAc,CAAd,EADoC;AAEpC,QAAO,MAAP,CAAc,CAAd,EAFoC;AAGpC,QAAO,MAAP,CAAc,CAAd,EAHoC;AAIpC,KAAI;AACH,MAAI,SAAS,QAAQ,MAAR,EAAgB,UAAhB,CADV;EAAJ,CAEE,OAAO,CAAP,EAAU;AACX,QAAO,IAAI,KAAJ,CAAU,8CACb,oCADa,CAAjB,CADW;EAAV;AAIF,KAAI,IAAI,MAAJ,CAAW,CAAX,CAAJ,CAVoC;AAWpC,KAAI,IAAI,MAAJ,CAAW,CAAX,CAAJ,CAXoC;AAYpC,KAAI,IAAI,MAAJ,CAAW,CAAX,CAAJ,CAZoC;AAapC,KAAI,IAAI,EAAE,MAAF,CAAS,CAAT,EAAY,CAAZ,CAAJ,CAbgC;AAcpC,KAAI,OAAO,cAAc,CAAd,CAAP,CAdgC;AAepC,QAAQ,IAAR,CAfoC;CAArC;;AAkBA,SAAS,aAAT,CAAuB,GAAvB,EAA4B;AAC3B,QAAO,MAAP,CAAc,GAAd,EAD2B;AAE3B,kBAAiB,GAAjB,EAAsB,UAAtB,EAAkC,CAAC,CAAD,EAAI,CAAJ,CAAlC,EAF2B;AAG3B,KAAI;AACH,MAAI,SAAS,QAAQ,MAAR,EAAgB,UAAhB,CADV;EAAJ,CAEE,OAAO,CAAP,EAAU;AACX,QAAO,IAAI,KAAJ,CAAU,qCACb,6CADa,CAAjB,CADW;EAAV;;AAKF,KAAI,IAAI,IAAI,MAAJ,CAAW,IAAI,IAAJ,CAAS,CAAT,CAAW,IAAX,CAAf,CAVuB;AAW3B,KAAI,GAAJ,CAX2B;;AAa3B,KAAI,CAAC,IAAI,IAAJ,CAAS,KAAT,EAAgB;AACpB,MAAI,IAAI,IAAI,MAAJ,CAAW,IAAI,IAAJ,CAAS,CAAT,CAAW,IAAX,CAAf,CADgB;AAEpB,MAAI,QAAQ,EAAE,GAAF,CAAM,EAAE,QAAF,CAAW,CAAX,CAAN,CAAR,CAFgB;;AAIpB,QAAM,cAAc,KAAd,CAAN,CAJoB;AAKpB,MAAI,IAAJ,CAAS,KAAT,GAAiB,EAAC,MAAM,OAAN,EAAe,MAAM,GAAN,EAAjC,CALoB;AAMpB,MAAI,KAAJ,CAAU,IAAV,CAAe,IAAI,IAAJ,CAAS,KAAT,CAAf,CANoB;EAArB;AAQA,KAAI,CAAC,IAAI,IAAJ,CAAS,KAAT,EAAgB;AACpB,MAAI,IAAI,IAAI,MAAJ,CAAW,IAAI,IAAJ,CAAS,CAAT,CAAW,IAAX,CAAf,CADgB;AAEpB,MAAI,QAAQ,EAAE,GAAF,CAAM,EAAE,QAAF,CAAW,CAAX,CAAN,CAAR,CAFgB;;AAIpB,QAAM,cAAc,KAAd,CAAN,CAJoB;AAKpB,MAAI,IAAJ,CAAS,KAAT,GAAiB,EAAC,MAAM,OAAN,EAAe,MAAM,GAAN,EAAjC,CALoB;AAMpB,MAAI,KAAJ,CAAU,IAAV,CAAe,IAAI,IAAJ,CAAS,KAAT,CAAf,CANoB;EAArB;CArBD","file":"utils-compiled.js","sourcesContent":["// Copyright 2015 Joyent, Inc.\n\nmodule.exports = {\n\tbufferSplit: bufferSplit,\n\taddRSAMissing: addRSAMissing,\n\tcalculateDSAPublic: calculateDSAPublic,\n\tmpNormalize: mpNormalize,\n\tecNormalize: ecNormalize,\n\tcountZeros: countZeros,\n\tassertCompatible: assertCompatible,\n\tisCompatible: isCompatible\n};\n\nvar assert = require('assert-plus');\nvar PrivateKey = require('./private-key');\n\nvar MAX_CLASS_DEPTH = 3;\n\nfunction isCompatible(obj, klass, needVer) {\n\tif (obj === null || typeof (obj) !== 'object')\n\t\treturn (false);\n\tif (needVer === undefined)\n\t\tneedVer = klass.prototype._sshpkApiVersion;\n\tif (obj instanceof klass &&\n\t    klass.prototype._sshpkApiVersion[0] == needVer[0])\n\t\treturn (true);\n\tvar proto = Object.getPrototypeOf(obj);\n\tvar depth = 0;\n\twhile (proto.constructor.name !== klass.name) {\n\t\tproto = Object.getPrototypeOf(proto);\n\t\tif (!proto || ++depth > MAX_CLASS_DEPTH)\n\t\t\treturn (false);\n\t}\n\tif (proto.constructor.name !== klass.name)\n\t\treturn (false);\n\tvar ver = proto._sshpkApiVersion;\n\tif (ver === undefined)\n\t\tver = klass._oldVersionDetect(obj);\n\tif (ver[0] != needVer[0] || ver[1] < needVer[1])\n\t\treturn (false);\n\treturn (true);\n}\n\nfunction assertCompatible(obj, klass, needVer, name) {\n\tif (name === undefined)\n\t\tname = 'object';\n\tassert.ok(obj, name + ' must not be null');\n\tassert.object(obj, name + ' must be an object');\n\tif (needVer === undefined)\n\t\tneedVer = klass.prototype._sshpkApiVersion;\n\tif (obj instanceof klass &&\n\t    klass.prototype._sshpkApiVersion[0] == needVer[0])\n\t\treturn;\n\tvar proto = Object.getPrototypeOf(obj);\n\tvar depth = 0;\n\twhile (proto.constructor.name !== klass.name) {\n\t\tproto = Object.getPrototypeOf(proto);\n\t\tassert.ok(proto && ++depth <= MAX_CLASS_DEPTH,\n\t\t    name + ' must be a ' + klass.name + ' instance');\n\t}\n\tassert.strictEqual(proto.constructor.name, klass.name,\n\t    name + ' must be a ' + klass.name + ' instance');\n\tvar ver = proto._sshpkApiVersion;\n\tif (ver === undefined)\n\t\tver = klass._oldVersionDetect(obj);\n\tassert.ok(ver[0] == needVer[0] && ver[1] >= needVer[1],\n\t    name + ' must be compatible with ' + klass.name + ' klass ' +\n\t    'version ' + needVer[0] + '.' + needVer[1]);\n}\n\n/* Count leading zero bits on a buffer */\nfunction countZeros(buf) {\n\tvar o = 0, obit = 8;\n\twhile (o < buf.length) {\n\t\tvar mask = (1 << obit);\n\t\tif ((buf[o] & mask) === mask)\n\t\t\tbreak;\n\t\tobit--;\n\t\tif (obit < 0) {\n\t\t\to++;\n\t\t\tobit = 8;\n\t\t}\n\t}\n\treturn (o*8 + (8 - obit) - 1);\n}\n\nfunction bufferSplit(buf, chr) {\n\tassert.buffer(buf);\n\tassert.string(chr);\n\n\tvar parts = [];\n\tvar lastPart = 0;\n\tvar matches = 0;\n\tfor (var i = 0; i < buf.length; ++i) {\n\t\tif (buf[i] === chr.charCodeAt(matches))\n\t\t\t++matches;\n\t\telse if (buf[i] === chr.charCodeAt(0))\n\t\t\tmatches = 1;\n\t\telse\n\t\t\tmatches = 0;\n\n\t\tif (matches >= chr.length) {\n\t\t\tvar newPart = i + 1;\n\t\t\tparts.push(buf.slice(lastPart, newPart - matches));\n\t\t\tlastPart = newPart;\n\t\t\tmatches = 0;\n\t\t}\n\t}\n\tif (lastPart <= buf.length)\n\t\tparts.push(buf.slice(lastPart, buf.length));\n\n\treturn (parts);\n}\n\nfunction ecNormalize(buf, addZero) {\n\tassert.buffer(buf);\n\tif (buf[0] === 0x00 && buf[1] === 0x04) {\n\t\tif (addZero)\n\t\t\treturn (buf);\n\t\treturn (buf.slice(1));\n\t} else if (buf[0] === 0x04) {\n\t\tif (!addZero)\n\t\t\treturn (buf);\n\t} else {\n\t\twhile (buf[0] === 0x00)\n\t\t\tbuf = buf.slice(1);\n\t\tif (buf[0] === 0x02 || buf[0] === 0x03)\n\t\t\tthrow (new Error('Compressed elliptic curve points ' +\n\t\t\t    'are not supported'));\n\t\tif (buf[0] !== 0x04)\n\t\t\tthrow (new Error('Not a valid elliptic curve point'));\n\t\tif (!addZero)\n\t\t\treturn (buf);\n\t}\n\tvar b = new Buffer(buf.length + 1);\n\tb[0] = 0x0;\n\tbuf.copy(b, 1);\n\treturn (b);\n}\n\nfunction mpNormalize(buf) {\n\tassert.buffer(buf);\n\twhile (buf.length > 1 && buf[0] === 0x00 && (buf[1] & 0x80) === 0x00)\n\t\tbuf = buf.slice(1);\n\tif ((buf[0] & 0x80) === 0x80) {\n\t\tvar b = new Buffer(buf.length + 1);\n\t\tb[0] = 0x00;\n\t\tbuf.copy(b, 1);\n\t\tbuf = b;\n\t}\n\treturn (buf);\n}\n\nfunction bigintToMpBuf(bigint) {\n\tvar buf = new Buffer(bigint.toByteArray());\n\tbuf = mpNormalize(buf);\n\treturn (buf);\n}\n\nfunction calculateDSAPublic(g, p, x) {\n\tassert.buffer(g);\n\tassert.buffer(p);\n\tassert.buffer(x);\n\ttry {\n\t\tvar bigInt = require('jsbn').BigInteger;\n\t} catch (e) {\n\t\tthrow (new Error('To load a PKCS#8 format DSA private key, ' +\n\t\t    'the node jsbn library is required.'));\n\t}\n\tg = new bigInt(g);\n\tp = new bigInt(p);\n\tx = new bigInt(x);\n\tvar y = g.modPow(x, p);\n\tvar ybuf = bigintToMpBuf(y);\n\treturn (ybuf);\n}\n\nfunction addRSAMissing(key) {\n\tassert.object(key);\n\tassertCompatible(key, PrivateKey, [1, 1]);\n\ttry {\n\t\tvar bigInt = require('jsbn').BigInteger;\n\t} catch (e) {\n\t\tthrow (new Error('To write a PEM private key from ' +\n\t\t    'this source, the node jsbn lib is required.'));\n\t}\n\n\tvar d = new bigInt(key.part.d.data);\n\tvar buf;\n\n\tif (!key.part.dmodp) {\n\t\tvar p = new bigInt(key.part.p.data);\n\t\tvar dmodp = d.mod(p.subtract(1));\n\n\t\tbuf = bigintToMpBuf(dmodp);\n\t\tkey.part.dmodp = {name: 'dmodp', data: buf};\n\t\tkey.parts.push(key.part.dmodp);\n\t}\n\tif (!key.part.dmodq) {\n\t\tvar q = new bigInt(key.part.q.data);\n\t\tvar dmodq = d.mod(q.subtract(1));\n\n\t\tbuf = bigintToMpBuf(dmodq);\n\t\tkey.part.dmodq = {name: 'dmodq', data: buf};\n\t\tkey.parts.push(key.part.dmodq);\n\t}\n}\n"]}