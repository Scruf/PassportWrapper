{"version":3,"sources":["aws4.js"],"names":[],"mappings":"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","file":"aws4-compiled.js","sourcesContent":["var aws4 = exports,\n    url = require('url'),\n    querystring = require('querystring'),\n    crypto = require('crypto'),\n    lru = require('lru-cache'),\n    credentialsCache = lru(1000)\n\n// http://docs.amazonwebservices.com/general/latest/gr/signature-version-4.html\n\nfunction hmac(key, string, encoding) {\n  return crypto.createHmac('sha256', key).update(string, 'utf8').digest(encoding)\n}\n\nfunction hash(string, encoding) {\n  return crypto.createHash('sha256').update(string, 'utf8').digest(encoding)\n}\n\n// This function assumes the string has already been percent encoded\nfunction encodeRfc3986(urlEncodedString) {\n  return urlEncodedString.replace(/[!'()*]/g, function(c) {\n    return '%' + c.charCodeAt(0).toString(16).toUpperCase()\n  })\n}\n\n// request: { path | body, [host], [method], [headers], [service], [region] }\n// credentials: { accessKeyId, secretAccessKey, [sessionToken] }\nfunction RequestSigner(request, credentials) {\n\n  if (typeof request === 'string') request = url.parse(request)\n\n  var headers = request.headers = (request.headers || {}),\n      hostParts = this.matchHost(request.hostname || request.host || headers.Host || headers.host)\n\n  this.request = request\n  this.credentials = credentials || this.defaultCredentials()\n\n  this.service = request.service || hostParts[0] || ''\n  this.region = request.region || hostParts[1] || 'us-east-1'\n\n  // SES uses a different domain from the service name\n  if (this.service === 'email') this.service = 'ses'\n\n  if (!request.method && request.body)\n    request.method = 'POST'\n\n  if (!headers.Host && !headers.host) {\n    headers.Host = request.hostname || request.host || this.createHost()\n\n    // If a port is specified explicitly, use it as is\n    if (request.port)\n      headers.Host += ':' + request.port\n  }\n  if (!request.hostname && !request.host)\n    request.hostname = headers.Host || headers.host\n}\n\nRequestSigner.prototype.matchHost = function(host) {\n  var match = (host || '').match(/([^\\.]+)\\.(?:([^\\.]*)\\.)?amazonaws\\.com$/)\n  var hostParts = (match || []).slice(1, 3)\n\n  // ES's hostParts are sometimes the other way round, if the value that is expected\n  // to be region equals ‘es’ switch them back\n  // e.g. search-cluster-name-aaaa00aaaa0aaa0aaaaaaa0aaa.us-east-1.es.amazonaws.com\n  if (hostParts[1] === 'es')\n    hostParts = hostParts.reverse()\n\n  return hostParts\n}\n\n// http://docs.aws.amazon.com/general/latest/gr/rande.html\nRequestSigner.prototype.isSingleRegion = function() {\n  // Special case for S3 and SimpleDB in us-east-1\n  if (['s3', 'sdb'].indexOf(this.service) >= 0 && this.region === 'us-east-1') return true\n\n  return ['cloudfront', 'ls', 'route53', 'iam', 'importexport', 'sts']\n    .indexOf(this.service) >= 0\n}\n\nRequestSigner.prototype.createHost = function() {\n  var region = this.isSingleRegion() ? '' :\n        (this.service === 's3' && this.region !== 'us-east-1' ? '-' : '.') + this.region,\n      service = this.service === 'ses' ? 'email' : this.service\n  return service + region + '.amazonaws.com'\n}\n\nRequestSigner.prototype.prepareRequest = function() {\n  this.parsePath()\n\n  var request = this.request, headers = request.headers, query\n\n  if (request.signQuery) {\n\n    this.parsedPath.query = query = this.parsedPath.query || {}\n\n    if (this.credentials.sessionToken)\n      query['X-Amz-Security-Token'] = this.credentials.sessionToken\n\n    if (this.service === 's3' && !query['X-Amz-Expires'])\n      query['X-Amz-Expires'] = 86400\n\n    if (query['X-Amz-Date'])\n      this.datetime = query['X-Amz-Date']\n    else\n      query['X-Amz-Date'] = this.getDateTime()\n\n    query['X-Amz-Algorithm'] = 'AWS4-HMAC-SHA256'\n    query['X-Amz-Credential'] = this.credentials.accessKeyId + '/' + this.credentialString()\n    query['X-Amz-SignedHeaders'] = this.signedHeaders()\n\n  } else {\n\n    if (!request.doNotModifyHeaders) {\n      if (request.body && !headers['Content-Type'] && !headers['content-type'])\n        headers['Content-Type'] = 'application/x-www-form-urlencoded; charset=utf-8'\n\n      if (request.body && !headers['Content-Length'] && !headers['content-length'])\n        headers['Content-Length'] = Buffer.byteLength(request.body)\n\n      if (this.credentials.sessionToken)\n        headers['X-Amz-Security-Token'] = this.credentials.sessionToken\n\n      if (this.service === 's3')\n        headers['X-Amz-Content-Sha256'] = hash(this.request.body || '', 'hex')\n\n      if (headers['X-Amz-Date'])\n        this.datetime = headers['X-Amz-Date']\n      else\n        headers['X-Amz-Date'] = this.getDateTime()\n    }\n\n    delete headers.Authorization\n    delete headers.authorization\n  }\n}\n\nRequestSigner.prototype.sign = function() {\n  if (!this.parsedPath) this.prepareRequest()\n\n  if (this.request.signQuery) {\n    this.parsedPath.query['X-Amz-Signature'] = this.signature()\n  } else {\n    this.request.headers.Authorization = this.authHeader()\n  }\n\n  this.request.path = this.formatPath()\n\n  return this.request\n}\n\nRequestSigner.prototype.getDateTime = function() {\n  if (!this.datetime) {\n    var headers = this.request.headers,\n      date = new Date(headers.Date || headers.date || new Date)\n\n    this.datetime = date.toISOString().replace(/[:\\-]|\\.\\d{3}/g, '')\n  }\n  return this.datetime\n}\n\nRequestSigner.prototype.getDate = function() {\n  return this.getDateTime().substr(0, 8)\n}\n\nRequestSigner.prototype.authHeader = function() {\n  return [\n    'AWS4-HMAC-SHA256 Credential=' + this.credentials.accessKeyId + '/' + this.credentialString(),\n    'SignedHeaders=' + this.signedHeaders(),\n    'Signature=' + this.signature(),\n  ].join(', ')\n}\n\nRequestSigner.prototype.signature = function() {\n  var date = this.getDate(),\n      cacheKey = [this.credentials.secretAccessKey, date, this.region, this.service].join(),\n      kDate, kRegion, kService, kCredentials = credentialsCache.get(cacheKey)\n  if (!kCredentials) {\n    kDate = hmac('AWS4' + this.credentials.secretAccessKey, date)\n    kRegion = hmac(kDate, this.region)\n    kService = hmac(kRegion, this.service)\n    kCredentials = hmac(kService, 'aws4_request')\n    credentialsCache.set(cacheKey, kCredentials)\n  }\n  return hmac(kCredentials, this.stringToSign(), 'hex')\n}\n\nRequestSigner.prototype.stringToSign = function() {\n  return [\n    'AWS4-HMAC-SHA256',\n    this.getDateTime(),\n    this.credentialString(),\n    hash(this.canonicalString(), 'hex'),\n  ].join('\\n')\n}\n\nRequestSigner.prototype.canonicalString = function() {\n  if (!this.parsedPath) this.prepareRequest()\n\n  var pathStr = this.parsedPath.path,\n      query = this.parsedPath.query,\n      queryStr = '',\n      normalizePath = this.service !== 's3',\n      decodePath = this.service === 's3' || this.request.doNotEncodePath,\n      decodeSlashesInPath = this.service === 's3',\n      firstValOnly = this.service === 's3',\n      bodyHash = this.service === 's3' && this.request.signQuery ?\n        'UNSIGNED-PAYLOAD' : hash(this.request.body || '', 'hex')\n\n  if (query) {\n    queryStr = encodeRfc3986(querystring.stringify(Object.keys(query).sort().reduce(function(obj, key) {\n      if (!key) return obj\n      obj[key] = !Array.isArray(query[key]) ? query[key] :\n        (firstValOnly ? query[key][0] : query[key].slice().sort())\n      return obj\n    }, {})))\n  }\n  if (pathStr !== '/') {\n    if (normalizePath) pathStr = pathStr.replace(/\\/{2,}/g, '/')\n    pathStr = pathStr.split('/').reduce(function(path, piece) {\n      if (normalizePath && piece === '..') {\n        path.pop()\n      } else if (!normalizePath || piece !== '.') {\n        if (decodePath) piece = querystring.unescape(piece)\n        path.push(encodeRfc3986(querystring.escape(piece)))\n      }\n      return path\n    }, []).join('/')\n    if (pathStr[0] !== '/') pathStr = '/' + pathStr\n    if (decodeSlashesInPath) pathStr = pathStr.replace(/%2F/g, '/')\n  }\n\n  return [\n    this.request.method || 'GET',\n    pathStr,\n    queryStr,\n    this.canonicalHeaders() + '\\n',\n    this.signedHeaders(),\n    bodyHash,\n  ].join('\\n')\n}\n\nRequestSigner.prototype.canonicalHeaders = function() {\n  var headers = this.request.headers\n  function trimAll(header) {\n    return header.toString().trim().replace(/\\s+/g, ' ')\n  }\n  return Object.keys(headers)\n    .sort(function(a, b) { return a.toLowerCase() < b.toLowerCase() ? -1 : 1 })\n    .map(function(key) { return key.toLowerCase() + ':' + trimAll(headers[key]) })\n    .join('\\n')\n}\n\nRequestSigner.prototype.signedHeaders = function() {\n  return Object.keys(this.request.headers)\n    .map(function(key) { return key.toLowerCase() })\n    .sort()\n    .join(';')\n}\n\nRequestSigner.prototype.credentialString = function() {\n  return [\n    this.getDate(),\n    this.region,\n    this.service,\n    'aws4_request',\n  ].join('/')\n}\n\nRequestSigner.prototype.defaultCredentials = function() {\n  var env = process.env\n  return {\n    accessKeyId: env.AWS_ACCESS_KEY_ID || env.AWS_ACCESS_KEY,\n    secretAccessKey: env.AWS_SECRET_ACCESS_KEY || env.AWS_SECRET_KEY,\n    sessionToken: env.AWS_SESSION_TOKEN,\n  }\n}\n\nRequestSigner.prototype.parsePath = function() {\n  var path = this.request.path || '/',\n      queryIx = path.indexOf('?'),\n      query = null\n\n  if (queryIx >= 0) {\n    query = querystring.parse(path.slice(queryIx + 1))\n    path = path.slice(0, queryIx)\n  }\n\n  // S3 doesn't always encode characters > 127 correctly and\n  // all services don't encode characters > 255 correctly\n  // So if there are non-reserved chars (and it's not already all % encoded), just encode them all\n  if (/[^0-9A-Za-z!'()*\\-._~%/]/.test(path)) {\n    path = path.split('/').map(function(piece) {\n      return querystring.escape(querystring.unescape(piece))\n    }).join('/')\n  }\n\n  this.parsedPath = {\n    path: path,\n    query: query,\n  }\n}\n\nRequestSigner.prototype.formatPath = function() {\n  var path = this.parsedPath.path,\n      query = this.parsedPath.query\n\n  if (!query) return path\n\n  // Services don't support empty query string keys\n  if (query[''] != null) delete query['']\n\n  return path + '?' + encodeRfc3986(querystring.stringify(query))\n}\n\naws4.RequestSigner = RequestSigner\n\naws4.sign = function(request, credentials) {\n  return new RequestSigner(request, credentials).sign()\n}\n"]}