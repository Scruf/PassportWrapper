{"version":3,"sources":["delayed_stream.js"],"names":[],"mappings":"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","file":"delayed_stream-compiled.js","sourcesContent":["var Stream = require('stream').Stream;\nvar util = require('util');\n\nmodule.exports = DelayedStream;\nfunction DelayedStream() {\n  this.source = null;\n  this.dataSize = 0;\n  this.maxDataSize = 1024 * 1024;\n  this.pauseStream = true;\n\n  this._maxDataSizeExceeded = false;\n  this._released = false;\n  this._bufferedEvents = [];\n}\nutil.inherits(DelayedStream, Stream);\n\nDelayedStream.create = function(source, options) {\n  var delayedStream = new this();\n\n  options = options || {};\n  for (var option in options) {\n    delayedStream[option] = options[option];\n  }\n\n  delayedStream.source = source;\n\n  var realEmit = source.emit;\n  source.emit = function() {\n    delayedStream._handleEmit(arguments);\n    return realEmit.apply(source, arguments);\n  };\n\n  source.on('error', function() {});\n  if (delayedStream.pauseStream) {\n    source.pause();\n  }\n\n  return delayedStream;\n};\n\nObject.defineProperty(DelayedStream.prototype, 'readable', {\n  configurable: true,\n  enumerable: true,\n  get: function() {\n    return this.source.readable;\n  }\n});\n\nDelayedStream.prototype.setEncoding = function() {\n  return this.source.setEncoding.apply(this.source, arguments);\n};\n\nDelayedStream.prototype.resume = function() {\n  if (!this._released) {\n    this.release();\n  }\n\n  this.source.resume();\n};\n\nDelayedStream.prototype.pause = function() {\n  this.source.pause();\n};\n\nDelayedStream.prototype.release = function() {\n  this._released = true;\n\n  this._bufferedEvents.forEach(function(args) {\n    this.emit.apply(this, args);\n  }.bind(this));\n  this._bufferedEvents = [];\n};\n\nDelayedStream.prototype.pipe = function() {\n  var r = Stream.prototype.pipe.apply(this, arguments);\n  this.resume();\n  return r;\n};\n\nDelayedStream.prototype._handleEmit = function(args) {\n  if (this._released) {\n    this.emit.apply(this, args);\n    return;\n  }\n\n  if (args[0] === 'data') {\n    this.dataSize += args[1].length;\n    this._checkIfMaxDataSizeExceeded();\n  }\n\n  this._bufferedEvents.push(args);\n};\n\nDelayedStream.prototype._checkIfMaxDataSizeExceeded = function() {\n  if (this._maxDataSizeExceeded) {\n    return;\n  }\n\n  if (this.dataSize <= this.maxDataSize) {\n    return;\n  }\n\n  this._maxDataSizeExceeded = true;\n  var message =\n    'DelayedStream#maxDataSize of ' + this.maxDataSize + ' bytes exceeded.'\n  this.emit('error', new Error(message));\n};\n"]}