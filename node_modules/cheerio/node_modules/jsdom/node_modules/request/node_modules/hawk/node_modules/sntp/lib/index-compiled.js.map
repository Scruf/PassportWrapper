{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["// Load modules\n\nvar Dgram = require('dgram');\nvar Dns = require('dns');\nvar Hoek = require('hoek');\n\n\n// Declare internals\n\nvar internals = {};\n\n\nexports.time = function (options, callback) {\n\n    if (arguments.length !== 2) {\n        callback = arguments[0];\n        options = {};\n    }\n\n    var settings = Hoek.clone(options);\n    settings.host = settings.host || 'pool.ntp.org';\n    settings.port = settings.port || 123;\n    settings.resolveReference = settings.resolveReference || false;\n\n    // Declare variables used by callback\n\n    var timeoutId = 0;\n    var sent = 0;\n\n    // Ensure callback is only called once\n\n    var finish = function (err, result) {\n\n        if (timeoutId) {\n            clearTimeout(timeoutId);\n            timeoutId = 0;\n        }\n\n        socket.removeAllListeners();\n        socket.once('error', internals.ignore);\n        socket.close();\n        return callback(err, result);\n    };\n\n    finish = Hoek.once(finish);\n\n    // Create UDP socket\n\n    var socket = Dgram.createSocket('udp4');\n\n    socket.once('error', function (err) {\n\n        return finish(err);\n    });\n\n    // Listen to incoming messages\n\n    socket.on('message', function (buffer, rinfo) {\n\n        var received = Date.now();\n\n        var message = new internals.NtpMessage(buffer);\n        if (!message.isValid) {\n            return finish(new Error('Invalid server response'), message);\n        }\n\n        if (message.originateTimestamp !== sent) {\n            return finish(new Error('Wrong originate timestamp'), message);\n        }\n\n        // Timestamp Name          ID   When Generated\n        // ------------------------------------------------------------\n        // Originate Timestamp     T1   time request sent by client\n        // Receive Timestamp       T2   time request received by server\n        // Transmit Timestamp      T3   time reply sent by server\n        // Destination Timestamp   T4   time reply received by client\n        //\n        // The roundtrip delay d and system clock offset t are defined as:\n        //\n        // d = (T4 - T1) - (T3 - T2)     t = ((T2 - T1) + (T3 - T4)) / 2\n\n        var T1 = message.originateTimestamp;\n        var T2 = message.receiveTimestamp;\n        var T3 = message.transmitTimestamp;\n        var T4 = received;\n\n        message.d = (T4 - T1) - (T3 - T2);\n        message.t = ((T2 - T1) + (T3 - T4)) / 2;\n        message.receivedLocally = received;\n\n        if (!settings.resolveReference ||\n            message.stratum !== 'secondary') {\n\n            return finish(null, message);\n        }\n\n        // Resolve reference IP address\n\n        Dns.reverse(message.referenceId, function (err, domains) {\n\n            if (/* $lab:coverage:off$ */ !err /* $lab:coverage:on$ */) {\n                message.referenceHost = domains[0];\n            }\n\n            return finish(null, message);\n        });\n    });\n\n    // Set timeout\n\n    if (settings.timeout) {\n        timeoutId = setTimeout(function () {\n\n            timeoutId = 0;\n            return finish(new Error('Timeout'));\n        }, settings.timeout);\n    }\n\n    // Construct NTP message\n\n    var message = new Buffer(48);\n    for (var i = 0; i < 48; i++) {                      // Zero message\n        message[i] = 0;\n    }\n\n    message[0] = (0 << 6) + (4 << 3) + (3 << 0)         // Set version number to 4 and Mode to 3 (client)\n    sent = Date.now();\n    internals.fromMsecs(sent, message, 40);               // Set transmit timestamp (returns as originate)\n\n    // Send NTP request\n\n    socket.send(message, 0, message.length, settings.port, settings.host, function (err, bytes) {\n\n        if (err ||\n            bytes !== 48) {\n\n            return finish(err || new Error('Could not send entire message'));\n        }\n    });\n};\n\n\ninternals.NtpMessage = function (buffer) {\n\n    this.isValid = false;\n\n    // Validate\n\n    if (buffer.length !== 48) {\n        return;\n    }\n\n    // Leap indicator\n\n    var li = (buffer[0] >> 6);\n    switch (li) {\n        case 0: this.leapIndicator = 'no-warning'; break;\n        case 1: this.leapIndicator = 'last-minute-61'; break;\n        case 2: this.leapIndicator = 'last-minute-59'; break;\n        case 3: this.leapIndicator = 'alarm'; break;\n    }\n\n    // Version\n\n    var vn = ((buffer[0] & 0x38) >> 3);\n    this.version = vn;\n\n    // Mode\n\n    var mode = (buffer[0] & 0x7);\n    switch (mode) {\n        case 1: this.mode = 'symmetric-active'; break;\n        case 2: this.mode = 'symmetric-passive'; break;\n        case 3: this.mode = 'client'; break;\n        case 4: this.mode = 'server'; break;\n        case 5: this.mode = 'broadcast'; break;\n        case 0:\n        case 6:\n        case 7: this.mode = 'reserved'; break;\n    }\n\n    // Stratum\n\n    var stratum = buffer[1];\n    if (stratum === 0) {\n        this.stratum = 'death';\n    }\n    else if (stratum === 1) {\n        this.stratum = 'primary';\n    }\n    else if (stratum <= 15) {\n        this.stratum = 'secondary';\n    }\n    else {\n        this.stratum = 'reserved';\n    }\n\n    // Poll interval (msec)\n\n    this.pollInterval = Math.round(Math.pow(2, buffer[2])) * 1000;\n\n    // Precision (msecs)\n\n    this.precision = Math.pow(2, buffer[3]) * 1000;\n\n    // Root delay (msecs)\n\n    var rootDelay = 256 * (256 * (256 * buffer[4] + buffer[5]) + buffer[6]) + buffer[7];\n    this.rootDelay = 1000 * (rootDelay / 0x10000);\n\n    // Root dispersion (msecs)\n\n    this.rootDispersion = ((buffer[8] << 8) + buffer[9] + ((buffer[10] << 8) + buffer[11]) / Math.pow(2, 16)) * 1000;\n\n    // Reference identifier\n\n    this.referenceId = '';\n    switch (this.stratum) {\n        case 'death':\n        case 'primary':\n            this.referenceId = String.fromCharCode(buffer[12]) + String.fromCharCode(buffer[13]) + String.fromCharCode(buffer[14]) + String.fromCharCode(buffer[15]);\n            break;\n        case 'secondary':\n            this.referenceId = '' + buffer[12] + '.' + buffer[13] + '.' + buffer[14] + '.' + buffer[15];\n            break;\n    }\n\n    // Reference timestamp\n\n    this.referenceTimestamp = internals.toMsecs(buffer, 16);\n\n    // Originate timestamp\n\n    this.originateTimestamp = internals.toMsecs(buffer, 24);\n\n    // Receive timestamp\n\n    this.receiveTimestamp = internals.toMsecs(buffer, 32);\n\n    // Transmit timestamp\n\n    this.transmitTimestamp = internals.toMsecs(buffer, 40);\n\n    // Validate\n\n    if (this.version === 4 &&\n        this.stratum !== 'reserved' &&\n        this.mode === 'server' &&\n        this.originateTimestamp &&\n        this.receiveTimestamp &&\n        this.transmitTimestamp) {\n\n        this.isValid = true;\n    }\n\n    return this;\n};\n\n\ninternals.toMsecs = function (buffer, offset) {\n\n    var seconds = 0;\n    var fraction = 0;\n\n    for (var i = 0; i < 4; ++i) {\n        seconds = (seconds * 256) + buffer[offset + i];\n    }\n\n    for (i = 4; i < 8; ++i) {\n        fraction = (fraction * 256) + buffer[offset + i];\n    }\n\n    return ((seconds - 2208988800 + (fraction / Math.pow(2, 32))) * 1000);\n};\n\n\ninternals.fromMsecs = function (ts, buffer, offset) {\n\n    var seconds = Math.floor(ts / 1000) + 2208988800;\n    var fraction = Math.round((ts % 1000) / 1000 * Math.pow(2, 32));\n\n    buffer[offset + 0] = (seconds & 0xFF000000) >> 24;\n    buffer[offset + 1] = (seconds & 0x00FF0000) >> 16;\n    buffer[offset + 2] = (seconds & 0x0000FF00) >> 8;\n    buffer[offset + 3] = (seconds & 0x000000FF);\n\n    buffer[offset + 4] = (fraction & 0xFF000000) >> 24;\n    buffer[offset + 5] = (fraction & 0x00FF0000) >> 16;\n    buffer[offset + 6] = (fraction & 0x0000FF00) >> 8;\n    buffer[offset + 7] = (fraction & 0x000000FF);\n};\n\n\n// Offset singleton\n\ninternals.last = {\n    offset: 0,\n    expires: 0,\n    host: '',\n    port: 0\n};\n\n\nexports.offset = function (options, callback) {\n\n    if (arguments.length !== 2) {\n        callback = arguments[0];\n        options = {};\n    }\n\n    var now = Date.now();\n    var clockSyncRefresh = options.clockSyncRefresh || 24 * 60 * 60 * 1000;                    // Daily\n\n    if (internals.last.offset &&\n        internals.last.host === options.host &&\n        internals.last.port === options.port &&\n        now < internals.last.expires) {\n\n        process.nextTick(function () {\n\n            callback(null, internals.last.offset);\n        });\n\n        return;\n    }\n\n    exports.time(options, function (err, time) {\n\n        if (err) {\n            return callback(err, 0);\n        }\n\n        internals.last = {\n            offset: Math.round(time.t),\n            expires: now + clockSyncRefresh,\n            host: options.host,\n            port: options.port\n        };\n\n        return callback(null, internals.last.offset);\n    });\n};\n\n\n// Now singleton\n\ninternals.now = {\n    intervalId: 0\n};\n\n\nexports.start = function (options, callback) {\n\n    if (arguments.length !== 2) {\n        callback = arguments[0];\n        options = {};\n    }\n\n    if (internals.now.intervalId) {\n        process.nextTick(function () {\n\n            callback();\n        });\n\n        return;\n    }\n\n    exports.offset(options, function (err, offset) {\n\n        internals.now.intervalId = setInterval(function () {\n\n            exports.offset(options, function () { });\n        }, options.clockSyncRefresh || 24 * 60 * 60 * 1000);                                // Daily\n\n        return callback();\n    });\n};\n\n\nexports.stop = function () {\n\n    if (!internals.now.intervalId) {\n        return;\n    }\n\n    clearInterval(internals.now.intervalId);\n    internals.now.intervalId = 0;\n};\n\n\nexports.isLive = function () {\n\n    return !!internals.now.intervalId;\n};\n\n\nexports.now = function () {\n\n    var now = Date.now();\n    if (!exports.isLive() ||\n        now >= internals.last.expires) {\n\n        return now;\n    }\n\n    return now + internals.last.offset;\n};\n\n\ninternals.ignore = function () {\n\n};\n"]}