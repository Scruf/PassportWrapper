{"version":3,"sources":["utils.js"],"names":[],"mappings":"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","file":"utils-compiled.js","sourcesContent":["// Load modules\r\n\r\nvar Sntp = require('sntp');\r\nvar Boom = require('boom');\r\n\r\n\r\n// Declare internals\r\n\r\nvar internals = {};\r\n\r\n\r\nexports.version = function () {\r\n\r\n    return require('../package.json').version;\r\n};\r\n\r\n\r\nexports.limits = {\r\n    maxMatchLength: 4096            // Limit the length of uris and headers to avoid a DoS attack on string matching\r\n};\r\n\r\n\r\n// Extract host and port from request\r\n\r\n//                                            $1                            $2\r\ninternals.hostHeaderRegex = /^(?:(?:\\r\\n)?\\s)*((?:[^:]+)|(?:\\[[^\\]]+\\]))(?::(\\d+))?(?:(?:\\r\\n)?\\s)*$/;              // (IPv4, hostname)|(IPv6)\r\n\r\n\r\nexports.parseHost = function (req, hostHeaderName) {\r\n\r\n    hostHeaderName = (hostHeaderName ? hostHeaderName.toLowerCase() : 'host');\r\n    var hostHeader = req.headers[hostHeaderName];\r\n    if (!hostHeader) {\r\n        return null;\r\n    }\r\n\r\n    if (hostHeader.length > exports.limits.maxMatchLength) {\r\n        return null;\r\n    }\r\n\r\n    var hostParts = hostHeader.match(internals.hostHeaderRegex);\r\n    if (!hostParts) {\r\n        return null;\r\n    }\r\n\r\n    return {\r\n        name: hostParts[1],\r\n        port: (hostParts[2] ? hostParts[2] : (req.connection && req.connection.encrypted ? 443 : 80))\r\n    };\r\n};\r\n\r\n\r\n// Parse Content-Type header content\r\n\r\nexports.parseContentType = function (header) {\r\n\r\n    if (!header) {\r\n        return '';\r\n    }\r\n\r\n    return header.split(';')[0].trim().toLowerCase();\r\n};\r\n\r\n\r\n// Convert node's  to request configuration object\r\n\r\nexports.parseRequest = function (req, options) {\r\n\r\n    if (!req.headers) {\r\n        return req;\r\n    }\r\n\r\n    // Obtain host and port information\r\n\r\n    var host;\r\n    if (!options.host ||\r\n        !options.port) {\r\n\r\n        host = exports.parseHost(req, options.hostHeaderName);\r\n        if (!host) {\r\n            return new Error('Invalid Host header');\r\n        }\r\n    }\r\n\r\n    var request = {\r\n        method: req.method,\r\n        url: req.url,\r\n        host: options.host || host.name,\r\n        port: options.port || host.port,\r\n        authorization: req.headers.authorization,\r\n        contentType: req.headers['content-type'] || ''\r\n    };\r\n\r\n    return request;\r\n};\r\n\r\n\r\nexports.now = function (localtimeOffsetMsec) {\r\n\r\n    return Sntp.now() + (localtimeOffsetMsec || 0);\r\n};\r\n\r\n\r\nexports.nowSecs = function (localtimeOffsetMsec) {\r\n\r\n    return Math.floor(exports.now(localtimeOffsetMsec) / 1000);\r\n};\r\n\r\n\r\ninternals.authHeaderRegex = /^(\\w+)(?:\\s+(.*))?$/;                                      // Header: scheme[ something]\r\ninternals.attributeRegex = /^[ \\w\\!#\\$%&'\\(\\)\\*\\+,\\-\\.\\/\\:;<\\=>\\?@\\[\\]\\^`\\{\\|\\}~]+$/;   // !#$%&'()*+,-./:;<=>?@[]^_`{|}~ and space, a-z, A-Z, 0-9\r\n\r\n\r\n// Parse Hawk HTTP Authorization header\r\n\r\nexports.parseAuthorizationHeader = function (header, keys) {\r\n\r\n    keys = keys || ['id', 'ts', 'nonce', 'hash', 'ext', 'mac', 'app', 'dlg'];\r\n\r\n    if (!header) {\r\n        return Boom.unauthorized(null, 'Hawk');\r\n    }\r\n\r\n    if (header.length > exports.limits.maxMatchLength) {\r\n        return Boom.badRequest('Header length too long');\r\n    }\r\n\r\n    var headerParts = header.match(internals.authHeaderRegex);\r\n    if (!headerParts) {\r\n        return Boom.badRequest('Invalid header syntax');\r\n    }\r\n\r\n    var scheme = headerParts[1];\r\n    if (scheme.toLowerCase() !== 'hawk') {\r\n        return Boom.unauthorized(null, 'Hawk');\r\n    }\r\n\r\n    var attributesString = headerParts[2];\r\n    if (!attributesString) {\r\n        return Boom.badRequest('Invalid header syntax');\r\n    }\r\n\r\n    var attributes = {};\r\n    var errorMessage = '';\r\n    var verify = attributesString.replace(/(\\w+)=\"([^\"\\\\]*)\"\\s*(?:,\\s*|$)/g, function ($0, $1, $2) {\r\n\r\n        // Check valid attribute names\r\n\r\n        if (keys.indexOf($1) === -1) {\r\n            errorMessage = 'Unknown attribute: ' + $1;\r\n            return;\r\n        }\r\n\r\n        // Allowed attribute value characters\r\n\r\n        if ($2.match(internals.attributeRegex) === null) {\r\n            errorMessage = 'Bad attribute value: ' + $1;\r\n            return;\r\n        }\r\n\r\n        // Check for duplicates\r\n\r\n        if (attributes.hasOwnProperty($1)) {\r\n            errorMessage = 'Duplicate attribute: ' + $1;\r\n            return;\r\n        }\r\n\r\n        attributes[$1] = $2;\r\n        return '';\r\n    });\r\n\r\n    if (verify !== '') {\r\n        return Boom.badRequest(errorMessage || 'Bad header format');\r\n    }\r\n\r\n    return attributes;\r\n};\r\n\r\n\r\nexports.unauthorized = function (message, attributes) {\r\n\r\n    return Boom.unauthorized(message, 'Hawk', attributes);\r\n};\r\n\r\n"]}