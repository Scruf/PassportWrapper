{"version":3,"sources":["location_info_mixin.js"],"names":[],"mappings":"AAAA;;AAEA,IAAI,mBAAmB,QAAQ,sBAAR,CAAnB;IACA,YAAY,QAAQ,2BAAR,CAAZ;IACA,OAAO,QAAQ,gBAAR,CAAP;;;AAIJ,IAAI,IAAI,KAAK,SAAL;;AAGR,SAAS,cAAT,CAAwB,OAAxB,EAAiC,YAAjC,EAA+C,WAA/C,EAA4D;AACxD,QAAI,MAAM,QAAQ,UAAR,CAD8C;;AAGxD,QAAI,CAAC,GAAD,EACA,OADJ;;AAGA,QAAI,CAAC,IAAI,QAAJ,EAAc;AACf,YAAI,QAAJ,GAAe;AACX,mBAAO,IAAI,KAAJ;AACP,iBAAK,IAAI,GAAJ;SAFT,CADe;KAAnB;;AAOA,QAAI,aAAa,QAAb,EAAuB;AACvB,YAAI,KAAK,YAAY,UAAZ,CAAuB,OAAvB,CAAL;;;;AAGA,0BAAkB,aAAa,IAAb,KAAsB,UAAU,aAAV,IACtB,OAAO,aAAa,OAAb,CALN;;AAOvB,YAAI,eAAJ,EAAqB;AACjB,gBAAI,MAAJ,GAAa;AACT,uBAAO,aAAa,QAAb,CAAsB,KAAtB;AACP,qBAAK,aAAa,QAAb,CAAsB,GAAtB;aAFT,CADiB;SAArB;;AAOA,YAAI,GAAJ,GAAU,aAAa,QAAb,CAAsB,GAAtB,CAda;KAA3B;CAbJ;;;AAgCA,SAAS,sBAAT,CAAgC,KAAhC,EAAuC,MAAvC,EAA+C;AAC3C,QAAI,cAAc,OAAO,WAAP,CADyB;;AAG3C,UAAM,GAAN,GAAY,YAAY;AACpB,uBAAe,KAAK,OAAL,EAAc,OAAO,YAAP,EAAqB,WAAlD,EADoB;AAEpB,yBAAiB,SAAjB,CAA2B,GAA3B,CAA+B,IAA/B,CAAoC,IAApC,EAFoB;KAAZ,CAH+B;;AAQ3C,UAAM,qBAAN,GAA8B,YAAY;AACtC,aAAK,IAAI,IAAI,KAAK,QAAL,EAAe,IAAI,CAAJ,EAAO,GAAnC,EACI,eAAe,KAAK,KAAL,CAAW,CAAX,CAAf,EAA8B,OAAO,YAAP,EAAqB,WAAnD,EADJ;;AAGA,yBAAiB,SAAjB,CAA2B,qBAA3B,CAAiD,IAAjD,CAAsD,IAAtD,EAJsC;KAAZ,CARa;;AAe3C,UAAM,MAAN,GAAe,UAAU,OAAV,EAAmB;AAC9B,uBAAe,OAAf,EAAwB,OAAO,YAAP,EAAqB,WAA7C,EAD8B;AAE9B,yBAAiB,SAAjB,CAA2B,MAA3B,CAAkC,IAAlC,CAAuC,IAAvC,EAA6C,OAA7C,EAF8B;KAAnB,CAf4B;CAA/C;;AAqBA,QAAQ,MAAR,GAAiB,UAAU,MAAV,EAAkB;;AAE/B,QAAI,cAAc,OAAO,cAAP,CAAsB,MAAtB,CAAd;QACA,cAAc,OAAO,WAAP;;;AAHa,UAO/B,CAAO,MAAP,GAAgB,UAAU,IAAV,EAAgB,QAAhB,EAA0B,eAA1B,EAA2C;AACvD,oBAAY,MAAZ,CAAmB,IAAnB,CAAwB,IAAxB,EAA8B,IAA9B,EAAoC,QAApC,EAA8C,eAA9C,EADuD;;AAGvD,aAAK,yBAAL,GAAiC,IAAjC,CAHuD;AAIvD,aAAK,2BAAL,GAAmC,IAAnC,CAJuD;AAKvD,aAAK,YAAL,GAAoB,IAApB,CALuD;;AAOvD,+BAAuB,KAAK,YAAL,EAAmB,MAA1C,EAPuD;KAA3C,CAPe;;AAiB/B,WAAO,6BAAP,GAAuC,UAAU,KAAV,EAAiB;AACpD,aAAK,YAAL,GAAoB,KAApB,CADoD;AAEpD,oBAAY,6BAAZ,CAA0C,IAA1C,CAA+C,IAA/C,EAAqD,KAArD,EAFoD;KAAjB,CAjBR;;AAsB/B,WAAO,aAAP,GAAuB,UAAU,KAAV,EAAiB;AACpC,aAAK,YAAL,GAAoB,KAApB,CADoC;AAEpC,oBAAY,aAAZ,CAA0B,IAA1B,CAA+B,IAA/B,EAAqC,KAArC;;;;AAFoC,YAMhC,MAAM,IAAN,KAAe,UAAU,aAAV,KACd,MAAM,OAAN,KAAkB,EAAE,IAAF,IAClB,MAAM,OAAN,KAAkB,EAAE,IAAF,IAAU,KAAK,YAAL,CAAkB,UAAlB,CAA6B,EAAE,IAAF,CAAzD,CAFD,EAEqE;AACrE,iBAAK,IAAI,IAAI,KAAK,YAAL,CAAkB,QAAlB,EAA4B,KAAK,CAAL,EAAQ,GAAjD,EAAsD;AAClD,oBAAI,UAAU,KAAK,YAAL,CAAkB,KAAlB,CAAwB,CAAxB,CAAV,CAD8C;;AAGlD,oBAAI,KAAK,WAAL,CAAiB,UAAjB,CAA4B,OAA5B,MAAyC,MAAM,OAAN,EAAe;AACxD,mCAAe,OAAf,EAAwB,KAAxB,EAA+B,WAA/B,EADwD;AAExD,0BAFwD;iBAA5D;aAHJ;SAHJ;KANmB;;;AAtBQ,UA2C/B,CAAO,gBAAP,GAA0B,UAAU,KAAV,EAAiB;AACvC,oBAAY,gBAAZ,CAA6B,IAA7B,CAAkC,IAAlC,EAAwC,KAAxC,EADuC;;AAGvC,YAAI,mBAAmB,KAAK,WAAL,CAAiB,aAAjB,CAA+B,KAAK,QAAL,CAAlD;YACA,WAAW,iBAAiB,MAAjB,CAJwB;;AAMvC,aAAK,IAAI,IAAI,CAAJ,EAAO,IAAI,QAAJ,EAAc,GAA9B,EAAmC;AAC/B,gBAAI,OAAO,iBAAiB,CAAjB,CAAP,CAD2B;;AAG/B,gBAAI,KAAK,WAAL,CAAiB,kBAAjB,CAAoC,IAApC,CAAJ,EAA+C;AAC3C,qBAAK,UAAL,GAAkB,MAAM,QAAN,CADyB;AAE3C,sBAF2C;aAA/C;SAHJ;KANsB;;;AA3CK,UA4D/B,CAAO,oBAAP,GAA8B,UAAU,OAAV,EAAmB;;;AAG7C,gBAAQ,UAAR,GAAqB,KAAK,yBAAL,IAAkC,IAAlC,CAHwB;AAI7C,aAAK,yBAAL,GAAiC,IAAjC,CAJ6C;AAK7C,oBAAY,oBAAZ,CAAiC,IAAjC,CAAsC,IAAtC,EAA4C,OAA5C,EAL6C;KAAnB,CA5DC;;AAoE/B,WAAO,cAAP,GAAwB,UAAU,KAAV,EAAiB,YAAjB,EAA+B;AACnD,aAAK,yBAAL,GAAiC,MAAM,QAAN,CADkB;AAEnD,oBAAY,cAAZ,CAA2B,IAA3B,CAAgC,IAAhC,EAAsC,KAAtC,EAA6C,YAA7C,EAFmD;KAA/B,CApEO;;AAyE/B,WAAO,cAAP,GAAwB,UAAU,KAAV,EAAiB,YAAjB,EAA+B;AACnD,aAAK,yBAAL,GAAiC,MAAM,QAAN,CADkB;AAEnD,oBAAY,cAAZ,CAA2B,IAA3B,CAAgC,IAAhC,EAAsC,KAAtC,EAA6C,YAA7C,EAFmD;KAA/B,CAzEO;;AA8E/B,WAAO,eAAP,GAAyB,UAAU,KAAV,EAAiB;AACtC,aAAK,yBAAL,GAAiC,MAAM,QAAN,CADK;AAEtC,oBAAY,eAAZ,CAA4B,IAA5B,CAAiC,IAAjC,EAAuC,KAAvC,EAFsC;;AAItC,YAAI,cAAc,KAAK,WAAL,CAAiB,aAAjB,CAA+B,KAAK,YAAL,CAAkB,OAAlB,CAA/B,CAA0D,CAA1D,CAAd,CAJkC;;AAMtC,oBAAY,UAAZ,GAAyB,IAAzB,CANsC;KAAjB,CA9EM;;AAuF/B,WAAO,sBAAP,GAAgC,YAAY;AACxC,oBAAY,sBAAZ,CAAmC,IAAnC,CAAwC,IAAxC,EADwC;AAExC,aAAK,YAAL,CAAkB,OAAlB,CAA0B,UAA1B,GAAuC,IAAvC,CAFwC;KAAZ;;;AAvFD,UA6F/B,CAAO,kBAAP,GAA4B,UAAU,KAAV,EAAiB,MAAjB,EAAyB;AACjD,oBAAY,kBAAZ,CAA+B,IAA/B,CAAoC,IAApC,EAA0C,KAA1C,EAAiD,MAAjD,EADiD;;AAGjD,YAAI,WAAW,KAAK,WAAL,CAAiB,aAAjB,CAA+B,MAA/B,CAAX;YACA,cAAc,SAAS,SAAS,MAAT,GAAkB,CAAlB,CAAvB,CAJ6C;;AAMjD,oBAAY,UAAZ,GAAyB,MAAM,QAAN,CANwB;KAAzB;;;AA7FG,UAuG/B,CAAO,4BAAP,GAAsC,YAAY;;;AAG9C,aAAK,2BAAL,GAAmC,YAAY,4BAAZ,CAAyC,IAAzC,CAA8C,IAA9C,CAAnC,CAH8C;AAI9C,eAAO,KAAK,2BAAL,CAJuC;KAAZ,CAvGP;;AA8G/B,WAAO,iBAAP,GAA2B,UAAU,KAAV,EAAiB;AACxC,oBAAY,iBAAZ,CAA8B,IAA9B,CAAmC,IAAnC,EAAyC,KAAzC,EADwC;;AAGxC,YAAI,kBAAkB,KAAK,8BAAL,EAAlB;YACA,oBAAoB,KAAK,2BAAL;YACpB,SAAS,eAAC,IAAmB,kBAAkB,MAAlB,IACpB,KAAK,YAAL,CAAkB,kBAAlB,IACA,KAAK,YAAL,CAAkB,OAAlB;YACT,WAAW,KAAK,WAAL,CAAiB,aAAjB,CAA+B,MAA/B,CAAX;YACA,cAAc,mBAAmB,kBAAkB,aAAlB,GACnB,SAAS,OAAT,CAAiB,kBAAkB,aAAlB,CAAjB,GAAoD,CAApD,GACA,SAAS,MAAT,GAAkB,CAAlB;YACd,WAAW,SAAS,WAAT,CAAX;;;AAZoC,YAepC,SAAS,UAAT,EACA,SAAS,UAAT,CAAoB,GAApB,GAA0B,MAAM,QAAN,CAAe,GAAf,CAD9B,KAII,SAAS,UAAT,GAAsB,MAAM,QAAN,CAJ1B;KAfuB,CA9GI;CAAlB","file":"location_info_mixin-compiled.js","sourcesContent":["'use strict';\r\n\r\nvar OpenElementStack = require('./open_element_stack'),\r\n    Tokenizer = require('../tokenization/tokenizer'),\r\n    HTML = require('../common/html');\r\n\r\n\r\n//Aliases\r\nvar $ = HTML.TAG_NAMES;\r\n\r\n\r\nfunction setEndLocation(element, closingToken, treeAdapter) {\r\n    var loc = element.__location;\r\n\r\n    if (!loc)\r\n        return;\r\n\r\n    if (!loc.startTag) {\r\n        loc.startTag = {\r\n            start: loc.start,\r\n            end: loc.end\r\n        };\r\n    }\r\n\r\n    if (closingToken.location) {\r\n        var tn = treeAdapter.getTagName(element),\r\n            // NOTE: For cases like <p> <p> </p> - First 'p' closes without a closing tag and\r\n            // for cases like <td> <p> </td> - 'p' closes without a closing tag\r\n            isClosingEndTag = closingToken.type === Tokenizer.END_TAG_TOKEN &&\r\n                              tn === closingToken.tagName;\r\n\r\n        if (isClosingEndTag) {\r\n            loc.endTag = {\r\n                start: closingToken.location.start,\r\n                end: closingToken.location.end\r\n            };\r\n        }\r\n\r\n        loc.end = closingToken.location.end;\r\n    }\r\n}\r\n\r\n//NOTE: patch open elements stack, so we can assign end location for the elements\r\nfunction patchOpenElementsStack(stack, parser) {\r\n    var treeAdapter = parser.treeAdapter;\r\n\r\n    stack.pop = function () {\r\n        setEndLocation(this.current, parser.currentToken, treeAdapter);\r\n        OpenElementStack.prototype.pop.call(this);\r\n    };\r\n\r\n    stack.popAllUpToHtmlElement = function () {\r\n        for (var i = this.stackTop; i > 0; i--)\r\n            setEndLocation(this.items[i], parser.currentToken, treeAdapter);\r\n\r\n        OpenElementStack.prototype.popAllUpToHtmlElement.call(this);\r\n    };\r\n\r\n    stack.remove = function (element) {\r\n        setEndLocation(element, parser.currentToken, treeAdapter);\r\n        OpenElementStack.prototype.remove.call(this, element);\r\n    };\r\n}\r\n\r\nexports.assign = function (parser) {\r\n    //NOTE: obtain Parser proto this way to avoid module circular references\r\n    var parserProto = Object.getPrototypeOf(parser),\r\n        treeAdapter = parser.treeAdapter;\r\n\r\n\r\n    //NOTE: patch _reset method\r\n    parser._reset = function (html, document, fragmentContext) {\r\n        parserProto._reset.call(this, html, document, fragmentContext);\r\n\r\n        this.attachableElementLocation = null;\r\n        this.lastFosterParentingLocation = null;\r\n        this.currentToken = null;\r\n\r\n        patchOpenElementsStack(this.openElements, parser);\r\n    };\r\n\r\n    parser._processTokenInForeignContent = function (token) {\r\n        this.currentToken = token;\r\n        parserProto._processTokenInForeignContent.call(this, token);\r\n    };\r\n\r\n    parser._processToken = function (token) {\r\n        this.currentToken = token;\r\n        parserProto._processToken.call(this, token);\r\n\r\n        //NOTE: <body> and <html> are never popped from the stack, so we need to updated\r\n        //their end location explicitly.\r\n        if (token.type === Tokenizer.END_TAG_TOKEN &&\r\n            (token.tagName === $.HTML ||\r\n            (token.tagName === $.BODY && this.openElements.hasInScope($.BODY)))) {\r\n            for (var i = this.openElements.stackTop; i >= 0; i--) {\r\n                var element = this.openElements.items[i];\r\n\r\n                if (this.treeAdapter.getTagName(element) === token.tagName) {\r\n                    setEndLocation(element, token, treeAdapter);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    //Doctype\r\n    parser._setDocumentType = function (token) {\r\n        parserProto._setDocumentType.call(this, token);\r\n\r\n        var documentChildren = this.treeAdapter.getChildNodes(this.document),\r\n            cnLength = documentChildren.length;\r\n\r\n        for (var i = 0; i < cnLength; i++) {\r\n            var node = documentChildren[i];\r\n\r\n            if (this.treeAdapter.isDocumentTypeNode(node)) {\r\n                node.__location = token.location;\r\n                break;\r\n            }\r\n        }\r\n    };\r\n\r\n    //Elements\r\n    parser._attachElementToTree = function (element) {\r\n        //NOTE: _attachElementToTree is called from _appendElement, _insertElement and _insertTemplate methods.\r\n        //So we will use token location stored in this methods for the element.\r\n        element.__location = this.attachableElementLocation || null;\r\n        this.attachableElementLocation = null;\r\n        parserProto._attachElementToTree.call(this, element);\r\n    };\r\n\r\n    parser._appendElement = function (token, namespaceURI) {\r\n        this.attachableElementLocation = token.location;\r\n        parserProto._appendElement.call(this, token, namespaceURI);\r\n    };\r\n\r\n    parser._insertElement = function (token, namespaceURI) {\r\n        this.attachableElementLocation = token.location;\r\n        parserProto._insertElement.call(this, token, namespaceURI);\r\n    };\r\n\r\n    parser._insertTemplate = function (token) {\r\n        this.attachableElementLocation = token.location;\r\n        parserProto._insertTemplate.call(this, token);\r\n\r\n        var tmplContent = this.treeAdapter.getChildNodes(this.openElements.current)[0];\r\n\r\n        tmplContent.__location = null;\r\n    };\r\n\r\n    parser._insertFakeRootElement = function () {\r\n        parserProto._insertFakeRootElement.call(this);\r\n        this.openElements.current.__location = null;\r\n    };\r\n\r\n    //Comments\r\n    parser._appendCommentNode = function (token, parent) {\r\n        parserProto._appendCommentNode.call(this, token, parent);\r\n\r\n        var children = this.treeAdapter.getChildNodes(parent),\r\n            commentNode = children[children.length - 1];\r\n\r\n        commentNode.__location = token.location;\r\n    };\r\n\r\n    //Text\r\n    parser._findFosterParentingLocation = function () {\r\n        //NOTE: store last foster parenting location, so we will be able to find inserted text\r\n        //in case of foster parenting\r\n        this.lastFosterParentingLocation = parserProto._findFosterParentingLocation.call(this);\r\n        return this.lastFosterParentingLocation;\r\n    };\r\n\r\n    parser._insertCharacters = function (token) {\r\n        parserProto._insertCharacters.call(this, token);\r\n\r\n        var hasFosterParent = this._shouldFosterParentOnInsertion(),\r\n            parentingLocation = this.lastFosterParentingLocation,\r\n            parent = (hasFosterParent && parentingLocation.parent) ||\r\n                     this.openElements.currentTmplContent ||\r\n                     this.openElements.current,\r\n            siblings = this.treeAdapter.getChildNodes(parent),\r\n            textNodeIdx = hasFosterParent && parentingLocation.beforeElement ?\r\n                          siblings.indexOf(parentingLocation.beforeElement) - 1 :\r\n                          siblings.length - 1,\r\n            textNode = siblings[textNodeIdx];\r\n\r\n        //NOTE: if we have location assigned by another token, then just update end position\r\n        if (textNode.__location)\r\n            textNode.__location.end = token.location.end;\r\n\r\n        else\r\n            textNode.__location = token.location;\r\n    };\r\n};\r\n\r\n"]}