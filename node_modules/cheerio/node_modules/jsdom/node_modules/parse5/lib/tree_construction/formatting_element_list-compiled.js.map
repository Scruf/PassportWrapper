{"version":3,"sources":["formatting_element_list.js"],"names":[],"mappings":"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","file":"formatting_element_list-compiled.js","sourcesContent":["'use strict';\r\n\r\n//Const\r\nvar NOAH_ARK_CAPACITY = 3;\r\n\r\n//List of formatting elements\r\nvar FormattingElementList = module.exports = function (treeAdapter) {\r\n    this.length = 0;\r\n    this.entries = [];\r\n    this.treeAdapter = treeAdapter;\r\n    this.bookmark = null;\r\n};\r\n\r\n//Entry types\r\nFormattingElementList.MARKER_ENTRY = 'MARKER_ENTRY';\r\nFormattingElementList.ELEMENT_ENTRY = 'ELEMENT_ENTRY';\r\n\r\n//Noah Ark's condition\r\n//OPTIMIZATION: at first we try to find possible candidates for exclusion using\r\n//lightweight heuristics without thorough attributes check.\r\nFormattingElementList.prototype._getNoahArkConditionCandidates = function (newElement) {\r\n    var candidates = [];\r\n\r\n    if (this.length >= NOAH_ARK_CAPACITY) {\r\n        var neAttrsLength = this.treeAdapter.getAttrList(newElement).length,\r\n            neTagName = this.treeAdapter.getTagName(newElement),\r\n            neNamespaceURI = this.treeAdapter.getNamespaceURI(newElement);\r\n\r\n        for (var i = this.length - 1; i >= 0; i--) {\r\n            var entry = this.entries[i];\r\n\r\n            if (entry.type === FormattingElementList.MARKER_ENTRY)\r\n                break;\r\n\r\n            var element = entry.element,\r\n                elementAttrs = this.treeAdapter.getAttrList(element);\r\n\r\n            if (this.treeAdapter.getTagName(element) === neTagName &&\r\n                this.treeAdapter.getNamespaceURI(element) === neNamespaceURI &&\r\n                elementAttrs.length === neAttrsLength) {\r\n                candidates.push({idx: i, attrs: elementAttrs});\r\n            }\r\n        }\r\n    }\r\n\r\n    return candidates.length < NOAH_ARK_CAPACITY ? [] : candidates;\r\n};\r\n\r\nFormattingElementList.prototype._ensureNoahArkCondition = function (newElement) {\r\n    var candidates = this._getNoahArkConditionCandidates(newElement),\r\n        cLength = candidates.length;\r\n\r\n    if (cLength) {\r\n        var neAttrs = this.treeAdapter.getAttrList(newElement),\r\n            neAttrsLength = neAttrs.length,\r\n            neAttrsMap = {};\r\n\r\n        //NOTE: build attrs map for the new element so we can perform fast lookups\r\n        for (var i = 0; i < neAttrsLength; i++) {\r\n            var neAttr = neAttrs[i];\r\n\r\n            neAttrsMap[neAttr.name] = neAttr.value;\r\n        }\r\n\r\n        for (var i = 0; i < neAttrsLength; i++) {\r\n            for (var j = 0; j < cLength; j++) {\r\n                var cAttr = candidates[j].attrs[i];\r\n\r\n                if (neAttrsMap[cAttr.name] !== cAttr.value) {\r\n                    candidates.splice(j, 1);\r\n                    cLength--;\r\n                }\r\n\r\n                if (candidates.length < NOAH_ARK_CAPACITY)\r\n                    return;\r\n            }\r\n        }\r\n\r\n        //NOTE: remove bottommost candidates until Noah's Ark condition will not be met\r\n        for (var i = cLength - 1; i >= NOAH_ARK_CAPACITY - 1; i--) {\r\n            this.entries.splice(candidates[i].idx, 1);\r\n            this.length--;\r\n        }\r\n    }\r\n};\r\n\r\n//Mutations\r\nFormattingElementList.prototype.insertMarker = function () {\r\n    this.entries.push({type: FormattingElementList.MARKER_ENTRY});\r\n    this.length++;\r\n};\r\n\r\nFormattingElementList.prototype.pushElement = function (element, token) {\r\n    this._ensureNoahArkCondition(element);\r\n\r\n    this.entries.push({\r\n        type: FormattingElementList.ELEMENT_ENTRY,\r\n        element: element,\r\n        token: token\r\n    });\r\n\r\n    this.length++;\r\n};\r\n\r\nFormattingElementList.prototype.insertElementAfterBookmark = function (element, token) {\r\n    var bookmarkIdx = this.length - 1;\r\n\r\n    for (; bookmarkIdx >= 0; bookmarkIdx--) {\r\n        if (this.entries[bookmarkIdx] === this.bookmark)\r\n            break;\r\n    }\r\n\r\n    this.entries.splice(bookmarkIdx + 1, 0, {\r\n        type: FormattingElementList.ELEMENT_ENTRY,\r\n        element: element,\r\n        token: token\r\n    });\r\n\r\n    this.length++;\r\n};\r\n\r\nFormattingElementList.prototype.removeEntry = function (entry) {\r\n    for (var i = this.length - 1; i >= 0; i--) {\r\n        if (this.entries[i] === entry) {\r\n            this.entries.splice(i, 1);\r\n            this.length--;\r\n            break;\r\n        }\r\n    }\r\n};\r\n\r\nFormattingElementList.prototype.clearToLastMarker = function () {\r\n    while (this.length) {\r\n        var entry = this.entries.pop();\r\n\r\n        this.length--;\r\n\r\n        if (entry.type === FormattingElementList.MARKER_ENTRY)\r\n            break;\r\n    }\r\n};\r\n\r\n//Search\r\nFormattingElementList.prototype.getElementEntryInScopeWithTagName = function (tagName) {\r\n    for (var i = this.length - 1; i >= 0; i--) {\r\n        var entry = this.entries[i];\r\n\r\n        if (entry.type === FormattingElementList.MARKER_ENTRY)\r\n            return null;\r\n\r\n        if (this.treeAdapter.getTagName(entry.element) === tagName)\r\n            return entry;\r\n    }\r\n\r\n    return null;\r\n};\r\n\r\nFormattingElementList.prototype.getElementEntry = function (element) {\r\n    for (var i = this.length - 1; i >= 0; i--) {\r\n        var entry = this.entries[i];\r\n\r\n        if (entry.type === FormattingElementList.ELEMENT_ENTRY && entry.element == element)\r\n            return entry;\r\n    }\r\n\r\n    return null;\r\n};\r\n"]}