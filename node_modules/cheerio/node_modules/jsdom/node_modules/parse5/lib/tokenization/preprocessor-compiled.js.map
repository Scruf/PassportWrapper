{"version":3,"sources":["preprocessor.js"],"names":[],"mappings":"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","file":"preprocessor-compiled.js","sourcesContent":["'use strict';\r\n\r\nvar UNICODE = require('../common/unicode');\r\n\r\n//Aliases\r\nvar $ = UNICODE.CODE_POINTS;\r\n\r\n//Utils\r\n\r\n//OPTIMIZATION: these utility functions should not be moved out of this module. V8 Crankshaft will not inline\r\n//this functions if they will be situated in another module due to context switch.\r\n//Always perform inlining check before modifying this functions ('node --trace-inlining').\r\nfunction isReservedCodePoint(cp) {\r\n    return cp >= 0xD800 && cp <= 0xDFFF || cp > 0x10FFFF;\r\n}\r\n\r\nfunction isSurrogatePair(cp1, cp2) {\r\n    return cp1 >= 0xD800 && cp1 <= 0xDBFF && cp2 >= 0xDC00 && cp2 <= 0xDFFF;\r\n}\r\n\r\nfunction getSurrogatePairCodePoint(cp1, cp2) {\r\n    return (cp1 - 0xD800) * 0x400 + 0x2400 + cp2;\r\n}\r\n\r\n//Preprocessor\r\n//NOTE: HTML input preprocessing\r\n//(see: http://www.whatwg.org/specs/web-apps/current-work/multipage/parsing.html#preprocessing-the-input-stream)\r\nvar Preprocessor = module.exports = function (html) {\r\n    this.write(html);\r\n\r\n    //NOTE: one leading U+FEFF BYTE ORDER MARK character must be ignored if any are present in the input stream.\r\n    this.pos = this.html.charCodeAt(0) === $.BOM ? 0 : -1;\r\n\r\n    this.gapStack = [];\r\n    this.lastGapPos = -1;\r\n    this.skipNextNewLine = false;\r\n};\r\n\r\nPreprocessor.prototype.write = function (html) {\r\n    if (this.html) {\r\n        this.html = this.html.substring(0, this.pos + 1) +\r\n                    html +\r\n                    this.html.substring(this.pos + 1, this.html.length);\r\n\r\n    }\r\n    else\r\n        this.html = html;\r\n\r\n\r\n    this.lastCharPos = this.html.length - 1;\r\n};\r\n\r\nPreprocessor.prototype.advanceAndPeekCodePoint = function () {\r\n    this.pos++;\r\n\r\n    if (this.pos > this.lastCharPos)\r\n        return $.EOF;\r\n\r\n    var cp = this.html.charCodeAt(this.pos);\r\n\r\n    //NOTE: any U+000A LINE FEED (LF) characters that immediately follow a U+000D CARRIAGE RETURN (CR) character\r\n    //must be ignored.\r\n    if (this.skipNextNewLine && cp === $.LINE_FEED) {\r\n        this.skipNextNewLine = false;\r\n        this._addGap();\r\n        return this.advanceAndPeekCodePoint();\r\n    }\r\n\r\n    //NOTE: all U+000D CARRIAGE RETURN (CR) characters must be converted to U+000A LINE FEED (LF) characters\r\n    if (cp === $.CARRIAGE_RETURN) {\r\n        this.skipNextNewLine = true;\r\n        return $.LINE_FEED;\r\n    }\r\n\r\n    this.skipNextNewLine = false;\r\n\r\n    //OPTIMIZATION: first perform check if the code point in the allowed range that covers most common\r\n    //HTML input (e.g. ASCII codes) to avoid performance-cost operations for high-range code points.\r\n    return cp >= 0xD800 ? this._processHighRangeCodePoint(cp) : cp;\r\n};\r\n\r\nPreprocessor.prototype._processHighRangeCodePoint = function (cp) {\r\n    //NOTE: try to peek a surrogate pair\r\n    if (this.pos !== this.lastCharPos) {\r\n        var nextCp = this.html.charCodeAt(this.pos + 1);\r\n\r\n        if (isSurrogatePair(cp, nextCp)) {\r\n            //NOTE: we have a surrogate pair. Peek pair character and recalculate code point.\r\n            this.pos++;\r\n            cp = getSurrogatePairCodePoint(cp, nextCp);\r\n\r\n            //NOTE: add gap that should be avoided during retreat\r\n            this._addGap();\r\n        }\r\n    }\r\n\r\n    if (isReservedCodePoint(cp))\r\n        cp = $.REPLACEMENT_CHARACTER;\r\n\r\n    return cp;\r\n};\r\n\r\nPreprocessor.prototype._addGap = function () {\r\n    this.gapStack.push(this.lastGapPos);\r\n    this.lastGapPos = this.pos;\r\n};\r\n\r\nPreprocessor.prototype.retreat = function () {\r\n    if (this.pos === this.lastGapPos) {\r\n        this.lastGapPos = this.gapStack.pop();\r\n        this.pos--;\r\n    }\r\n\r\n    this.pos--;\r\n};\r\n"]}