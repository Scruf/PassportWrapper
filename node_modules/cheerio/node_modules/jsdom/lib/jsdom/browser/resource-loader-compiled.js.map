{"version":3,"sources":["resource-loader.js"],"names":[],"mappings":"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","file":"resource-loader-compiled.js","sourcesContent":["\"use strict\";\n\nconst resolveHref = require(\"../utils\").resolveHref;\nconst parseDataUrl = require(\"../utils\").parseDataUrl;\nconst fs = require(\"fs\");\nconst request = require(\"request\");\nconst documentBaseURL = require(\"../living/helpers/document-base-url\").documentBaseURL;\nconst internalConstants = require(\"../living/helpers/internal-constants\");\nconst NODE_TYPE = require(\"../living/node-type\");\n\n/* eslint-disable no-restricted-modules */\n// TODO: stop using the built-in URL in favor of the spec-compliant whatwg-url package\n// This legacy usage is in the process of being purged.\nconst URL = require(\"url\");\n/* eslint-enable no-restricted-modules */\n\nconst IS_BROWSER = Object.prototype.toString.call(process) !== \"[object process]\";\n\nfunction createResourceLoadHandler(element, resourceUrl, document, loadCallback) {\n  return function (err, data) {\n    const ev = document.createEvent(\"HTMLEvents\");\n\n    if (!err) {\n      try {\n        loadCallback.call(element, data, resourceUrl);\n        ev.initEvent(\"load\", false, false);\n      } catch (e) {\n        err = e;\n      }\n    }\n\n    if (err) {\n      ev.initEvent(\"error\", false, false);\n      ev.error = err;\n\n      const error = new Error(`Could not load ${element.localName}: \"${resourceUrl}\"`);\n      error.detail = err;\n      document._defaultView._virtualConsole.emit(\"jsdomError\", error);\n    }\n\n    element.dispatchEvent(ev);\n  };\n}\n\nexports.readFile = function (filePath, callback) {\n  const readableStream = fs.createReadStream(filePath, { encoding: \"utf8\" });\n\n  let data = \"\";\n\n  readableStream.on(\"error\", callback);\n\n  readableStream.on(\"data\", chunk => {\n    data += chunk;\n  });\n\n  readableStream.on(\"end\", () => {\n    callback(null, data);\n  });\n\n  return {\n    abort() {\n      readableStream.destroy();\n      callback(new Error(\"request canceled by user\"));\n    }\n  };\n};\n\n// NOTE: request wraps tough-cookie cookie jar\n// (see: https://github.com/request/request/blob/master/lib/cookies.js).\n// Therefore, to pass our cookie jar to the request, we need to create\n// request's wrapper and monkey patch it with our jar.\nfunction wrapCookieJarForRequest(cookieJar) {\n  const jarWrapper = request.jar();\n  jarWrapper._jar = cookieJar;\n  return jarWrapper;\n}\n\nfunction fetch(element, urlObj, cookieJar, referrer, pool, agentOptions, userAgent, callback) {\n  let req = null;\n  if (urlObj.protocol === \"data:\") {\n    process.nextTick(() => {\n      try {\n        const buffer = parseDataUrl(urlObj.href).buffer;\n        callback(null, buffer.toString());\n      } catch (err) {\n        callback(err, null);\n      }\n    });\n  } else if (urlObj.hostname) {\n    const requestOptions = {\n      pool,\n      agentOptions,\n      headers: {\n        \"User-Agent\": userAgent\n      }\n    };\n    if (element[internalConstants.accept]) {\n      requestOptions.headers.Accept = element[internalConstants.accept];\n    }\n    req = exports.download(urlObj, requestOptions, cookieJar, referrer, callback);\n  } else {\n    const filePath = urlObj.pathname\n      .replace(/^file:\\/\\//, \"\")\n      .replace(/^\\/([a-z]):\\//i, \"$1:/\")\n      .replace(/%20/g, \" \");\n    req = exports.readFile(filePath, callback);\n  }\n  return req;\n}\n\nexports.enqueue = function (element, resourceUrl, callback) {\n  const document = element.nodeType === NODE_TYPE.DOCUMENT_NODE ? element : element._ownerDocument;\n\n  if (document._queue) {\n    const loadHandler = createResourceLoadHandler(element, resourceUrl || document.URL, document, callback);\n    return document._queue.push(loadHandler);\n  }\n\n  return function () { };\n};\n\nexports.resolveResourceUrl = function (document, url) {\n  // if getAttribute returns null, there is no href\n  // lets resolve to an empty string (nulls are not expected farther up)\n  if (url === null) {\n    return \"\";\n  }\n\n  const baseUrl = documentBaseURL(document);\n  return resolveHref(baseUrl, url);\n};\n\n\nfunction objGetter(obj, prop) {\n  const lprop = prop.toLowerCase();\n  for (const p in obj) {\n    if (obj.hasOwnProperty(p) && lprop === p.toLowerCase()) {\n      return obj[p];\n    }\n  }\n  return null;\n}\n\nexports.download = function (url, options, cookieJar, referrer, callback) {\n  options = options || {};\n  options.gzip = true;\n  options.jar = wrapCookieJarForRequest(cookieJar);\n  options.headers = options.headers || {};\n  if (referrer && !IS_BROWSER) {\n    options.headers.referer = referrer;\n  }\n  if (!objGetter(options.headers, \"Accept\")) {\n    options.headers.Accept = \"*/*\";\n  }\n  if (!objGetter(options.headers, \"Accept-Language\")) {\n    options.headers[\"Accept-Language\"] = \"en\";\n  }\n\n  const req = request(url, options, (error, response, data) => callback(error, data, response));\n  return {\n    abort() {\n      req.abort();\n      callback(new Error(\"request canceled by user\"));\n    }\n  };\n};\n\nexports.load = function (element, url, callback) {\n  const document = element._ownerDocument;\n  const documentImpl = document.implementation;\n\n  if (!documentImpl._hasFeature(\"FetchExternalResources\", element.tagName.toLowerCase())) {\n    return;\n  }\n\n  // if getAttribute returns null, there is no href\n  // lets resolve to an empty string (nulls are not expected farther up)\n  const resourceUrl = exports.resolveResourceUrl(document, url);\n\n  if (documentImpl._hasFeature(\"SkipExternalResources\", resourceUrl)) {\n    return;\n  }\n\n  const urlObj = URL.parse(resourceUrl);\n  const baseUrl = documentBaseURL(document);\n  const cookieJar = document._cookieJar;\n  const enqueued = exports.enqueue(element, resourceUrl, callback);\n  const customLoader = document._customResourceLoader;\n  const requestManager = document[internalConstants.requestManager];\n  const pool = document[internalConstants.pool];\n  const agentOptions = document[internalConstants.agentOptions];\n  const userAgent = document._defaultView.navigator.userAgent;\n  let req = null;\n  function wrappedEnqueued() {\n    if (req && requestManager) {\n      requestManager.remove(req);\n    }\n    // do not trigger if the window is closed\n    if (element._ownerDocument && element._ownerDocument.defaultView.document) {\n      enqueued.apply(this, arguments);\n    }\n  }\n  if (typeof customLoader === \"function\") {\n    req = customLoader({\n      element,\n      url: urlObj,\n      cookie: cookieJar.getCookieStringSync(urlObj, { http: true }),\n      baseUrl,\n      defaultFetch(fetchCallback) {\n        return fetch(element, urlObj, cookieJar, baseUrl, pool, agentOptions, userAgent, fetchCallback);\n      }\n    },\n    wrappedEnqueued);\n  } else {\n    req = fetch(element, urlObj, cookieJar, baseUrl, pool, agentOptions, userAgent, wrappedEnqueued);\n  }\n  if (req && requestManager) {\n    requestManager.add(req);\n  }\n};\n"]}