{"version":3,"sources":["EventTarget-impl.js"],"names":[],"mappings":"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","file":"EventTarget-impl-compiled.js","sourcesContent":["\"use strict\";\nconst DOMException = require(\"../../web-idl/DOMException\");\nconst reportException = require(\"../helpers/runtime-script-errors\");\nconst domSymbolTree = require(\"../helpers/internal-constants\").domSymbolTree;\nconst idlUtils = require(\"../generated/utils\");\n\nconst Event = require(\"../generated/Event\").interface;\n\nclass EventTargetImpl {\n  constructor() {\n    this._eventListeners = Object.create(null);\n  }\n\n  addEventListener(type, callback, capture) {\n    // webidl2js currently can't handle neither optional arguments nor callback interfaces\n    if (callback === undefined || callback === null) {\n      callback = null;\n    } else if (typeof callback === \"object\") {\n      callback = callback.handleEvent;\n    } else if (typeof callback !== \"function\") {\n      throw new TypeError(\"Only undefined, null, an object, or a function are allowed for the callback parameter\");\n    }\n\n    if (callback === null) {\n      return;\n    }\n\n    if (!this._eventListeners[type]) {\n      this._eventListeners[type] = [];\n    }\n\n    for (let i = 0; i < this._eventListeners[type].length; ++i) {\n      const listener = this._eventListeners[type][i];\n      if (listener.capture === capture && listener.callback === callback) {\n        return;\n      }\n    }\n\n    this._eventListeners[type].push({\n      callback,\n      capture\n    });\n  }\n\n  removeEventListener(type, callback, capture) {\n    if (callback === undefined || callback === null) {\n      callback = null;\n    } else if (typeof callback === \"object\") {\n      callback = callback.handleEvent;\n    } else if (typeof callback !== \"function\") {\n      throw new TypeError(\"Only undefined, null, an object, or a function are allowed for the callback parameter\");\n    }\n\n    if (callback === null) {\n      // Optimization, not in the spec.\n      return;\n    }\n\n    if (!this._eventListeners[type]) {\n      return;\n    }\n\n    for (let i = 0; i < this._eventListeners[type].length; ++i) {\n      const listener = this._eventListeners[type][i];\n      if (listener.callback === callback && listener.capture === capture) {\n        this._eventListeners[type].splice(i, 1);\n        break;\n      }\n    }\n  }\n\n  dispatchEvent(event) {\n    if (!(event instanceof Event)) {\n      throw new TypeError(\"Argument to dispatchEvent must be an Event\");\n    }\n\n    const eventImpl = idlUtils.implForWrapper(event);\n    if (eventImpl._dispatchFlag || !eventImpl._initializedFlag) {\n      throw new DOMException(DOMException.INVALID_STATE_ERR, \"Tried to dispatch an uninitialized event\");\n    }\n    if (event.eventPhase !== event.NONE) {\n      throw new DOMException(DOMException.INVALID_STATE_ERR, \"Tried to dispatch a dispatching event\");\n    }\n\n    eventImpl.isTrusted = false;\n\n    return this._dispatch(event);\n  }\n\n  _dispatch(event, targetOverride) {\n    const eventImpl = idlUtils.implForWrapper(event);\n    eventImpl._dispatchFlag = true;\n    eventImpl.target = targetOverride || idlUtils.wrapperForImpl(this);\n\n    const eventPath = [];\n    let targetParent = domSymbolTree.parent(eventImpl.target);\n    let target = eventImpl.target;\n    while (targetParent) {\n      eventPath.push(targetParent);\n      target = targetParent;\n      targetParent = domSymbolTree.parent(targetParent);\n    }\n    if (event.type !== \"load\" && target._defaultView) { // https://html.spec.whatwg.org/#events-and-the-window-object\n      eventPath.push(target._defaultView);\n    }\n\n    eventImpl.eventPhase = Event.CAPTURING_PHASE;\n    for (let i = eventPath.length - 1; i >= 0; --i) {\n      if (eventImpl._stopPropagationFlag) {\n        break;\n      }\n\n      const object = eventPath[i];\n      const objectImpl = idlUtils.implForWrapper(object);\n      const eventListeners = objectImpl._eventListeners[event.type];\n      invokeEventListeners(eventListeners, object, event);\n    }\n\n    eventImpl.eventPhase = Event.AT_TARGET;\n\n    if (!eventImpl._stopPropagationFlag) {\n      invokeInlineListeners(eventImpl.target, event);\n\n      if (this._eventListeners[event.type]) {\n        const eventListeners = this._eventListeners[event.type];\n        invokeEventListeners(eventListeners, eventImpl.target, event);\n      }\n    }\n\n    if (event.bubbles) {\n      eventImpl.eventPhase = Event.BUBBLING_PHASE;\n      for (let i = 0; i < eventPath.length; ++i) {\n        if (eventImpl._stopPropagationFlag) {\n          break;\n        }\n\n        const object = eventPath[i];\n        const objectImpl = idlUtils.implForWrapper(object);\n        const eventListeners = objectImpl._eventListeners[event.type];\n        invokeInlineListeners(object, event);\n        invokeEventListeners(eventListeners, object, event);\n      }\n    }\n\n    eventImpl._dispatchFlag = false;\n    eventImpl.eventPhase = Event.NONE;\n    eventImpl.currentTarget = null;\n    return !eventImpl._canceledFlag;\n  }\n}\n\nmodule.exports = {\n  implementation: EventTargetImpl\n};\n\nfunction invokeInlineListeners(object, event) {\n  const inlineListener = getListenerForInlineEventHandler(object, event.type);\n  if (inlineListener) {\n    const document = object._ownerDocument || object._document;\n\n    // Will be falsy for windows that have closed\n    if (document && (!object.nodeName || document.implementation._hasFeature(\"ProcessExternalResources\", \"script\"))) {\n      invokeEventListeners([{ callback: inlineListener }], object, event);\n    }\n  }\n}\n\nfunction invokeEventListeners(listeners, target, event) {\n  const document = target._ownerDocument || target._document;\n  // Will be falsy for windows that have closed\n  if (!document) {\n    return;\n  }\n\n  const eventImpl = idlUtils.implForWrapper(event);\n  eventImpl.currentTarget = target;\n  if (!listeners) {\n    return;\n  }\n\n  const handlers = listeners.slice();\n  for (let i = 0; i < handlers.length; ++i) {\n    if (eventImpl._stopImmediatePropagationFlag) {\n      return;\n    }\n\n    const listener = handlers[i];\n    if (listeners.indexOf(listener) === -1 ||\n        (event.eventPhase === Event.CAPTURING_PHASE && !listener.capture) ||\n        (event.eventPhase === Event.BUBBLING_PHASE && listener.capture)) {\n      continue;\n    }\n\n    try {\n      listener.callback.call(eventImpl.currentTarget, event);\n    } catch (e) {\n      let window = null;\n      if (target._document) {\n        window = target;\n      } else if (target._ownerDocument) {\n        window = target._ownerDocument._defaultView;\n      }\n\n      if (window) {\n        reportException(window, e);\n      }\n      // Errors in window-less documents just get swallowed... can you think of anything better?\n    }\n  }\n}\n\nconst wrappedListener = Symbol(\"inline event listener wrapper\");\n\nfunction getListenerForInlineEventHandler(target, type) {\n  const callback = target[\"on\" + type];\n\n  if (!callback) { // TODO event handlers: only check null\n    return null;\n  }\n\n  if (!callback[wrappedListener]) {\n    // https://html.spec.whatwg.org/multipage/webappapis.html#the-event-handler-processing-algorithm\n    callback[wrappedListener] = function (E) {\n      const isWindowError = E.constructor.name === \"ErrorEvent\" && type === \"error\"; // TODO branding\n\n      let returnValue;\n      if (isWindowError) {\n        returnValue = callback.call(E.currentTarget, E.message, E.filename, E.lineno, E.colno, E.error);\n      } else {\n        returnValue = callback.call(E.currentTarget, E);\n      }\n\n      if (type === \"mouseover\" || isWindowError) {\n        if (returnValue) {\n          E.preventDefault();\n        }\n      } else if (!returnValue) {\n        E.preventDefault();\n      }\n    };\n  }\n\n  return callback[wrappedListener];\n}\n"]}