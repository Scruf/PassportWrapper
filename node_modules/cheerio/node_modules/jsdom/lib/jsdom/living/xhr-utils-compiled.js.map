{"version":3,"sources":["xhr-utils.js"],"names":[],"mappings":"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","file":"xhr-utils-compiled.js","sourcesContent":["\"use strict\";\n\nconst request = require(\"request\");\nconst EventEmitter = require(\"events\").EventEmitter;\nconst fs = require(\"fs\");\n\nconst utils = require(\"../utils\");\nconst xhrSymbols = require(\"./xmlhttprequest-symbols\");\nconst internalConstants = require(\"./helpers/internal-constants\");\n\nfunction wrapCookieJarForRequest(cookieJar) {\n  const jarWrapper = request.jar();\n  jarWrapper._jar = cookieJar;\n  return jarWrapper;\n}\n\nfunction getRequestHeader(requestHeaders, header) {\n  const keys = Object.keys(requestHeaders);\n  let n = keys.length;\n  while (n--) {\n    const key = keys[n];\n    if (key.toLowerCase() === header.toLowerCase()) {\n      return requestHeaders[key];\n    }\n  }\n  return null;\n}\n\nexports.getRequestHeader = getRequestHeader;\n\n// return a \"request\" client object or an event emitter matching the same behaviour for unsupported protocols\n// the callback should be called with a \"request\" response object or an event emitter matching the same behaviour too\nexports.createClient = function createClient(xhr, callback) {\n  const flag = xhr[xhrSymbols.flag];\n  const urlObj = new utils.URL(flag.uri);\n  const uri = urlObj.href;\n\n  const requestManager = xhr._ownerDocument[internalConstants.requestManager];\n\n  if (urlObj.protocol === \"file:\") {\n    const response = new EventEmitter();\n    response.statusCode = 200;\n    response.rawHeaders = [];\n    response.headers = {};\n    const filePath = urlObj.pathname\n      .replace(/^file:\\/\\//, \"\")\n      .replace(/^\\/([a-z]):\\//i, \"$1:/\")\n      .replace(/%20/g, \" \");\n\n    const client = new EventEmitter();\n\n    const readableStream = fs.createReadStream(filePath, { encoding: \"utf8\" });\n\n    readableStream.on(\"data\", chunk => {\n      response.emit(\"data\", new Buffer(chunk));\n      client.emit(\"data\", new Buffer(chunk));\n    });\n\n    readableStream.on(\"end\", () => {\n      response.emit(\"end\");\n      client.emit(\"end\");\n    });\n\n    readableStream.on(\"error\", err => {\n      response.emit(\"error\", err);\n      client.emit(\"error\", err);\n    });\n\n    client.abort = function () {\n      readableStream.destroy();\n      client.emit(\"abort\");\n    };\n\n    if (requestManager) {\n      const req = {\n        abort() {\n          xhr.abort();\n        }\n      };\n      requestManager.add(req);\n      const rmReq = requestManager.remove.bind(requestManager, req);\n      client.on(\"abort\", rmReq);\n      client.on(\"error\", rmReq);\n      client.on(\"end\", rmReq);\n    }\n\n    process.nextTick(() => callback(null, response));\n\n    return client;\n  }\n\n  if (urlObj.protocol === \"data:\") {\n    const response = new EventEmitter();\n\n    let buffer;\n    if (flag.method === \"GET\") {\n      try {\n        const dataUrlContent = utils.parseDataUrl(decodeURI(uri));\n        buffer = dataUrlContent.buffer;\n        response.statusCode = 200;\n        response.rawHeaders = dataUrlContent.type ? [\"Content-Type\", dataUrlContent.type] : [];\n        response.headers = dataUrlContent.type ? { \"content-type\": dataUrlContent.type } : {};\n      } catch (err) {\n        process.nextTick(() => callback(err, null));\n        return null;\n      }\n    } else {\n      buffer = new Buffer(\"\");\n      response.statusCode = 0;\n      response.rawHeaders = {};\n      response.headers = {};\n    }\n\n    const client = new EventEmitter();\n\n    client.abort = function () {};\n\n    process.nextTick(() => {\n      callback(null, response);\n      process.nextTick(() => {\n        response.emit(\"data\", buffer);\n        client.emit(\"data\", buffer);\n        response.emit(\"end\");\n        client.emit(\"end\");\n      });\n    });\n\n    return client;\n  }\n\n  const requestHeaders = {};\n\n  for (const header in flag.requestHeaders) {\n    requestHeaders[header] = flag.requestHeaders[header];\n  }\n\n  if (!getRequestHeader(flag.requestHeaders, \"Referer\")) {\n    requestHeaders.Referer = flag.baseUrl;\n  }\n  if (!getRequestHeader(flag.requestHeaders, \"User-Agent\")) {\n    requestHeaders[\"User-Agent\"] = flag.userAgent;\n  }\n  if (!getRequestHeader(flag.requestHeaders, \"Accept-Language\")) {\n    requestHeaders[\"Accept-Language\"] = \"en\";\n  }\n  if (!getRequestHeader(flag.requestHeaders, \"Accept\")) {\n    requestHeaders.Accept = \"*/*\";\n  }\n\n  const options = {\n    uri,\n    method: flag.method,\n    headers: requestHeaders,\n    gzip: true,\n    maxRedirects: 21,\n    followAllRedirects: true\n  };\n  if (flag.auth) {\n    options.auth = {\n      user: flag.auth.user || \"\",\n      pass: flag.auth.pass || \"\",\n      sendImmediately: false\n    };\n  }\n  if (xhr._ownerDocument._cookieJar) {\n    options.jar = wrapCookieJarForRequest(xhr._ownerDocument._cookieJar);\n  }\n\n  options.pool = xhr._ownerDocument[internalConstants.pool];\n  options.agentOptions = xhr._ownerDocument[internalConstants.agentOptions];\n\n  const body = flag.body;\n  const hasBody = body !== undefined &&\n    body !== null &&\n    body !== \"\" &&\n    !(flag.method === \"HEAD\" || flag.method === \"GET\");\n\n  if (hasBody && !flag.formData) {\n    options.body = body;\n  }\n\n  try {\n    const client = request(options)\n    .on(\"response\", response => callback(null, response))\n    .on(\"error\", callback);\n\n    if (hasBody && flag.formData) {\n      const form = client.form();\n      for (const entry of body) {\n        form.append(entry.name, entry.value, entry.options);\n      }\n    }\n\n    if (requestManager) {\n      const req = {\n        abort() {\n          xhr.abort();\n        }\n      };\n      requestManager.add(req);\n      const rmReq = requestManager.remove.bind(requestManager, req);\n      client.on(\"abort\", rmReq);\n      client.on(\"error\", rmReq);\n      client.on(\"end\", rmReq);\n    }\n\n    return client;\n  } catch (e) {\n    process.nextTick(() => callback(e));\n    return null;\n  }\n};\n\n"]}