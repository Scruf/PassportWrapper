{"version":3,"sources":["hooks.js"],"names":[],"mappings":"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","file":"hooks-compiled.js","sourcesContent":["// TODO Add in pre and post skipping options\nmodule.exports = {\n  /**\n   *  Declares a new hook to which you can add pres and posts\n   *  @param {String} name of the function\n   *  @param {Function} the method\n   *  @param {Function} the error handler callback\n   */\n  hook: function (name, fn, errorCb) {\n    if (arguments.length === 1 && typeof name === 'object') {\n      for (var k in name) { // `name` is a hash of hookName->hookFn\n        this.hook(k, name[k]);\n      }\n      return;\n    }\n\n    var proto = this.prototype || this\n      , pres = proto._pres = proto._pres || {}\n      , posts = proto._posts = proto._posts || {};\n    pres[name] = pres[name] || [];\n    posts[name] = posts[name] || [];\n\n    proto[name] = function () {\n      var self = this\n        , hookArgs // arguments eventually passed to the hook - are mutable\n        , lastArg = arguments[arguments.length-1]\n        , pres = this._pres[name]\n        , posts = this._posts[name]\n        , _total = pres.length\n        , _current = -1\n        , _asyncsLeft = proto[name].numAsyncPres\n        , _asyncsDone = function(err) {\n            if (err) {\n              return handleError(err);\n            }\n            --_asyncsLeft || _done.apply(self, hookArgs);\n          }\n        , handleError = function(err) {\n            if ('function' == typeof lastArg)\n              return lastArg(err);\n            if (errorCb) return errorCb.call(self, err);\n            throw err;\n          }\n        , _next = function () {\n            if (arguments[0] instanceof Error) {\n              return handleError(arguments[0]);\n            }\n            var _args = Array.prototype.slice.call(arguments)\n              , currPre\n              , preArgs;\n            if (_args.length && !(arguments[0] == null && typeof lastArg === 'function'))\n              hookArgs = _args;\n            if (++_current < _total) {\n              currPre = pres[_current]\n              if (currPre.isAsync && currPre.length < 2)\n                throw new Error(\"Your pre must have next and done arguments -- e.g., function (next, done, ...)\");\n              if (currPre.length < 1)\n                throw new Error(\"Your pre must have a next argument -- e.g., function (next, ...)\");\n              preArgs = (currPre.isAsync\n                          ? [once(_next), once(_asyncsDone)]\n                          : [once(_next)]).concat(hookArgs);\n              return currPre.apply(self, preArgs);\n            } else if (!_asyncsLeft) {\n              return _done.apply(self, hookArgs);\n            }\n          }\n        , _done = function () {\n            var args_ = Array.prototype.slice.call(arguments)\n              , ret, total_, current_, next_, done_, postArgs;\n\n            if (_current === _total) {\n              \n              next_ = function () {\n                if (arguments[0] instanceof Error) {\n                  return handleError(arguments[0]);\n                }\n                var args_ = Array.prototype.slice.call(arguments, 1)\n                  , currPost\n                  , postArgs;\n                if (args_.length) hookArgs = args_;\n                if (++current_ < total_) {\n                  currPost = posts[current_]\n                  if (currPost.length < 1)\n                    throw new Error(\"Your post must have a next argument -- e.g., function (next, ...)\");\n                  postArgs = [once(next_)].concat(hookArgs);\n                  return currPost.apply(self, postArgs);\n                } else if (typeof lastArg === 'function'){\n                  // All post handlers are done, call original callback function\n                  return lastArg.apply(self, arguments);\n                }\n              };\n\n              // We are assuming that if the last argument provided to the wrapped function is a function, it was expecting\n              // a callback.  We trap that callback and wait to call it until all post handlers have finished.\n              if(typeof lastArg === 'function'){\n                args_[args_.length - 1] = once(next_);\n              }\n\n              total_ = posts.length;\n              current_ = -1;\n              ret = fn.apply(self, args_); // Execute wrapped function, post handlers come afterward\n\n              if (total_ && typeof lastArg !== 'function') return next_();  // no callback provided, execute next_() manually\n              return ret;\n            }\n          };\n\n      return _next.apply(this, arguments);\n    };\n    \n    proto[name].numAsyncPres = 0;\n\n    return this;\n  },\n\n  pre: function (name, isAsync, fn, errorCb) {\n    if ('boolean' !== typeof arguments[1]) {\n      errorCb = fn;\n      fn = isAsync;\n      isAsync = false;\n    }\n    var proto = this.prototype || this\n      , pres = proto._pres = proto._pres || {};\n\n    this._lazySetupHooks(proto, name, errorCb);\n\n    if (fn.isAsync = isAsync) {\n      proto[name].numAsyncPres++;\n    }\n\n    (pres[name] = pres[name] || []).push(fn);\n    return this;\n  },\n  post: function (name, isAsync, fn) {\n    if (arguments.length === 2) {\n      fn = isAsync;\n      isAsync = false;\n    }\n    var proto = this.prototype || this\n      , posts = proto._posts = proto._posts || {};\n    \n    this._lazySetupHooks(proto, name);\n    (posts[name] = posts[name] || []).push(fn);\n    return this;\n  },\n  removePre: function (name, fnToRemove) {\n    var proto = this.prototype || this\n      , pres = proto._pres || (proto._pres || {});\n    if (!pres[name]) return this;\n    if (arguments.length === 1) {\n      // Remove all pre callbacks for hook `name`\n      pres[name].length = 0;\n    } else {\n      pres[name] = pres[name].filter( function (currFn) {\n        return currFn !== fnToRemove;\n      });\n    }\n    return this;\n  },\n  removePost: function (name, fnToRemove) {\n    var proto = this.prototype || this\n      , posts = proto._posts || (proto._posts || {});\n    if (!posts[name]) return this;\n    if (arguments.length === 1) {\n      // Remove all post callbacks for hook `name`\n      posts[name].length = 0;\n    } else {\n      posts[name] = posts[name].filter( function (currFn) {\n        return currFn !== fnToRemove;\n      });\n    }\n    return this;\n  },\n  \n  _lazySetupHooks: function (proto, methodName, errorCb) {\n    if ('undefined' === typeof proto[methodName].numAsyncPres) {\n      this.hook(methodName, proto[methodName], errorCb);\n    }\n  }\n};\n\nfunction once (fn, scope) {\n  return function fnWrapper () {\n    if (fnWrapper.hookCalled) return;\n    fnWrapper.hookCalled = true;\n    var ret = fn.apply(scope, arguments);\n    if (ret && ret.then) {\n      ret.then(function() {}, function() {});\n    }\n  };\n}\n"]}