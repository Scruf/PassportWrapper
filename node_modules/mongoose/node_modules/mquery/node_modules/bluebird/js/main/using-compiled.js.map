{"version":3,"sources":["using.js"],"names":[],"mappings":"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","file":"using-compiled.js","sourcesContent":["\"use strict\";\nmodule.exports = function (Promise, apiRejection, tryConvertToPromise,\n    createContext) {\n    var TypeError = require(\"./errors.js\").TypeError;\n    var inherits = require(\"./util.js\").inherits;\n    var PromiseInspection = Promise.PromiseInspection;\n\n    function inspectionMapper(inspections) {\n        var len = inspections.length;\n        for (var i = 0; i < len; ++i) {\n            var inspection = inspections[i];\n            if (inspection.isRejected()) {\n                return Promise.reject(inspection.error());\n            }\n            inspections[i] = inspection._settledValue;\n        }\n        return inspections;\n    }\n\n    function thrower(e) {\n        setTimeout(function(){throw e;}, 0);\n    }\n\n    function castPreservingDisposable(thenable) {\n        var maybePromise = tryConvertToPromise(thenable);\n        if (maybePromise !== thenable &&\n            typeof thenable._isDisposable === \"function\" &&\n            typeof thenable._getDisposer === \"function\" &&\n            thenable._isDisposable()) {\n            maybePromise._setDisposable(thenable._getDisposer());\n        }\n        return maybePromise;\n    }\n    function dispose(resources, inspection) {\n        var i = 0;\n        var len = resources.length;\n        var ret = Promise.defer();\n        function iterator() {\n            if (i >= len) return ret.resolve();\n            var maybePromise = castPreservingDisposable(resources[i++]);\n            if (maybePromise instanceof Promise &&\n                maybePromise._isDisposable()) {\n                try {\n                    maybePromise = tryConvertToPromise(\n                        maybePromise._getDisposer().tryDispose(inspection),\n                        resources.promise);\n                } catch (e) {\n                    return thrower(e);\n                }\n                if (maybePromise instanceof Promise) {\n                    return maybePromise._then(iterator, thrower,\n                                              null, null, null);\n                }\n            }\n            iterator();\n        }\n        iterator();\n        return ret.promise;\n    }\n\n    function disposerSuccess(value) {\n        var inspection = new PromiseInspection();\n        inspection._settledValue = value;\n        inspection._bitField = 268435456;\n        return dispose(this, inspection).thenReturn(value);\n    }\n\n    function disposerFail(reason) {\n        var inspection = new PromiseInspection();\n        inspection._settledValue = reason;\n        inspection._bitField = 134217728;\n        return dispose(this, inspection).thenThrow(reason);\n    }\n\n    function Disposer(data, promise, context) {\n        this._data = data;\n        this._promise = promise;\n        this._context = context;\n    }\n\n    Disposer.prototype.data = function () {\n        return this._data;\n    };\n\n    Disposer.prototype.promise = function () {\n        return this._promise;\n    };\n\n    Disposer.prototype.resource = function () {\n        if (this.promise().isFulfilled()) {\n            return this.promise().value();\n        }\n        return null;\n    };\n\n    Disposer.prototype.tryDispose = function(inspection) {\n        var resource = this.resource();\n        var context = this._context;\n        if (context !== undefined) context._pushContext();\n        var ret = resource !== null\n            ? this.doDispose(resource, inspection) : null;\n        if (context !== undefined) context._popContext();\n        this._promise._unsetDisposable();\n        this._data = null;\n        return ret;\n    };\n\n    Disposer.isDisposer = function (d) {\n        return (d != null &&\n                typeof d.resource === \"function\" &&\n                typeof d.tryDispose === \"function\");\n    };\n\n    function FunctionDisposer(fn, promise, context) {\n        this.constructor$(fn, promise, context);\n    }\n    inherits(FunctionDisposer, Disposer);\n\n    FunctionDisposer.prototype.doDispose = function (resource, inspection) {\n        var fn = this.data();\n        return fn.call(resource, resource, inspection);\n    };\n\n    function maybeUnwrapDisposer(value) {\n        if (Disposer.isDisposer(value)) {\n            this.resources[this.index]._setDisposable(value);\n            return value.promise();\n        }\n        return value;\n    }\n\n    Promise.using = function () {\n        var len = arguments.length;\n        if (len < 2) return apiRejection(\n                        \"you must pass at least 2 arguments to Promise.using\");\n        var fn = arguments[len - 1];\n        if (typeof fn !== \"function\") return apiRejection(\"fn must be a function\\u000a\\u000a    See http://goo.gl/916lJJ\\u000a\");\n\n        var input;\n        var spreadArgs = true;\n        if (len === 2 && Array.isArray(arguments[0])) {\n            input = arguments[0];\n            len = input.length;\n            spreadArgs = false;\n        } else {\n            input = arguments;\n            len--;\n        }\n        var resources = new Array(len);\n        for (var i = 0; i < len; ++i) {\n            var resource = input[i];\n            if (Disposer.isDisposer(resource)) {\n                var disposer = resource;\n                resource = resource.promise();\n                resource._setDisposable(disposer);\n            } else {\n                var maybePromise = tryConvertToPromise(resource);\n                if (maybePromise instanceof Promise) {\n                    resource =\n                        maybePromise._then(maybeUnwrapDisposer, null, null, {\n                            resources: resources,\n                            index: i\n                    }, undefined);\n                }\n            }\n            resources[i] = resource;\n        }\n\n        var promise = Promise.settle(resources)\n            .then(inspectionMapper)\n            .then(function(vals) {\n                promise._pushContext();\n                var ret;\n                try {\n                    ret = spreadArgs\n                        ? fn.apply(undefined, vals) : fn.call(undefined,  vals);\n                } finally {\n                    promise._popContext();\n                }\n                return ret;\n            })\n            ._then(\n                disposerSuccess, disposerFail, undefined, resources, undefined);\n        resources.promise = promise;\n        return promise;\n    };\n\n    Promise.prototype._setDisposable = function (disposer) {\n        this._bitField = this._bitField | 262144;\n        this._disposer = disposer;\n    };\n\n    Promise.prototype._isDisposable = function () {\n        return (this._bitField & 262144) > 0;\n    };\n\n    Promise.prototype._getDisposer = function () {\n        return this._disposer;\n    };\n\n    Promise.prototype._unsetDisposable = function () {\n        this._bitField = this._bitField & (~262144);\n        this._disposer = undefined;\n    };\n\n    Promise.prototype.disposer = function (fn) {\n        if (typeof fn === \"function\") {\n            return new FunctionDisposer(fn, this, createContext());\n        }\n        throw new TypeError();\n    };\n\n};\n"]}