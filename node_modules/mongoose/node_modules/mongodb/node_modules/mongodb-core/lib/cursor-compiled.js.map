{"version":3,"sources":["cursor.js"],"names":[],"mappings":"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","file":"cursor-compiled.js","sourcesContent":["\"use strict\";\n\nvar Long = require('bson').Long\n  , Logger = require('./connection/logger')\n  , MongoError = require('./error')\n  , f = require('util').format;\n\n/**\n * This is a cursor results callback\n *\n * @callback resultCallback\n * @param {error} error An error object. Set to null if no error present\n * @param {object} document\n */\n\n/**\n * @fileOverview The **Cursor** class is an internal class that embodies a cursor on MongoDB\n * allowing for iteration over the results returned from the underlying query.\n *\n * **CURSORS Cannot directly be instantiated**\n * @example\n * var Server = require('mongodb-core').Server\n *   , ReadPreference = require('mongodb-core').ReadPreference\n *   , assert = require('assert');\n *\n * var server = new Server({host: 'localhost', port: 27017});\n * // Wait for the connection event\n * server.on('connect', function(server) {\n *   assert.equal(null, err);\n *\n *   // Execute the write\n *   var cursor = _server.cursor('integration_tests.inserts_example4', {\n *       find: 'integration_tests.example4'\n *     , query: {a:1}\n *   }, {\n *     readPreference: new ReadPreference('secondary');\n *   });\n *\n *   // Get the first document\n *   cursor.next(function(err, doc) {\n *     assert.equal(null, err);\n *     server.destroy();\n *   });\n * });\n *\n * // Start connecting\n * server.connect();\n */\n\n/**\n * Creates a new Cursor, not to be used directly\n * @class\n * @param {object} bson An instance of the BSON parser\n * @param {string} ns The MongoDB fully qualified namespace (ex: db1.collection1)\n * @param {{object}|Long} cmd The selector (can be a command or a cursorId)\n * @param {object} [options=null] Optional settings.\n * @param {object} [options.batchSize=1000] Batchsize for the operation\n * @param {array} [options.documents=[]] Initial documents list for cursor\n * @param {object} [options.transforms=null] Transform methods for the cursor results\n * @param {function} [options.transforms.query] Transform the value returned from the initial query\n * @param {function} [options.transforms.doc] Transform each document returned from Cursor.prototype.next\n * @param {object} topology The server topology instance.\n * @param {object} topologyOptions The server topology options.\n * @return {Cursor} A cursor instance\n * @property {number} cursorBatchSize The current cursorBatchSize for the cursor\n * @property {number} cursorLimit The current cursorLimit for the cursor\n * @property {number} cursorSkip The current cursorSkip for the cursor\n */\nvar Cursor = function(bson, ns, cmd, options, topology, topologyOptions) {\n  options = options || {};\n  // Cursor reference\n  var self = this;\n  // Initial query\n  var query = null;\n\n  // Cursor pool\n  this.pool = null;\n  // Cursor server\n  this.server = null;\n\n  // Do we have a not connected handler\n  this.disconnectHandler = options.disconnectHandler;\n\n  // Set local values\n  this.bson = bson;\n  this.ns = ns;\n  this.cmd = cmd;\n  this.options = options;\n  this.topology = topology;\n\n  // All internal state\n  this.cursorState = {\n      cursorId: null\n    , cmd: cmd\n    , documents: options.documents || []\n    , cursorIndex: 0\n    , dead: false\n    , killed: false\n    , init: false\n    , notified: false\n    , limit: options.limit || cmd.limit || 0\n    , skip: options.skip || cmd.skip || 0\n    , batchSize: options.batchSize || cmd.batchSize || 1000\n    , currentLimit: 0\n    // Result field name if not a cursor (contains the array of results)\n    , transforms: options.transforms\n  }\n\n  // Add promoteLong to cursor state\n  if(typeof topologyOptions.promoteLongs == 'boolean') {\n    this.cursorState.promoteLongs = topologyOptions.promoteLongs;\n  }\n\n  // Callback controller\n  this.callbacks = null;\n\n  // Logger\n  this.logger = Logger('Cursor', options);\n\n  //\n  // Did we pass in a cursor id\n  if(typeof cmd == 'number') {\n    this.cursorState.cursorId = Long.fromNumber(cmd);\n    this.cursorState.lastCursorId = this.cursorState.cursorId;\n  } else if(cmd instanceof Long) {\n    this.cursorState.cursorId = cmd;\n    this.cursorState.lastCursorId = cmd;\n  }\n}\n\nCursor.prototype.setCursorBatchSize = function(value) {\n  this.cursorState.batchSize = value;\n}\n\nCursor.prototype.cursorBatchSize = function() {\n  return this.cursorState.batchSize;\n}\n\nCursor.prototype.setCursorLimit = function(value) {\n  this.cursorState.limit = value;\n}\n\nCursor.prototype.cursorLimit = function() {\n  return this.cursorState.limit;\n}\n\nCursor.prototype.setCursorSkip = function(value) {\n  this.cursorState.skip = value;\n}\n\nCursor.prototype.cursorSkip = function() {\n  return this.cursorState.skip;\n}\n\n//\n// Handle callback (including any exceptions thrown)\nvar handleCallback = function(callback, err, result) {\n  try {\n    callback(err, result);\n  } catch(err) {\n    process.nextTick(function() {\n      throw err;\n    });\n  }\n}\n\n// Internal methods\nCursor.prototype._find = function(callback) {\n  var self = this;\n\n  if(self.logger.isDebug()) {\n    self.logger.debug(f(\"issue initial query [%s] with flags [%s]\"\n      , JSON.stringify(self.cmd)\n      , JSON.stringify(self.query)));\n  }\n\n  var queryCallback = function(err, result) {\n    if(err) return callback(err);\n\n    // Query failure bit set\n    if(result.queryFailure) {\n      return callback(MongoError.create(result.documents[0]), null);\n    }\n\n    // Store the connection for usage with getMore command\n    self.connection = result.connection;\n\n    // Check if we have a command cursor\n    if(Array.isArray(result.documents) && result.documents.length == 1\n      && (!self.cmd.find || (self.cmd.find && self.cmd.virtual == false))\n      && (result.documents[0].cursor != 'string'\n        || result.documents[0]['$err']\n        || result.documents[0]['errmsg']\n        || Array.isArray(result.documents[0].result))\n      ) {\n\n      // We have a an error document return the error\n      if(result.documents[0]['$err']\n        || result.documents[0]['errmsg']) {\n        return callback(MongoError.create(result.documents[0]), null);\n      }\n\n      // We have a cursor document\n      if(result.documents[0].cursor != null\n        && typeof result.documents[0].cursor != 'string') {\n          var id = result.documents[0].cursor.id;\n          // If we have a namespace change set the new namespace for getmores\n          if(result.documents[0].cursor.ns) {\n            self.ns = result.documents[0].cursor.ns;\n          }\n          // Promote id to long if needed\n          self.cursorState.cursorId = typeof id == 'number' ? Long.fromNumber(id) : id;\n          self.cursorState.lastCursorId = self.cursorState.cursorId;\n          // If we have a firstBatch set it\n          if(Array.isArray(result.documents[0].cursor.firstBatch)) {\n            self.cursorState.documents = result.documents[0].cursor.firstBatch;//.reverse();\n          }\n\n          // Return after processing command cursor\n          return callback(null, null);\n      }\n\n      if(Array.isArray(result.documents[0].result)) {\n        self.cursorState.documents = result.documents[0].result;\n        self.cursorState.cursorId = Long.ZERO;\n        return callback(null, null);\n      }\n    }\n\n    // Otherwise fall back to regular find path\n    self.cursorState.cursorId = result.cursorId;\n    self.cursorState.documents = result.documents;\n    self.cursorState.lastCursorId = result.cursorId;\n\n    // Transform the results with passed in transformation method if provided\n    if(self.cursorState.transforms && typeof self.cursorState.transforms.query == 'function') {\n      self.cursorState.documents = self.cursorState.transforms.query(result);\n    }\n\n    // Return callback\n    callback(null, null);\n  }\n\n  // If we have a raw query decorate the function\n  if(self.options.raw || self.cmd.raw) {\n    queryCallback.raw = self.options.raw || self.cmd.raw;\n  }\n\n  // Do we have documentsReturnedIn set on the query\n  if(typeof self.query.documentsReturnedIn == 'string') {\n    queryCallback.documentsReturnedIn = self.query.documentsReturnedIn;\n  }\n\n  // Add promote Long value if defined\n  if(typeof self.cursorState.promoteLongs == 'boolean') {\n    queryCallback.promoteLongs = self.cursorState.promoteLongs;\n  }\n\n  // Set up callback\n  self.callbacks.register(self.query.requestId, queryCallback);\n\n  // Write the initial command out\n  self.pool.write(self.query.toBin(), queryCallback);\n}\n\nCursor.prototype._getmore = function(callback) {\n  if(this.logger.isDebug()) this.logger.debug(f(\"schedule getMore call for query [%s]\", JSON.stringify(this.query)))\n  // Determine if it's a raw query\n  var raw = this.options.raw || this.cmd.raw;\n\n  // Set the current batchSize\n  var batchSize = this.cursorState.batchSize;\n  if(this.cursorState.limit > 0\n    && ((this.cursorState.currentLimit + batchSize) > this.cursorState.limit)) {\n    batchSize = this.cursorState.limit - this.cursorState.currentLimit;\n  }\n\n  // Connection to write too\n  var connection = this.connection || this.pool;\n\n  // We have a wire protocol handler\n  this.server.wireProtocolHandler.getMore(this.bson, this.ns, this.cursorState, batchSize, raw, connection, this.callbacks, this.options, callback);\n}\n\nCursor.prototype._killcursor = function(callback) {\n  // Set cursor to dead\n  this.cursorState.dead = true;\n  this.cursorState.killed = true;\n  // Remove documents\n  this.cursorState.documents = [];\n\n  // If no cursor id just return\n  if(this.cursorState.cursorId == null || this.cursorState.cursorId.isZero() || this.cursorState.init == false) {\n    if(callback) callback(null, null);\n    return;\n  }\n\n  // Execute command\n  this.server.wireProtocolHandler.killCursor(this.bson, this.ns, this.cursorState.cursorId, this.pool, this.callbacks, callback);\n}\n\n/**\n * Clone the cursor\n * @method\n * @return {Cursor}\n */\nCursor.prototype.clone = function() {\n  return this.topology.cursor(this.ns, this.cmd, this.options);\n}\n\n/**\n * Checks if the cursor is dead\n * @method\n * @return {boolean} A boolean signifying if the cursor is dead or not\n */\nCursor.prototype.isDead = function() {\n  return this.cursorState.dead == true;\n}\n\n/**\n * Checks if the cursor was killed by the application\n * @method\n * @return {boolean} A boolean signifying if the cursor was killed by the application\n */\nCursor.prototype.isKilled = function() {\n  return this.cursorState.killed == true;\n}\n\n/**\n * Checks if the cursor notified it's caller about it's death\n * @method\n * @return {boolean} A boolean signifying if the cursor notified the callback\n */\nCursor.prototype.isNotified = function() {\n  return this.cursorState.notified == true;\n}\n\n/**\n * Returns current buffered documents length\n * @method\n * @return {number} The number of items in the buffered documents\n */\nCursor.prototype.bufferedCount = function() {\n  return this.cursorState.documents.length - this.cursorState.cursorIndex;\n}\n\n/**\n * Returns current buffered documents\n * @method\n * @return {Array} An array of buffered documents\n */\nCursor.prototype.readBufferedDocuments = function(number) {\n  var unreadDocumentsLength = this.cursorState.documents.length - this.cursorState.cursorIndex;\n  var length = number < unreadDocumentsLength ? number : unreadDocumentsLength;\n  var elements = this.cursorState.documents.slice(this.cursorState.cursorIndex, this.cursorState.cursorIndex + length);\n\n  // Transform the doc with passed in transformation method if provided\n  if(this.cursorState.transforms && typeof this.cursorState.transforms.doc == 'function') {\n    // Transform all the elements\n    for(var i = 0; i < elements.length; i++) {\n      elements[i] = this.cursorState.transforms.doc(elements[i]);\n    }\n  }\n\n  // Ensure we do not return any more documents than the limit imposed\n  // Just return the number of elements up to the limit\n  if(this.cursorState.limit > 0 && (this.cursorState.currentLimit + elements.length) > this.cursorState.limit) {\n    elements = elements.slice(0, (this.cursorState.limit - this.cursorState.currentLimit));\n    this.kill();\n  }\n\n  // Adjust current limit\n  this.cursorState.currentLimit = this.cursorState.currentLimit + elements.length;\n  this.cursorState.cursorIndex = this.cursorState.cursorIndex + elements.length;\n\n  // Return elements\n  return elements;\n}\n\n/**\n * Kill the cursor\n * @method\n * @param {resultCallback} callback A callback function\n */\nCursor.prototype.kill = function(callback) {\n  this._killcursor(callback);\n}\n\n/**\n * Resets the cursor\n * @method\n * @return {null}\n */\nCursor.prototype.rewind = function() {\n  if(this.cursorState.init) {\n    if(!this.cursorState.dead) {\n      this.kill();\n    }\n\n    this.cursorState.currentLimit = 0;\n    this.cursorState.init = false;\n    this.cursorState.dead = false;\n    this.cursorState.killed = false;\n    this.cursorState.notified = false;\n    this.cursorState.documents = [];\n    this.cursorState.cursorId = null;\n    this.cursorState.cursorIndex = 0;\n  }\n}\n\n/**\n * Validate if the pool is dead and return error\n */\nvar isConnectionDead = function(self, callback) {\n  if(self.pool\n    && !self.pool.isConnected()) {\n    self.cursorState.notified = true;\n    self.cursorState.killed = true;\n    self.cursorState.documents = [];\n    self.cursorState.cursorIndex = 0;\n    callback(MongoError.create(f('connection to host %s:%s was destroyed', self.pool.host, self.pool.port)))\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Validate if the cursor is dead but was not explicitly killed by user\n */\nvar isCursorDeadButNotkilled = function(self, callback) {\n  // Cursor is dead but not marked killed, return null\n  if(self.cursorState.dead && !self.cursorState.killed) {\n    self.cursorState.notified = true;\n    self.cursorState.killed = true;\n    self.cursorState.documents = [];\n    self.cursorState.cursorIndex = 0;\n    handleCallback(callback, null, null);\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Validate if the cursor is dead and was killed by user\n */\nvar isCursorDeadAndKilled = function(self, callback) {\n  if(self.cursorState.dead && self.cursorState.killed) {\n    handleCallback(callback, MongoError.create(\"cursor is dead\"));\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Validate if the cursor was killed by the user\n */\nvar isCursorKilled = function(self, callback) {\n  if(self.cursorState.killed) {\n    self.cursorState.notified = true;\n    self.cursorState.documents = [];\n    self.cursorState.cursorIndex = 0;\n    handleCallback(callback, null, null);\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Mark cursor as being dead and notified\n */\nvar setCursorDeadAndNotified = function(self, callback) {\n  self.cursorState.dead = true;\n  self.cursorState.notified = true;\n  self.cursorState.documents = [];\n  self.cursorState.cursorIndex = 0;\n  handleCallback(callback, null, null);\n}\n\n/**\n * Mark cursor as being notified\n */\nvar setCursorNotified = function(self, callback) {\n  self.cursorState.notified = true;\n  self.cursorState.documents = [];\n  self.cursorState.cursorIndex = 0;\n  handleCallback(callback, null, null);\n}\n\nvar push = Array.prototype.push;\n\nvar nextFunction = function(self, callback) {\n  // We have notified about it\n  if(self.cursorState.notified) {\n    return callback(new Error('cursor is exhausted'));\n  }\n\n  // Cursor is killed return null\n  if(isCursorKilled(self, callback)) return;\n\n  // Cursor is dead but not marked killed, return null\n  if(isCursorDeadButNotkilled(self, callback)) return;\n\n  // We have a dead and killed cursor, attempting to call next should error\n  if(isCursorDeadAndKilled(self, callback)) return;\n\n  // We have just started the cursor\n  if(!self.cursorState.init) {\n    // Topology is not connected, save the call in the provided store to be\n    // Executed at some point when the handler deems it's reconnected\n    if(!self.topology.isConnected(self.options) && self.disconnectHandler != null) {\n      return self.disconnectHandler.addObjectAndMethod('cursor', self, 'next', [callback], callback);\n    }\n\n    try {\n      // Get a server\n      self.server = self.topology.getServer(self.options);\n      // Get a reference to the pool\n      self.pool = self.server.s.pool;\n      // Get the callbacks\n      self.callbacks = self.server.getCallbacks();\n    } catch(err) {\n      // Handle the error and add object to next method call\n      if(self.disconnectHandler != null) {\n        return self.disconnectHandler.addObjectAndMethod('cursor', self, 'next', [callback], callback);\n      }\n\n      // Otherwise return the error\n      return callback(err);\n    }\n\n    // Set as init\n    self.cursorState.init = true;\n\n    try {\n      self.query = self.server.wireProtocolHandler.command(self.bson, self.ns, self.cmd, self.cursorState, self.topology, self.options);\n    } catch(err) {\n      return callback(err);\n    }\n  }\n\n  // If we don't have a cursorId execute the first query\n  if(self.cursorState.cursorId == null) {\n    // Check if pool is dead and return if not possible to\n    // execute the query against the db\n    if(isConnectionDead(self, callback)) return;\n\n    // Check if topology is destroyed\n    if(self.topology.isDestroyed()) return callback(new MongoError(f('connection destroyed, not possible to instantiate cursor')));\n\n    // query, cmd, options, cursorState, callback\n    self._find(function(err, r) {\n      if(err) return handleCallback(callback, err, null);\n\n      if(self.cursorState.documents.length == 0\n        && self.cursorState.cursorId && self.cursorState.cursorId.isZero()\n        && !self.cmd.tailable && !self.cmd.awaitData) {\n        return setCursorNotified(self, callback);\n      }\n\n      nextFunction(self, callback);\n    });\n  } else if(self.cursorState.limit > 0 && self.cursorState.currentLimit >= self.cursorState.limit) {\n    // Ensure we kill the cursor on the server\n    self.kill();\n    // Set cursor in dead and notified state\n    return setCursorDeadAndNotified(self, callback);\n  } else if(self.cursorState.cursorIndex == self.cursorState.documents.length\n      && !Long.ZERO.equals(self.cursorState.cursorId)) {\n      // Ensure an empty cursor state\n      self.cursorState.documents = [];\n      self.cursorState.cursorIndex = 0;\n\n      // Check if topology is destroyed\n      if(self.topology.isDestroyed()) return callback(new MongoError(f('connection destroyed, not possible to instantiate cursor')));\n\n      // Check if connection is dead and return if not possible to\n      // execute a getmore on this connection\n      if(isConnectionDead(self, callback)) return;\n\n      // Execute the next get more\n      self._getmore(function(err, doc, connection) {\n        // General error\n        // if(err && err.code != 43) return handleCallback(callback, err);\n        if(err && err.code != 43) return handleCallback(callback, err);\n        // No cursor found error from mongos\n        if((err && err.code == 43) || (self.cursorState.documents.length == 0\n          && Long.ZERO.equals(self.cursorState.cursorId) && !self.cmd.tailable)) {\n            self.cursorState.dead = true;\n            // Finished iterating over the cursor\n            return setCursorDeadAndNotified(self, callback);\n          }\n\n        // Save the returned connection to ensure all getMore's fire over the same connection\n        self.connection = connection;\n\n        // Tailable cursor getMore result, notify owner about it\n        // No attempt is made here to retry, this is left to the user of the\n        // core module to handle to keep core simple\n        if(self.cursorState.documents.length == 0\n          && self.cmd.tailable && Long.ZERO.equals(self.cursorState.cursorId)) {\n          // No more documents in the tailed cursor\n          return handleCallback(callback, MongoError.create({\n              message: \"No more documents in tailed cursor\"\n            , tailable: self.cmd.tailable\n            , awaitData: self.cmd.awaitData\n          }));\n        } else if(self.cursorState.documents.length == 0\n          && self.cmd.tailable && !Long.ZERO.equals(self.cursorState.cursorId)) {\n          return nextFunction(self, callback);\n        }\n\n        if(self.cursorState.limit > 0 && self.cursorState.currentLimit >= self.cursorState.limit) {\n          return setCursorDeadAndNotified(self, callback);\n        }\n\n        nextFunction(self, callback);\n      });\n  } else if(self.cursorState.documents.length == self.cursorState.cursorIndex\n    && self.cmd.tailable && Long.ZERO.equals(self.cursorState.cursorId)) {\n      return handleCallback(callback, MongoError.create({\n          message: \"No more documents in tailed cursor\"\n        , tailable: self.cmd.tailable\n        , awaitData: self.cmd.awaitData\n      }));\n  } else if(self.cursorState.documents.length == self.cursorState.cursorIndex\n      && Long.ZERO.equals(self.cursorState.cursorId)) {\n      setCursorDeadAndNotified(self, callback);\n  } else {\n    if(self.cursorState.limit > 0 && self.cursorState.currentLimit >= self.cursorState.limit) {\n      // Ensure we kill the cursor on the server\n      self.kill();\n      // Set cursor in dead and notified state\n      return setCursorDeadAndNotified(self, callback);\n    }\n\n    // Increment the current cursor limit\n    self.cursorState.currentLimit += 1;\n\n    // Get the document\n    var doc = self.cursorState.documents[self.cursorState.cursorIndex++];\n\n    // Doc overflow\n    if(doc.$err) {\n      // Ensure we kill the cursor on the server\n      self.kill();\n      // Set cursor in dead and notified state\n      return setCursorDeadAndNotified(self, function() {\n        handleCallback(callback, new MongoError(doc.$err));\n      });\n    }\n\n    // Transform the doc with passed in transformation method if provided\n    if(self.cursorState.transforms && typeof self.cursorState.transforms.doc == 'function') {\n      doc = self.cursorState.transforms.doc(doc);\n    }\n\n    // Return the document\n    handleCallback(callback, null, doc);\n  }\n}\n\n/**\n * Retrieve the next document from the cursor\n * @method\n * @param {resultCallback} callback A callback function\n */\nCursor.prototype.next = function(callback) {\n  nextFunction(this, callback);\n}\n\nmodule.exports = Cursor;\n"]}