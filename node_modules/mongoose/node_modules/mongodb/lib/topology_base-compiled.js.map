{"version":3,"sources":["topology_base.js"],"names":[],"mappings":"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","file":"topology_base-compiled.js","sourcesContent":["\"use strict\";\n\nvar MongoError = require('mongodb-core').MongoError\n  , f = require('util').format;\n\n// The store of ops\nvar Store = function(topology, storeOptions) {\n  var self = this;\n  var storedOps = [];\n  storeOptions = storeOptions || {force:false, bufferMaxEntries: -1}\n\n  // Internal state\n  this.s = {\n      storedOps: storedOps\n    , storeOptions: storeOptions\n    , topology: topology\n  }\n\n  Object.defineProperty(this, 'length', {\n    enumerable:true, get: function() { return self.s.storedOps.length; }\n  });\n}\n\nStore.prototype.add = function(opType, ns, ops, options, callback) {\n  if(this.s.storeOptions.force) {\n    return callback(MongoError.create({message: \"db closed by application\", driver:true}));\n  }\n\n  if(this.s.storeOptions.bufferMaxEntries == 0) {\n    return callback(MongoError.create({message: f(\"no connection available for operation and number of stored operation > %s\", this.s.storeOptions.bufferMaxEntries), driver:true }));\n  }\n\n  if(this.s.storeOptions.bufferMaxEntries > 0 && this.s.storedOps.length > this.s.storeOptions.bufferMaxEntries) {\n    while(this.s.storedOps.length > 0) {\n      var op = this.s.storedOps.shift();\n      op.c(MongoError.create({message: f(\"no connection available for operation and number of stored operation > %s\", this.s.storeOptions.bufferMaxEntries), driver:true }));\n    }\n\n    return;\n  }\n\n  this.s.storedOps.push({t: opType, n: ns, o: ops, op: options, c: callback})\n}\n\nStore.prototype.addObjectAndMethod = function(opType, object, method, params, callback) {\n  if(this.s.storeOptions.force) {\n    return callback(MongoError.create({message: \"db closed by application\", driver:true }));\n  }\n\n  if(this.s.storeOptions.bufferMaxEntries == 0) {\n    return callback(MongoError.create({message: f(\"no connection available for operation and number of stored operation > %s\", this.s.storeOptions.bufferMaxEntries), driver:true }));\n  }\n\n  if(this.s.storeOptions.bufferMaxEntries > 0 && this.s.storedOps.length > this.s.storeOptions.bufferMaxEntries) {\n    while(this.s.storedOps.length > 0) {\n      var op = this.s.storedOps.shift();\n      op.c(MongoError.create({message: f(\"no connection available for operation and number of stored operation > %s\", this.s.storeOptions.bufferMaxEntries), driver:true }));\n    }\n\n    return;\n  }\n\n  this.s.storedOps.push({t: opType, m: method, o: object, p: params, c: callback})\n}\n\nStore.prototype.flush = function() {\n  while(this.s.storedOps.length > 0) {\n    this.s.storedOps.shift().c(MongoError.create({message: f(\"no connection available for operation\"), driver:true }));\n  }\n}\n\nStore.prototype.execute = function() {\n  // Get current ops\n  var ops = this.s.storedOps;\n  // Reset the ops\n  this.s.storedOps = [];\n\n  // Execute all the stored ops\n  while(ops.length > 0) {\n    var op = ops.shift();\n\n    if(op.t == 'cursor') {\n      op.o[op.m].apply(op.o, op.p);\n    } else {\n      this.s.topology[op.t](op.n, op.o, op.op, op.c);\n    }\n  }\n}\n\nStore.prototype.all = function() {\n  return this.s.storedOps;\n}\n\n// Server capabilities\nvar ServerCapabilities = function(ismaster) {\n  var setup_get_property = function(object, name, value) {\n    Object.defineProperty(object, name, {\n        enumerable: true\n      , get: function () { return value; }\n    });\n  }\n\n  // Capabilities\n  var aggregationCursor = false;\n  var writeCommands = false;\n  var textSearch = false;\n  var authCommands = false;\n  var listCollections = false;\n  var listIndexes = false;\n  var maxNumberOfDocsInBatch = ismaster.maxWriteBatchSize || 1000;\n\n  if(ismaster.minWireVersion >= 0) {\n    textSearch = true;\n  }\n\n  if(ismaster.maxWireVersion >= 1) {\n    aggregationCursor = true;\n    authCommands = true;\n  }\n\n  if(ismaster.maxWireVersion >= 2) {\n    writeCommands = true;\n  }\n\n  if(ismaster.maxWireVersion >= 3) {\n    listCollections = true;\n    listIndexes = true;\n  }\n\n  // If no min or max wire version set to 0\n  if(ismaster.minWireVersion == null) {\n    ismaster.minWireVersion = 0;\n  }\n\n  if(ismaster.maxWireVersion == null) {\n    ismaster.maxWireVersion = 0;\n  }\n\n  // Map up read only parameters\n  setup_get_property(this, \"hasAggregationCursor\", aggregationCursor);\n  setup_get_property(this, \"hasWriteCommands\", writeCommands);\n  setup_get_property(this, \"hasTextSearch\", textSearch);\n  setup_get_property(this, \"hasAuthCommands\", authCommands);\n  setup_get_property(this, \"hasListCollectionsCommand\", listCollections);\n  setup_get_property(this, \"hasListIndexesCommand\", listIndexes);\n  setup_get_property(this, \"minWireVersion\", ismaster.minWireVersion);\n  setup_get_property(this, \"maxWireVersion\", ismaster.maxWireVersion);\n  setup_get_property(this, \"maxNumberOfDocsInBatch\", maxNumberOfDocsInBatch);\n}\n\nexports.Store = Store;\nexports.ServerCapabilities = ServerCapabilities;\n"]}