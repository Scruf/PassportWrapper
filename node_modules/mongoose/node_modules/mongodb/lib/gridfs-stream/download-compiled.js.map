{"version":3,"sources":["download.js"],"names":[],"mappings":"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","file":"download-compiled.js","sourcesContent":["var shallowClone = require('../utils').shallowClone;\nvar stream = require('stream');\nvar util = require('util');\n\nmodule.exports = GridFSBucketReadStream;\n\n/**\n * A readable stream that enables you to read buffers from GridFS.\n *\n * Do not instantiate this class directly. Use `openDownloadStream()` instead.\n *\n * @class\n * @param {Collection} chunks Handle for chunks collection\n * @param {Collection} files Handle for files collection\n * @param {Object} readPreference The read preference to use\n * @param {Object} filter The query to use to find the file document\n * @param {Object} [options=null] Optional settings.\n * @param {Number} [options.sort=null] Optional sort for the file find query\n * @param {Number} [options.skip=null] Optional skip for the file find query\n * @param {Number} [options.start=null] Optional 0-based offset in bytes to start streaming from\n * @param {Number} [options.end=null] Optional 0-based offset in bytes to stop streaming before\n * @fires GridFSBucketReadStream#error\n * @fires GridFSBucketReadStream#file\n * @return {GridFSBucketReadStream} a GridFSBucketReadStream instance.\n */\n\nfunction GridFSBucketReadStream(chunks, files, readPreference, filter, options) {\n  var _this = this;\n  this.s = {\n    bytesRead: 0,\n    chunks: chunks,\n    cursor: null,\n    expected: 0,\n    files: files,\n    filter: filter,\n    init: false,\n    expectedEnd: 0,\n    file: null,\n    options: options,\n    readPreference: readPreference\n  };\n\n  stream.Readable.call(this);\n}\n\nutil.inherits(GridFSBucketReadStream, stream.Readable);\n\n/**\n * An error occurred\n *\n * @event GridFSBucketReadStream#error\n * @type {Error}\n */\n\n/**\n * Fires when the stream loaded the file document corresponding to the\n * provided id.\n *\n * @event GridFSBucketReadStream#file\n * @type {object}\n */\n\n/**\n * Emitted when a chunk of data is available to be consumed.\n *\n * @event GridFSBucketReadStream#data\n * @type {object}\n */\n\n/**\n * Fired when the stream is exhausted (no more data events).\n *\n * @event GridFSBucketReadStream#end\n * @type {object}\n */\n\n/**\n * Fired when the stream is exhausted and the underlying cursor is killed\n *\n * @event GridFSBucketReadStream#close\n * @type {object}\n */\n\n/**\n * Reads from the cursor and pushes to the stream.\n * @method\n */\n\nGridFSBucketReadStream.prototype._read = function() {\n  var _this = this;\n  if (this.destroyed) {\n    return;\n  }\n  waitForFile(_this, function() {\n    doRead(_this);\n  });\n};\n\n/**\n * Sets the 0-based offset in bytes to start streaming from. Throws\n * an error if this stream has entered flowing mode\n * (e.g. if you've already called `on('data')`)\n * @method\n * @param {Number} start Offset in bytes to start reading at\n * @return {GridFSBucketReadStream}\n */\n\nGridFSBucketReadStream.prototype.start = function(start) {\n  throwIfInitialized(this);\n  this.s.options.start = start;\n  return this;\n};\n\n/**\n * Sets the 0-based offset in bytes to start streaming from. Throws\n * an error if this stream has entered flowing mode\n * (e.g. if you've already called `on('data')`)\n * @method\n * @param {Number} end Offset in bytes to stop reading at\n * @return {GridFSBucketReadStream}\n */\n\nGridFSBucketReadStream.prototype.end = function(end) {\n  throwIfInitialized(this);\n  this.s.options.end = end;\n  return this;\n};\n\n/**\n * Marks this stream as aborted (will never push another `data` event)\n * and kills the underlying cursor. Will emit the 'end' event, and then\n * the 'close' event once the cursor is successfully killed.\n *\n * @method\n * @param {GridFSBucket~errorCallback} [callback] called when the cursor is successfully closed or an error occurred.\n * @fires GridFSBucketWriteStream#close\n * @fires GridFSBucketWriteStream#end\n */\n\nGridFSBucketReadStream.prototype.abort = function(callback) {\n  var _this = this;\n  this.push(null);\n  this.destroyed = true;\n  if (this.s.cursor) {\n    this.s.cursor.close(function(error) {\n      _this.emit('close');\n      callback && callback(error);\n    });\n  } else {\n    if (!this.s.init) {\n      // If not initialized, fire close event because we will never\n      // get a cursor\n      _this.emit('close');\n    }\n    callback && callback();\n  }\n};\n\n/**\n * @ignore\n */\n\nfunction throwIfInitialized(self) {\n  if (self.s.init) {\n    throw new Error('You cannot change options after the stream has entered' +\n      'flowing mode!');\n  }\n}\n\n/**\n * @ignore\n */\n\nfunction doRead(_this) {\n  if (_this.destroyed) {\n    return;\n  }\n\n  _this.s.cursor.next(function(error, doc) {\n    if (_this.destroyed) {\n      return;\n    }\n    if (error) {\n      return __handleError(_this, error);\n    }\n    if (!doc) {\n      _this.push(null);\n      return _this.s.cursor.close(function(error) {\n        if (error) {\n          return __handleError(_this, error);\n        }\n        _this.emit('close');\n      });\n    }\n\n    var bytesRemaining = _this.s.file.length - _this.s.bytesRead;\n    var expectedN = _this.s.expected++;\n    var expectedLength = Math.min(_this.s.file.chunkSize,\n      bytesRemaining);\n    if (doc.n > expectedN) {\n      var errmsg = 'ChunkIsMissing: Got unexpected n: ' + doc.n +\n        ', expected: ' + expectedN;\n      return __handleError(_this, new Error(errmsg));\n    }\n    if (doc.n < expectedN) {\n      var errmsg = 'ExtraChunk: Got unexpected n: ' + doc.n +\n        ', expected: ' + expectedN;\n      return __handleError(_this, new Error(errmsg));\n    }\n    if (doc.data.length() !== expectedLength) {\n      if (bytesRemaining <= 0) {\n        var errmsg = 'ExtraChunk: Got unexpected n: ' + doc.n;\n        return __handleError(_this, new Error(errmsg));\n      }\n      var errmsg = 'ChunkIsWrongSize: Got unexpected length: ' +\n        doc.data.length() + ', expected: ' + expectedLength;\n      return __handleError(_this, new Error(errmsg));\n    }\n\n    _this.s.bytesRead += doc.data.length();\n\n    if (doc.data.buffer.length === 0) {\n      return _this.push(null);\n    }\n\n    var sliceStart = null;\n    var sliceEnd = null;\n    var buf = doc.data.buffer;\n    if (_this.s.bytesToSkip != null) {\n      sliceStart = _this.s.bytesToSkip;\n      _this.s.bytesToSkip = 0;\n    }\n\n    if (expectedN === _this.s.expectedEnd && _this.s.bytesToTrim != null) {\n      sliceEnd = _this.s.bytesToTrim;\n    }\n\n    if (sliceStart != null || sliceEnd != null) {\n      buf = buf.slice(sliceStart || 0, sliceEnd || buf.length);\n    }\n\n    _this.push(buf);\n  });\n};\n\n/**\n * @ignore\n */\n\nfunction init(self) {\n  var findOneOptions = {};\n  if (self.s.readPreference) {\n    findOneOptions.readPreference = self.s.readPreference;\n  }\n  if (self.s.options && self.s.options.sort) {\n    findOneOptions.sort = self.s.options.sort;\n  }\n  if (self.s.options && self.s.options.skip) {\n    findOneOptions.skip = self.s.options.skip;\n  }\n\n  self.s.files.findOne(self.s.filter, findOneOptions, function(error, doc) {\n    if (error) {\n      return __handleError(self, error);\n    }\n    if (!doc) {\n      var identifier = self.s.filter._id ?\n        self.s.filter._id.toString() : self.s.filter.filename;\n      var errmsg = 'FileNotFound: file ' + identifier + ' was not found';\n      var err = new Error(errmsg);\n      err.code = 'ENOENT';\n      return __handleError(self, err);\n    }\n\n    // If document is empty, kill the stream immediately and don't\n    // execute any reads\n    if (doc.length <= 0) {\n      self.push(null);\n      return;\n    }\n\n    if (self.destroyed) {\n      // If user destroys the stream before we have a cursor, wait\n      // until the query is done to say we're 'closed' because we can't\n      // cancel a query.\n      self.emit('close');\n      return;\n    }\n\n    self.s.cursor = self.s.chunks.find({ files_id: doc._id }).sort({ n: 1 });\n    if (self.s.readPreference) {\n      self.s.cursor.setReadPreference(self.s.readPreference);\n    }\n\n    self.s.expectedEnd = Math.ceil(doc.length / doc.chunkSize);\n    self.s.file = doc;\n    self.s.bytesToSkip = handleStartOption(self, doc, self.s.cursor,\n      self.s.options);\n    self.s.bytesToTrim = handleEndOption(self, doc, self.s.cursor,\n      self.s.options);\n    self.emit('file', doc);\n  });\n}\n\n/**\n * @ignore\n */\n\nfunction waitForFile(_this, callback) {\n  if (_this.s.file) {\n    return callback();\n  }\n\n  if (!_this.s.init) {\n    init(_this);\n    _this.s.init = true;\n  }\n\n  _this.once('file', function() {\n    callback();\n  });\n};\n\n/**\n * @ignore\n */\n\nfunction handleStartOption(stream, doc, cursor, options) {\n  if (options && options.start != null) {\n    if (options.start > doc.length) {\n      throw new Error('Stream start (' + options.start + ') must not be ' +\n        'more than the length of the file (' + doc.length +')')\n    }\n    if (options.start < 0) {\n      throw new Error('Stream start (' + options.start + ') must not be ' +\n        'negative');\n    }\n    if (options.end != null && options.end < options.start) {\n      throw new Error('Stream start (' + options.start + ') must not be ' +\n        'greater than stream end (' + options.end + ')');\n    }\n\n    cursor.skip(Math.floor(options.start / doc.chunkSize));\n\n    stream.s.bytesRead = Math.floor(options.start / doc.chunkSize) *\n      doc.chunkSize;\n    stream.s.expected = Math.floor(options.start / doc.chunkSize);\n\n    return options.start - stream.s.bytesRead;\n  }\n}\n\n/**\n * @ignore\n */\n\nfunction handleEndOption(stream, doc, cursor, options) {\n  if (options && options.end != null) {\n    if (options.end > doc.length) {\n      throw new Error('Stream end (' + options.end + ') must not be ' +\n        'more than the length of the file (' + doc.length +')')\n    }\n    if (options.start < 0) {\n      throw new Error('Stream end (' + options.end + ') must not be ' +\n        'negative');\n    }\n\n    var start = options.start != null ?\n      Math.floor(options.start / doc.chunkSize) :\n      0;\n\n    cursor.limit(Math.ceil(options.end / doc.chunkSize) - start);\n\n    stream.s.expectedEnd = Math.ceil(options.end / doc.chunkSize);\n\n    return (Math.ceil(options.end / doc.chunkSize) * doc.chunkSize) -\n      options.end;\n  }\n}\n\n/**\n * @ignore\n */\n\nfunction __handleError(_this, error) {\n  _this.emit('error', error);\n}\n"]}