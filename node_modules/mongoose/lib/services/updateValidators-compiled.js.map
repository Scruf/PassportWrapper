{"version":3,"sources":["updateValidators.js"],"names":[],"mappings":"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","file":"updateValidators-compiled.js","sourcesContent":["/*!\n * Module dependencies.\n */\n\nvar async = require('async');\nvar ValidationError = require('../error/validation.js');\nvar ObjectId = require('../types/objectid');\n\n/**\n * Applies validators and defaults to update and findOneAndUpdate operations,\n * specifically passing a null doc as `this` to validators and defaults\n *\n * @param {Query} query\n * @param {Schema} schema\n * @param {Object} castedDoc\n * @param {Object} options\n * @method runValidatorsOnUpdate\n * @api private\n */\n\nmodule.exports = function(query, schema, castedDoc, options) {\n  var keys = Object.keys(castedDoc || {});\n  var updatedKeys = {};\n  var updatedValues = {};\n  var numKeys = keys.length;\n  var hasDollarUpdate = false;\n  var modified = {};\n\n  for (var i = 0; i < numKeys; ++i) {\n    if (keys[i].charAt(0) === '$') {\n      modifiedPaths(castedDoc[keys[i]], '', modified);\n      var flat = flatten(castedDoc[keys[i]]);\n      var paths = Object.keys(flat);\n      var numPaths = paths.length;\n      for (var j = 0; j < numPaths; ++j) {\n        var updatedPath = paths[j].replace('.$.', '.0.');\n        updatedPath = updatedPath.replace(/\\.\\$$/, '.0');\n        if (keys[i] === '$set' || keys[i] === '$setOnInsert') {\n          updatedValues[updatedPath] = flat[paths[j]];\n        } else if (keys[i] === '$unset') {\n          updatedValues[updatedPath] = undefined;\n        }\n        updatedKeys[updatedPath] = true;\n      }\n      hasDollarUpdate = true;\n    }\n  }\n\n  if (!hasDollarUpdate) {\n    modifiedPaths(castedDoc, '', modified);\n    updatedValues = flatten(castedDoc);\n    updatedKeys = Object.keys(updatedValues);\n  }\n\n  if (options && options.upsert) {\n    paths = Object.keys(query._conditions);\n    numPaths = keys.length;\n    for (i = 0; i < numPaths; ++i) {\n      var path = paths[i];\n      var condition = query._conditions[path];\n      if (condition && typeof condition === 'object') {\n        var conditionKeys = Object.keys(condition);\n        var numConditionKeys = conditionKeys.length;\n        var hasDollarKey = false;\n        for (j = 0; j < numConditionKeys; ++j) {\n          if (conditionKeys[j].charAt(0) === '$') {\n            hasDollarKey = true;\n            break;\n          }\n        }\n        if (hasDollarKey) {\n          continue;\n        }\n      }\n      updatedKeys[path] = true;\n      modified[path] = true;\n    }\n\n    if (options.setDefaultsOnInsert) {\n      schema.eachPath(function(path, schemaType) {\n        if (path === '_id') {\n          // Ignore _id for now because it causes bugs in 2.4\n          return;\n        }\n        if (schemaType.$isSingleNested) {\n          // Only handle nested schemas 1-level deep to avoid infinite\n          // recursion re: https://github.com/mongodb-js/mongoose-autopopulate/issues/11\n          schemaType.schema.eachPath(function(_path, _schemaType) {\n            if (path === '_id') {\n              // Ignore _id for now because it causes bugs in 2.4\n              return;\n            }\n\n            var def = _schemaType.getDefault(null, true);\n            if (!modified[path + '.' + _path] && typeof def !== 'undefined') {\n              castedDoc.$setOnInsert = castedDoc.$setOnInsert || {};\n              castedDoc.$setOnInsert[path + '.' + _path] = def;\n              updatedValues[path + '.' + _path] = def;\n            }\n          });\n        } else {\n          var def = schemaType.getDefault(null, true);\n          if (!modified[path] && typeof def !== 'undefined') {\n            castedDoc.$setOnInsert = castedDoc.$setOnInsert || {};\n            castedDoc.$setOnInsert[path] = def;\n            updatedValues[path] = def;\n          }\n        }\n      });\n    }\n  }\n\n  var updates = Object.keys(updatedValues);\n  var numUpdates = updates.length;\n  var validatorsToExecute = [];\n  var validationErrors = [];\n  function iter(i) {\n    var schemaPath = schema._getSchema(updates[i]);\n    if (schemaPath) {\n      validatorsToExecute.push(function(callback) {\n        schemaPath.doValidate(\n            updatedValues[updates[i]],\n            function(err) {\n              if (err) {\n                err.path = updates[i];\n                validationErrors.push(err);\n              }\n              callback(null);\n            },\n            options && options.context === 'query' ? query : null,\n            {updateValidator: true});\n      });\n    }\n  }\n  for (i = 0; i < numUpdates; ++i) {\n    iter(i);\n  }\n\n  return function(callback) {\n    async.parallel(validatorsToExecute, function() {\n      if (validationErrors.length) {\n        var err = new ValidationError(null);\n        for (var i = 0; i < validationErrors.length; ++i) {\n          err.errors[validationErrors[i].path] = validationErrors[i];\n        }\n        return callback(err);\n      }\n      callback(null);\n    });\n  };\n};\n\nfunction modifiedPaths(update, path, result) {\n  var keys = Object.keys(update);\n  var numKeys = keys.length;\n  result = result || {};\n  path = path ? path + '.' : '';\n\n  for (var i = 0; i < numKeys; ++i) {\n    var key = keys[i];\n    var val = update[key];\n\n    result[path + key] = true;\n    if (shouldFlatten(val)) {\n      modifiedPaths(val, path + key, result);\n    }\n  }\n\n  return result;\n}\n\nfunction flatten(update, path) {\n  var keys = Object.keys(update);\n  var numKeys = keys.length;\n  var result = {};\n  path = path ? path + '.' : '';\n\n  for (var i = 0; i < numKeys; ++i) {\n    var key = keys[i];\n    var val = update[key];\n    if (shouldFlatten(val)) {\n      var flat = flatten(val, path + key);\n      for (var k in flat) {\n        result[k] = flat[k];\n      }\n      if (Array.isArray(val)) {\n        result[path + key] = val;\n      }\n    } else {\n      result[path + key] = val;\n    }\n  }\n\n  return result;\n}\n\nfunction shouldFlatten(val) {\n  return val &&\n    typeof val === 'object' &&\n    !(val instanceof Date) &&\n    !(val instanceof ObjectId) &&\n    (!Array.isArray(val) || val.length > 0) &&\n    !(val instanceof Buffer);\n}\n"]}