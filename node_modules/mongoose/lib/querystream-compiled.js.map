{"version":3,"sources":["querystream.js"],"names":[],"mappings":"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","file":"querystream-compiled.js","sourcesContent":["/* eslint no-empty: 1 */\n\n/*!\n * Module dependencies.\n */\n\nvar Stream = require('stream').Stream;\nvar utils = require('./utils');\nvar helpers = require('./queryhelpers');\nvar K = function(k) {\n  return k;\n};\n\n/**\n * Provides a Node.js 0.8 style [ReadStream](http://nodejs.org/docs/v0.8.21/api/stream.html#stream_readable_stream) interface for Queries.\n *\n *     var stream = Model.find().stream();\n *\n *     stream.on('data', function (doc) {\n *       // do something with the mongoose document\n *     }).on('error', function (err) {\n *       // handle the error\n *     }).on('close', function () {\n *       // the stream is closed\n *     });\n *\n *\n * The stream interface allows us to simply \"plug-in\" to other _Node.js 0.8_ style write streams.\n *\n *     Model.where('created').gte(twoWeeksAgo).stream().pipe(writeStream);\n *\n * ####Valid options\n *\n *   - `transform`: optional function which accepts a mongoose document. The return value of the function will be emitted on `data`.\n *\n * ####Example\n *\n *     // JSON.stringify all documents before emitting\n *     var stream = Thing.find().stream({ transform: JSON.stringify });\n *     stream.pipe(writeStream);\n *\n * _NOTE: plugging into an HTTP response will *not* work out of the box. Those streams expect only strings or buffers to be emitted, so first formatting our documents as strings/buffers is necessary._\n *\n * _NOTE: these streams are Node.js 0.8 style read streams which differ from Node.js 0.10 style. Node.js 0.10 streams are not well tested yet and are not guaranteed to work._\n *\n * @param {Query} query\n * @param {Object} [options]\n * @inherits NodeJS Stream http://nodejs.org/docs/v0.8.21/api/stream.html#stream_readable_stream\n * @event `data`: emits a single Mongoose document\n * @event `error`: emits when an error occurs during streaming. This will emit _before_ the `close` event.\n * @event `close`: emits when the stream reaches the end of the cursor or an error occurs, or the stream is manually `destroy`ed. After this event, no more events are emitted.\n * @api public\n */\n\nfunction QueryStream(query, options) {\n  Stream.call(this);\n\n  this.query = query;\n  this.readable = true;\n  this.paused = false;\n  this._cursor = null;\n  this._destroyed = null;\n  this._fields = null;\n  this._buffer = null;\n  this._inline = T_INIT;\n  this._running = false;\n  this._transform = options && typeof options.transform === 'function'\n      ? options.transform\n      : K;\n\n  // give time to hook up events\n  var _this = this;\n  process.nextTick(function() {\n    _this._init();\n  });\n}\n\n/*!\n * Inherit from Stream\n */\n\nQueryStream.prototype.__proto__ = Stream.prototype;\n\n/**\n * Flag stating whether or not this stream is readable.\n *\n * @property readable\n * @api public\n */\n\nQueryStream.prototype.readable;\n\n/**\n * Flag stating whether or not this stream is paused.\n *\n * @property paused\n * @api public\n */\n\nQueryStream.prototype.paused;\n\n// trampoline flags\nvar T_INIT = 0;\nvar T_IDLE = 1;\nvar T_CONT = 2;\n\n/**\n * Initializes the query.\n *\n * @api private\n */\n\nQueryStream.prototype._init = function() {\n  if (this._destroyed) {\n    return;\n  }\n\n  var query = this.query,\n      model = query.model,\n      options = query._optionsForExec(model),\n      _this = this;\n\n  try {\n    query.cast(model);\n  } catch (err) {\n    return _this.destroy(err);\n  }\n\n  _this._fields = utils.clone(query._fields);\n  options.fields = query._castFields(_this._fields);\n\n  model.collection.find(query._conditions, options, function(err, cursor) {\n    if (err) {\n      return _this.destroy(err);\n    }\n    _this._cursor = cursor;\n    _this._next();\n  });\n};\n\n/**\n * Trampoline for pulling the next doc from cursor.\n *\n * @see QueryStream#__next #querystream_QueryStream-__next\n * @api private\n */\n\nQueryStream.prototype._next = function _next() {\n  if (this.paused || this._destroyed) {\n    this._running = false;\n    return this._running;\n  }\n\n  this._running = true;\n\n  if (this._buffer && this._buffer.length) {\n    var arg;\n    while (!this.paused && !this._destroyed && (arg = this._buffer.shift())) { // eslint-disable-line no-cond-assign\n      this._onNextObject.apply(this, arg);\n    }\n  }\n\n  // avoid stack overflows with large result sets.\n  // trampoline instead of recursion.\n  while (this.__next()) {\n  }\n};\n\n/**\n * Pulls the next doc from the cursor.\n *\n * @see QueryStream#_next #querystream_QueryStream-_next\n * @api private\n */\n\nQueryStream.prototype.__next = function() {\n  if (this.paused || this._destroyed) {\n    this._running = false;\n    return this._running;\n  }\n\n  var _this = this;\n  _this._inline = T_INIT;\n\n  _this._cursor.nextObject(function cursorcb(err, doc) {\n    _this._onNextObject(err, doc);\n  });\n\n  // if onNextObject() was already called in this tick\n  // return ourselves to the trampoline.\n  if (T_CONT === this._inline) {\n    return true;\n  }\n  // onNextObject() hasn't fired yet. tell onNextObject\n  // that its ok to call _next b/c we are not within\n  // the trampoline anymore.\n  this._inline = T_IDLE;\n};\n\n/**\n * Transforms raw `doc`s returned from the cursor into a model instance.\n *\n * @param {Error|null} err\n * @param {Object} doc\n * @api private\n */\n\nQueryStream.prototype._onNextObject = function _onNextObject(err, doc) {\n  if (this._destroyed) {\n    return;\n  }\n\n  if (this.paused) {\n    this._buffer || (this._buffer = []);\n    this._buffer.push([err, doc]);\n    this._running = false;\n    return this._running;\n  }\n\n  if (err) {\n    return this.destroy(err);\n  }\n\n  // when doc is null we hit the end of the cursor\n  if (!doc) {\n    this.emit('end');\n    return this.destroy();\n  }\n\n  var opts = this.query._mongooseOptions;\n\n  if (!opts.populate) {\n    return opts.lean === true ?\n        emit(this, doc) :\n        createAndEmit(this, null, doc);\n  }\n\n  var _this = this;\n  var pop = helpers.preparePopulationOptionsMQ(_this.query, _this.query._mongooseOptions);\n\n  // Hack to work around gh-3108\n  pop.forEach(function(option) {\n    delete option.model;\n  });\n\n  pop.__noPromise = true;\n  _this.query.model.populate(doc, pop, function(err, doc) {\n    if (err) {\n      return _this.destroy(err);\n    }\n    return opts.lean === true ?\n        emit(_this, doc) :\n        createAndEmit(_this, pop, doc);\n  });\n};\n\nfunction createAndEmit(self, populatedIds, doc) {\n  var instance = helpers.createModel(self.query.model, doc, self._fields);\n  var opts = populatedIds ?\n  {populated: populatedIds} :\n      undefined;\n\n  instance.init(doc, opts, function(err) {\n    if (err) {\n      return self.destroy(err);\n    }\n    emit(self, instance);\n  });\n}\n\n/*!\n * Emit a data event and manage the trampoline state\n */\n\nfunction emit(self, doc) {\n  self.emit('data', self._transform(doc));\n\n  // trampoline management\n  if (T_IDLE === self._inline) {\n    // no longer in trampoline. restart it.\n    self._next();\n  } else {\n    // in a trampoline. tell __next that its\n    // ok to continue jumping.\n    self._inline = T_CONT;\n  }\n}\n\n/**\n * Pauses this stream.\n *\n * @api public\n */\n\nQueryStream.prototype.pause = function() {\n  this.paused = true;\n};\n\n/**\n * Resumes this stream.\n *\n * @api public\n */\n\nQueryStream.prototype.resume = function() {\n  this.paused = false;\n\n  if (!this._cursor) {\n    // cannot start if not initialized\n    return;\n  }\n\n  // are we within the trampoline?\n  if (T_INIT === this._inline) {\n    return;\n  }\n\n  if (!this._running) {\n    // outside QueryStream control, need manual restart\n    return this._next();\n  }\n};\n\n/**\n * Destroys the stream, closing the underlying cursor. No more events will be emitted.\n *\n * @param {Error} [err]\n * @api public\n */\n\nQueryStream.prototype.destroy = function(err) {\n  if (this._destroyed) {\n    return;\n  }\n  this._destroyed = true;\n  this._running = false;\n  this.readable = false;\n\n  if (this._cursor) {\n    this._cursor.close();\n  }\n\n  if (err) {\n    this.emit('error', err);\n  }\n\n  this.emit('close');\n};\n\n/**\n * Pipes this query stream into another stream. This method is inherited from NodeJS Streams.\n *\n * ####Example:\n *\n *     query.stream().pipe(writeStream [, options])\n *\n * @method pipe\n * @memberOf QueryStream\n * @see NodeJS http://nodejs.org/api/stream.html\n * @api public\n */\n\n/*!\n * Module exports\n */\n\nmodule.exports = exports = QueryStream;\n"]}