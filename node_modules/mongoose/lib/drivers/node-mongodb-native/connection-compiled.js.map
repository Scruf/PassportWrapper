{"version":3,"sources":["connection.js"],"names":[],"mappings":"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","file":"connection-compiled.js","sourcesContent":["/*!\n * Module dependencies.\n */\n\nvar MongooseConnection = require('../../connection'),\n    mongo = require('mongodb'),\n    Db = mongo.Db,\n    Server = mongo.Server,\n    Mongos = mongo.Mongos,\n    STATES = require('../../connectionstate'),\n    ReplSetServers = mongo.ReplSet;\n\n/**\n * A [node-mongodb-native](https://github.com/mongodb/node-mongodb-native) connection implementation.\n *\n * @inherits Connection\n * @api private\n */\n\nfunction NativeConnection() {\n  MongooseConnection.apply(this, arguments);\n  this._listening = false;\n}\n\n/**\n * Expose the possible connection states.\n * @api public\n */\n\nNativeConnection.STATES = STATES;\n\n/*!\n * Inherits from Connection.\n */\n\nNativeConnection.prototype.__proto__ = MongooseConnection.prototype;\n\n/**\n * Opens the connection to MongoDB.\n *\n * @param {Function} fn\n * @return {Connection} this\n * @api private\n */\n\nNativeConnection.prototype.doOpen = function(fn) {\n  var server = new Server(this.host, this.port, this.options.server);\n\n  if (this.options && this.options.mongos) {\n    var mongos = new Mongos([server], this.options.mongos);\n    this.db = new Db(this.name, mongos, this.options.db);\n  } else {\n    this.db = new Db(this.name, server, this.options.db);\n  }\n\n  var _this = this;\n  this.db.open(function(err) {\n    listen(_this);\n    if (err) return fn(err);\n    fn();\n  });\n\n  return this;\n};\n\n/**\n * Switches to a different database using the same connection pool.\n *\n * Returns a new connection object, with the new db.\n *\n * @param {String} name The database name\n * @return {Connection} New Connection Object\n * @api public\n */\n\nNativeConnection.prototype.useDb = function(name) {\n  // we have to manually copy all of the attributes...\n  var newConn = new this.constructor();\n  newConn.name = name;\n  newConn.base = this.base;\n  newConn.collections = {};\n  newConn.models = {};\n  newConn.replica = this.replica;\n  newConn.hosts = this.hosts;\n  newConn.host = this.host;\n  newConn.port = this.port;\n  newConn.user = this.user;\n  newConn.pass = this.pass;\n  newConn.options = this.options;\n  newConn._readyState = this._readyState;\n  newConn._closeCalled = this._closeCalled;\n  newConn._hasOpened = this._hasOpened;\n  newConn._listening = false;\n\n  // First, when we create another db object, we are not guaranteed to have a\n  // db object to work with. So, in the case where we have a db object and it\n  // is connected, we can just proceed with setting everything up. However, if\n  // we do not have a db or the state is not connected, then we need to wait on\n  // the 'open' event of the connection before doing the rest of the setup\n  // the 'connected' event is the first time we'll have access to the db object\n\n  var _this = this;\n\n  if (this.db && this._readyState === STATES.connected) {\n    wireup();\n  } else {\n    this.once('connected', wireup);\n  }\n\n  function wireup() {\n    newConn.db = _this.db.db(name);\n    newConn.onOpen();\n    // setup the events appropriately\n    listen(newConn);\n  }\n\n  newConn.name = name;\n\n  // push onto the otherDbs stack, this is used when state changes\n  this.otherDbs.push(newConn);\n  newConn.otherDbs.push(this);\n\n  return newConn;\n};\n\n/*!\n * Register listeners for important events and bubble appropriately.\n */\n\nfunction listen(conn) {\n  if (conn.db._listening) {\n    return;\n  }\n  conn.db._listening = true;\n\n  conn.db.on('close', function() {\n    if (conn._closeCalled) return;\n\n    // the driver never emits an `open` event. auto_reconnect still\n    // emits a `close` event but since we never get another\n    // `open` we can't emit close\n    if (conn.db.serverConfig.autoReconnect) {\n      conn.readyState = STATES.disconnected;\n      conn.emit('close');\n      return;\n    }\n    conn.onClose();\n  });\n  conn.db.on('error', function(err) {\n    conn.emit('error', err);\n  });\n  conn.db.on('reconnect', function() {\n    conn.readyState = STATES.connected;\n    conn.emit('reconnected');\n  });\n  conn.db.on('timeout', function(err) {\n    var error = new Error(err && err.err || 'connection timeout');\n    conn.emit('error', error);\n  });\n  conn.db.on('open', function(err, db) {\n    if (STATES.disconnected === conn.readyState && db && db.databaseName) {\n      conn.readyState = STATES.connected;\n      conn.emit('reconnected');\n    }\n  });\n  conn.db.on('parseError', function(err) {\n    conn.emit('parseError', err);\n  });\n}\n\n/**\n * Opens a connection to a MongoDB ReplicaSet.\n *\n * See description of [doOpen](#NativeConnection-doOpen) for server options. In this case `options.replset` is also passed to ReplSetServers.\n *\n * @param {Function} fn\n * @api private\n * @return {Connection} this\n */\n\nNativeConnection.prototype.doOpenSet = function(fn) {\n  var servers = [],\n      _this = this;\n\n  this.hosts.forEach(function(server) {\n    var host = server.host || server.ipc;\n    var port = server.port || 27017;\n    servers.push(new Server(host, port, _this.options.server));\n  });\n\n  var server = this.options.mongos\n    ? new Mongos(servers, this.options.mongos)\n    : new ReplSetServers(servers, this.options.replset || this.options.replSet);\n  this.db = new Db(this.name, server, this.options.db);\n\n  this.db.on('fullsetup', function() {\n    _this.emit('fullsetup');\n  });\n\n  this.db.on('all', function() {\n    _this.emit('all');\n  });\n\n  this.db.open(function(err) {\n    if (err) return fn(err);\n    fn();\n    listen(_this);\n  });\n\n  return this;\n};\n\n/**\n * Closes the connection\n *\n * @param {Function} fn\n * @return {Connection} this\n * @api private\n */\n\nNativeConnection.prototype.doClose = function(fn) {\n  this.db.close(fn);\n  return this;\n};\n\n/**\n * Prepares default connection options for the node-mongodb-native driver.\n *\n * _NOTE: `passed` options take precedence over connection string options._\n *\n * @param {Object} passed options that were passed directly during connection\n * @param {Object} [connStrOptions] options that were passed in the connection string\n * @api private\n */\n\nNativeConnection.prototype.parseOptions = function(passed, connStrOpts) {\n  var o = passed || {};\n  o.db || (o.db = {});\n  o.auth || (o.auth = {});\n  o.server || (o.server = {});\n  o.replset || (o.replset = o.replSet) || (o.replset = {});\n  o.server.socketOptions || (o.server.socketOptions = {});\n  o.replset.socketOptions || (o.replset.socketOptions = {});\n  (o.mongos === true) && (o.mongos = {});\n\n  var opts = connStrOpts || {};\n  Object.keys(opts).forEach(function(name) {\n    switch (name) {\n      case 'ssl':\n        o.server.ssl = opts.ssl;\n        o.replset.ssl = opts.ssl;\n        o.mongos && (o.mongos.ssl = opts.ssl);\n        break;\n      case 'poolSize':\n        if (typeof o.server[name] === 'undefined') {\n          o.server[name] = o.replset[name] = opts[name];\n        }\n        break;\n      case 'slaveOk':\n        if (typeof o.server.slave_ok === 'undefined') {\n          o.server.slave_ok = opts[name];\n        }\n        break;\n      case 'autoReconnect':\n        if (typeof o.server.auto_reconnect === 'undefined') {\n          o.server.auto_reconnect = opts[name];\n        }\n        break;\n      case 'socketTimeoutMS':\n      case 'connectTimeoutMS':\n        if (typeof o.server.socketOptions[name] === 'undefined') {\n          o.server.socketOptions[name] = o.replset.socketOptions[name] = opts[name];\n        }\n        break;\n      case 'authdb':\n        if (typeof o.auth.authdb === 'undefined') {\n          o.auth.authdb = opts[name];\n        }\n        break;\n      case 'authSource':\n        if (typeof o.auth.authSource === 'undefined') {\n          o.auth.authSource = opts[name];\n        }\n        break;\n      case 'retries':\n      case 'reconnectWait':\n      case 'rs_name':\n        if (typeof o.replset[name] === 'undefined') {\n          o.replset[name] = opts[name];\n        }\n        break;\n      case 'replicaSet':\n        if (typeof o.replset.rs_name === 'undefined') {\n          o.replset.rs_name = opts[name];\n        }\n        break;\n      case 'readSecondary':\n        if (typeof o.replset.read_secondary === 'undefined') {\n          o.replset.read_secondary = opts[name];\n        }\n        break;\n      case 'nativeParser':\n        if (typeof o.db.native_parser === 'undefined') {\n          o.db.native_parser = opts[name];\n        }\n        break;\n      case 'w':\n      case 'safe':\n      case 'fsync':\n      case 'journal':\n      case 'wtimeoutMS':\n        if (typeof o.db[name] === 'undefined') {\n          o.db[name] = opts[name];\n        }\n        break;\n      case 'readPreference':\n        if (typeof o.db.readPreference === 'undefined') {\n          o.db.readPreference = opts[name];\n        }\n        break;\n      case 'readPreferenceTags':\n        if (typeof o.db.read_preference_tags === 'undefined') {\n          o.db.read_preference_tags = opts[name];\n        }\n        break;\n      case 'sslValidate':\n        o.server.sslValidate = opts.sslValidate;\n        o.replset.sslValidate = opts.sslValidate;\n        o.mongos && (o.mongos.sslValidate = opts.sslValidate);\n    }\n  });\n\n  if (!('auto_reconnect' in o.server)) {\n    o.server.auto_reconnect = true;\n  }\n\n  // mongoose creates its own ObjectIds\n  o.db.forceServerObjectId = false;\n\n  // default safe using new nomenclature\n  if (!('journal' in o.db || 'j' in o.db ||\n        'fsync' in o.db || 'safe' in o.db || 'w' in o.db)) {\n    o.db.w = 1;\n  }\n\n  if (o.promiseLibrary) {\n    o.db.promiseLibrary = o.promiseLibrary;\n  }\n\n  validate(o);\n  return o;\n};\n\n/*!\n * Validates the driver db options.\n *\n * @param {Object} o\n */\n\nfunction validate(o) {\n  if (o.db.w === -1 || o.db.w === 0) {\n    if (o.db.journal || o.db.fsync || o.db.safe) {\n      throw new Error(\n          'Invalid writeConcern: '\n        + 'w set to -1 or 0 cannot be combined with safe|fsync|journal');\n    }\n  }\n}\n\n/*!\n * Module exports.\n */\n\nmodule.exports = NativeConnection;\n"]}