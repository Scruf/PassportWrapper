{"version":3,"sources":["collection.js"],"names":[],"mappings":"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","file":"collection-compiled.js","sourcesContent":["/*!\n * Module dependencies.\n */\n\nvar MongooseCollection = require('../../collection'),\n    Collection = require('mongodb').Collection,\n    utils = require('../../utils');\n\n/**\n * A [node-mongodb-native](https://github.com/mongodb/node-mongodb-native) collection implementation.\n *\n * All methods methods from the [node-mongodb-native](https://github.com/mongodb/node-mongodb-native) driver are copied and wrapped in queue management.\n *\n * @inherits Collection\n * @api private\n */\n\nfunction NativeCollection() {\n  this.collection = null;\n  MongooseCollection.apply(this, arguments);\n}\n\n/*!\n * Inherit from abstract Collection.\n */\n\nNativeCollection.prototype.__proto__ = MongooseCollection.prototype;\n\n/**\n * Called when the connection opens.\n *\n * @api private\n */\n\nNativeCollection.prototype.onOpen = function() {\n  var _this = this;\n\n  // always get a new collection in case the user changed host:port\n  // of parent db instance when re-opening the connection.\n\n  if (!_this.opts.capped.size) {\n    // non-capped\n    return _this.conn.db.collection(_this.name, callback);\n  }\n\n  // capped\n  return _this.conn.db.collection(_this.name, function(err, c) {\n    if (err) return callback(err);\n\n    // discover if this collection exists and if it is capped\n    _this.conn.db.listCollections({name: _this.name}).toArray(function(err, docs) {\n      if (err) {\n        return callback(err);\n      }\n      var doc = docs[0];\n      var exists = !!doc;\n\n      if (exists) {\n        if (doc.options && doc.options.capped) {\n          callback(null, c);\n        } else {\n          var msg = 'A non-capped collection exists with the name: ' + _this.name + '\\n\\n'\n              + ' To use this collection as a capped collection, please '\n              + 'first convert it.\\n'\n              + ' http://www.mongodb.org/display/DOCS/Capped+Collections#CappedCollections-Convertingacollectiontocapped';\n          err = new Error(msg);\n          callback(err);\n        }\n      } else {\n        // create\n        var opts = utils.clone(_this.opts.capped);\n        opts.capped = true;\n        _this.conn.db.createCollection(_this.name, opts, callback);\n      }\n    });\n  });\n\n  function callback(err, collection) {\n    if (err) {\n      // likely a strict mode error\n      _this.conn.emit('error', err);\n    } else {\n      _this.collection = collection;\n      MongooseCollection.prototype.onOpen.call(_this);\n    }\n  }\n};\n\n/**\n * Called when the connection closes\n *\n * @api private\n */\n\nNativeCollection.prototype.onClose = function() {\n  MongooseCollection.prototype.onClose.call(this);\n};\n\n/*!\n * Copy the collection methods and make them subject to queues\n */\n\nfunction iter(i) {\n  NativeCollection.prototype[i] = function() {\n    if (this.buffer) {\n      this.addQueue(i, arguments);\n      return;\n    }\n\n    var collection = this.collection,\n        args = arguments,\n        _this = this,\n        debug = _this.conn.base.options.debug;\n\n    if (debug) {\n      if (typeof debug === 'function') {\n        debug.apply(debug\n            , [_this.name, i].concat(utils.args(args, 0, args.length - 1)));\n      } else {\n        this.$print(_this.name, i, args);\n      }\n    }\n\n    try {\n      return collection[i].apply(collection, args);\n    } catch (error) {\n      // Collection operation may throw because of max bson size, catch it here\n      // See gh-3906\n      if (args.length > 0 &&\n          typeof args[args.length - 1] === 'function') {\n        args[args.length - 1](error);\n      } else {\n        throw error;\n      }\n    }\n  };\n}\n\nfor (var i in Collection.prototype) {\n  // Janky hack to work around gh-3005 until we can get rid of the mongoose\n  // collection abstraction\n  try {\n    if (typeof Collection.prototype[i] !== 'function') {\n      continue;\n    }\n  } catch (e) {\n    continue;\n  }\n\n  iter(i);\n}\n\n/**\n * Debug print helper\n *\n * @api public\n * @method $print\n */\n\nNativeCollection.prototype.$print = function(name, i, args) {\n  console.error(\n      '\\x1B[0;36mMongoose:\\x1B[0m %s.%s(%s) %s %s %s',\n      name,\n      i,\n      this.$format(args[0]),\n      this.$format(args[1]),\n      this.$format(args[2]),\n      this.$format(args[3]));\n};\n\n/**\n * Formatter for debug print args\n *\n * @api public\n * @method $format\n */\n\nNativeCollection.prototype.$format = function(arg) {\n  var type = typeof arg;\n  if (type === 'function' || type === 'undefined') return '';\n  return format(arg);\n};\n\n/*!\n * Debug print helper\n */\n\nfunction map(o) {\n  return format(o, true);\n}\nfunction formatObjectId(x, key) {\n  var representation = 'ObjectId(\"' + x[key].toHexString() + '\")';\n  x[key] = {inspect: function() { return representation; }};\n}\nfunction formatDate(x, key) {\n  var representation = 'new Date(\"' + x[key].toUTCString() + '\")';\n  x[key] = {inspect: function() { return representation; }};\n}\nfunction format(obj, sub) {\n  var x = utils.clone(obj, {retainKeyOrder: 1});\n  var representation;\n\n  if (x != null) {\n    if (x.constructor.name === 'Binary') {\n      x = '[object Buffer]';\n    } else if (x.constructor.name === 'ObjectID') {\n      representation = 'ObjectId(\"' + x.toHexString() + '\")';\n      x = {inspect: function() { return representation; }};\n    } else if (x.constructor.name === 'Date') {\n      representation = 'new Date(\"' + x.toUTCString() + '\")';\n      x = {inspect: function() { return representation; }};\n    } else if (x.constructor.name === 'Object') {\n      var keys = Object.keys(x);\n      var numKeys = keys.length;\n      var key;\n      for (var i = 0; i < numKeys; ++i) {\n        key = keys[i];\n        if (x[key]) {\n          if (x[key].constructor.name === 'Binary') {\n            x[key] = '[object Buffer]';\n          } else if (x[key].constructor.name === 'Object') {\n            x[key] = format(x[key], true);\n          } else if (x[key].constructor.name === 'ObjectID') {\n            formatObjectId(x, key);\n          } else if (x[key].constructor.name === 'Date') {\n            formatDate(x, key);\n          } else if (Array.isArray(x[key])) {\n            x[key] = x[key].map(map);\n          }\n        }\n      }\n    }\n    if (sub) return x;\n  }\n\n  return require('util')\n  .inspect(x, false, 10, true)\n  .replace(/\\n/g, '')\n  .replace(/\\s{2,}/g, ' ');\n}\n\n/**\n * Retreives information about this collections indexes.\n *\n * @param {Function} callback\n * @method getIndexes\n * @api public\n */\n\nNativeCollection.prototype.getIndexes = NativeCollection.prototype.indexInformation;\n\n/*!\n * Module exports.\n */\n\nmodule.exports = NativeCollection;\n"]}